<?php

  global $user;

  if( $user->place_type == 1 && isset( $_GET['x'] ) && isset( $_GET['y'] ) && $_GET['x'] >= 0 && $_GET['y'] >= 0 ) {
    $out = '';
    $planet_id = $user->place_id;
    $x = $_GET['x'];
    $y = $_GET['y'];

    $maps = db_fetch_row( "SELECT bld, top, fnd FROM planets_maps WHERE id = $planet_id" );

    $found = array_map( 'trim', explode( "\n", trim( $maps['fnd'] ) ) );
    $content = array_map( 'trim', explode( "\n", trim( $maps['top'] ) ) );
    $buildings = array_map( 'trim', explode( "\n", trim( $maps['bld'] ) ) );

    if( !isset( $content[ $y ]{$x} ) || !isset( $buildings[ $y ]{$x} ) || !isset( $found[ $y ]{$x} ) ) {
      $out = 'err=-1';
      printOut( $out );
      return;
    }

    $bq = false;
    if( $user->iq ) {
      if( $user->qt >= 19 && $user->qt <= 27 ) {
        $bq = true;
        $bt = db_fetch_val( "SELECT arg3 FROM users_quests WHERE id = ".$user->iq, 'arg3' );
      }

      if( $user->qt >= 28 && $user->qt <= 29 ) {
        $bq = true;
        $bt = 0;
      }
    }

    db_query( "UPDATE LOW_PRIORITY planets_active SET last_pos='$x:$y' WHERE id=$planet_id" );

    $def = db_fetch_row( "SELECT IFNULL( MAX( d.status ), 0 ) status, u.login
                            FROM defence d
                      INNER JOIN users u ON u.id = d.user_id
                           WHERE d.place_type = 1 AND d.place_id = $planet_id AND d.user_id != ".$user->uid );

    $defender = true;
    if( $def['status'] == 0 ) {
      $def_planet = db_fetch_row( "SELECT p.planet_user, UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(p.planet_time) planet_time, u.login
                             FROM planets p
                       INNER JOIN users u ON u.id = p.planet_user
                            WHERE p.id = ".$user->place_id );

      if( $def_planet['planet_user'] != '' && $def_planet['planet_user'] != $user->uid ) {
        if( $def_planet['planet_time'] < 259200 ) {
          $defender = false;
          $def['login'] = $def_planet['login'];
        }
      }
    }

    $type = db_fetch_val( "SELECT type FROM planets WHERE id = ".$user->place_id, 'type' );
    $info = get_planet_info( $x, $y );

    if( !$bq ) {
      if( $type != 5 ) {
        switch( $buildings[ $y ]{$x} ) {
          case 'B':
            $out = "detail=Ведется стройка или разработка&btLabel=Остановить строительство&btOnClick=page.php?id=277%26x=$x%26y=$y";
    
              if( $info->busy_type == 1 ) {
                $obj = db_fetch_row( "SELECT o.id, o.name FROM planet_events pe, objects o WHERE pe.id = {$info->busy_id} AND pe.object_id = o.id" );
                if( $obj['id'] == 2000 ) {
                  if( $found[ $y ]{$x} == 0 ) {
                    $out = "detail=Разрабатывается средний слой&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
                  } else {
                    $out = "detail=Разрабатывается глубинный слой&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
                  }
                } else {
                  $out = "detail=Строится {$obj['name']}&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
                }
              }
            break;
    
          case 'D':
            $out = "detail=<u><a href='page.php?id=6%26itm=Ракетная защита'>Ракетная защита</a></u>";
            if( $def['status'] == 0 && $defender ) {
              $out .= "&cb_h=Настройки защиты планеты";
              $defence = db_fetch_val( "SELECT MAX( status ) status FROM defence WHERE place_id = $planet_id AND place_type = 1", 'status' );
              if( $user->aliance == 0 ) {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=4&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 2 :
                    $out .= "&cb_c=4&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 3 :
                    $out .= "&cb_c=4&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=4&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                }
              } else {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=5&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 2 :
                    $out .= "&cb_c=5&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 3 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 4 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не альянс&cb_d0=page.php?id=282%26rf=4&cb_l1=Атаковать не друзей&cb_d1=page.php?id=282%26rf=3&cb_l2=Можно всем&cb_d2=page.php?id=282%26rf=0&cb_l3=Атаковать всех&cb_d3=page.php?id=282%26rf=1&cb_l4=Атаковать врагов&cb_d4=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=5&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                }
              }
            } else {
              $out .= "&cb_h=Управление заблокированно ".$def['login'];
            }
            break;
    
          case 'H':
            $out = "detail=<u><a href='page.php?id=6%26itm=Лазерная защита'>Лазерная защита</a></u>";
            if( $def['status'] == 0 && $defender ) {
              $out .= "&cb_h=Настройки защиты планеты";
              $defence = db_fetch_val( "SELECT MAX( status ) status FROM defence WHERE place_id = $planet_id AND place_type = 1", 'status' );
              if( $user->aliance == 0 ) {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=4&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 2 :
                    $out .= "&cb_c=4&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 3 :
                    $out .= "&cb_c=4&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=4&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                }
              } else {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=5&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 2 :
                    $out .= "&cb_c=5&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 3 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 4 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не альянс&cb_d0=page.php?id=282%26rf=4&cb_l1=Атаковать не друзей&cb_d1=page.php?id=282%26rf=3&cb_l2=Можно всем&cb_d2=page.php?id=282%26rf=0&cb_l3=Атаковать всех&cb_d3=page.php?id=282%26rf=1&cb_l4=Атаковать врагов&cb_d4=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=5&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                }
              }
            } else {
              $out .= "&cb_h=Управление заблокированно ".$def['login'];
            }
            break;
    
          case 'J':
            $out = "detail=<u><a href='page.php?id=6%26itm=Плазменная защита'>Плазменная защита</a></u>";
            if( $def['status'] == 0 && $defender ) {
              $out .= "&cb_h=Настройки защиты планеты";
              $defence = db_fetch_val( "SELECT MAX( status ) status FROM defence WHERE place_id = $planet_id AND place_type = 1", 'status' );
              if( $user->aliance == 0 ) {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=4&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 2 :
                    $out .= "&cb_c=4&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 3 :
                    $out .= "&cb_c=4&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=4&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                }
              } else {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=5&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 2 :
                    $out .= "&cb_c=5&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 3 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 4 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не альянс&cb_d0=page.php?id=282%26rf=4&cb_l1=Атаковать не друзей&cb_d1=page.php?id=282%26rf=3&cb_l2=Можно всем&cb_d2=page.php?id=282%26rf=0&cb_l3=Атаковать всех&cb_d3=page.php?id=282%26rf=1&cb_l4=Атаковать врагов&cb_d4=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=5&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                }
              }
            } else {
              $out .= "&cb_h=Управление заблокированно ".$def['login'];
            }
            break;
    
          case 'N':
            $out = "detail=<u><a href='page.php?id=6%26itm=Коротковолновый мазер'>Коротковолновый мазер</a></u>";
            if( $def['status'] == 0 && $defender ) {
              $out .= "&cb_h=Настройки защиты планеты";
              $defence = db_fetch_val( "SELECT MAX( status ) status FROM defence WHERE place_id = $planet_id AND place_type = 1", 'status' );
              if( $user->aliance == 0 ) {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=4&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 2 :
                    $out .= "&cb_c=4&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 3 :
                    $out .= "&cb_c=4&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=4&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                }
              } else {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=5&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 2 :
                    $out .= "&cb_c=5&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 3 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 4 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не альянс&cb_d0=page.php?id=282%26rf=4&cb_l1=Атаковать не друзей&cb_d1=page.php?id=282%26rf=3&cb_l2=Можно всем&cb_d2=page.php?id=282%26rf=0&cb_l3=Атаковать всех&cb_d3=page.php?id=282%26rf=1&cb_l4=Атаковать врагов&cb_d4=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=5&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                }
              }
            } else {
              $out .= "&cb_h=Управление заблокированно ".$def['login'];
            }
            break;
    
          case 'U':
            $out = "detail=<u><a href='page.php?id=6%26itm=Планетарный щит'>Планетарный щит</a></u>";
            if( $def['status'] == 0 && $defender ) {
              $out .= "&cb_h=Настройки защиты планеты";
              $defence = db_fetch_val( "SELECT MAX( status ) status FROM defence WHERE place_id = $planet_id AND place_type = 1", 'status' );
              if( $user->aliance == 0 ) {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=4&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 2 :
                    $out .= "&cb_c=4&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                  case 3 :
                    $out .= "&cb_c=4&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=4&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3";
                    break;
                }
              } else {
                switch( $defence ) {
                  case 1 :
                    $out .= "&cb_c=5&cb_l0=Атаковать всех&cb_d0=page.php?id=282%26rf=1&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 2 :
                    $out .= "&cb_c=5&cb_l0=Атаковать врагов&cb_d0=page.php?id=282%26rf=2&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 3 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не друзей&cb_d0=page.php?id=282%26rf=3&cb_l1=Можно всем&cb_d1=page.php?id=282%26rf=0&cb_l2=Атаковать всех&cb_d2=page.php?id=282%26rf=1&cb_l3=Атаковать врагов&cb_d3=page.php?id=282%26rf=2&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                  case 4 :
                    $out .= "&cb_c=5&cb_l0=Атаковать не альянс&cb_d0=page.php?id=282%26rf=4&cb_l1=Атаковать не друзей&cb_d1=page.php?id=282%26rf=3&cb_l2=Можно всем&cb_d2=page.php?id=282%26rf=0&cb_l3=Атаковать всех&cb_d3=page.php?id=282%26rf=1&cb_l4=Атаковать врагов&cb_d4=page.php?id=282%26rf=2";
                    break;
                  default :
                    $out .= "&cb_c=5&cb_l0=Можно всем&cb_d0=page.php?id=282%26rf=0&cb_l1=Атаковать всех&cb_d1=page.php?id=282%26rf=1&cb_l2=Атаковать врагов&cb_d2=page.php?id=282%26rf=2&cb_l3=Атаковать не друзей&cb_d3=page.php?id=282%26rf=3&cb_l4=Атаковать не альянс&cb_d4=page.php?id=282%26rf=4";
                    break;
                }
              }
            } else {
              $out .= "&cb_h=Управление заблокированно ".$def['login'];
            }
            break;
    
          case '0':
            $out = "detail=Свободная поверхность";
            $out .= "&cb_h=Возможные постройки";

            switch( $found[ $y ]{ $x } ) {
              case '0' :
                $fnd = 'b.id NOT IN ( 36, 37 ) AND';
                break;
              case '1' :
                $fnd = 'b.id != 37 AND';
                break;
              default :
                $fnd = '';
                break;
            }

            $build = db_fetch_val( "SELECT id FROM planets_buildings WHERE planet_id = {$user->place_id} AND object_id = 32" );
            if( $build ) {
              $fnd .= ' b.id != 32 AND';
            }
    
            if( $user->native ) {
              $items = db_fetch_array( "SELECT o.id, o.name
                                          FROM objects o, buildings b
                                         WHERE o.class = 3 AND
                                                  b.id = o.id AND $fnd
                                              b.native IN( 1, 2 ) AND
                                             ( b.req_id IS NULL OR
                                               b.req_id IN ( SELECT DISTINCT object_id FROM planets_buildings WHERE planet_id = {$user->place_id} ) )
                                      ORDER BY IF(o.id={$info->last_build},0,1), o.weight DESC" );
            } else {
              $items = db_fetch_array( "SELECT o.id, o.name
                                          FROM objects o, buildings b
                                         WHERE o.class = 3 AND
                                                  b.id = o.id AND $fnd
                                              b.native IN ( 0, 1 ) AND
                                             ( b.req_id IS NULL OR
                                               b.req_id IN ( SELECT DISTINCT object_id FROM planets_buildings WHERE planet_id = {$user->place_id} ) )
                                      ORDER BY IF(o.id={$info->last_build},0,1), o.weight DESC" );
            }
            $out .= "&cb_c=".count( $items );
    
            $i=0;
            foreach( $items as $item ) {
            $out .= "&cb_l$i=".$item['name']."&cb_d$i=page.php?id=28%26x=$x%26y=$y%26bid=".$item['id'];
              $i++;
            }
          break;
    
          case 'S':
            $out = "detail=<u><a href='page.php?id=6%26itm=Склад'>Склад</a></u>";
            $out .= "&cb_h=Тип ресурсов";
            $out .= "&cb_c=6&cb_l0=Все&cb_d0=page.php?id=29%26rf=0&cb_l1=Ископаемые&cb_d1=page.php?id=29%26rf=5&cb_l2=Ресурсы&cb_d2=page.php?id=29%26rf=1&cb_l3=Детали&cb_d3=page.php?id=29%26rf=2&cb_l4=Чертежи&cb_d4=page.php?id=29%26rf=6&cb_l5=Макеты&cb_d5=page.php?id=29%26rf=7";
          break;
    
          case 'E':
            $out = "detail=<u><a href='page.php?id=6%26itm=Электростанция'>Электростанция</a></u>";
            $out .= "&cb_h=Тип ресурсов";
            $out .= "&cb_c=6&cb_l0=Все&cb_d0=page.php?id=29%26rf=0&cb_l1=Ископаемые&cb_d1=page.php?id=29%26rf=5&cb_l2=Ресурсы&cb_d2=page.php?id=29%26rf=1&cb_l3=Детали&cb_d3=page.php?id=29%26rf=2&cb_l4=Чертежи&cb_d4=page.php?id=29%26rf=6&cb_l5=Макеты&cb_d5=page.php?id=29%26rf=7";
          break;
    
          case 'C':
            $out = "detail=<u><a href='page.php?id=6%26itm=Капсула'>Капсула</a></u>";
            $out .= "&cb_h=Тип ресурсов";
            $out .= "&cb_c=6&cb_l0=Все&cb_d0=page.php?id=29%26rf=0&cb_l1=Ископаемые&cb_d1=page.php?id=29%26rf=5&cb_l2=Ресурсы&cb_d2=page.php?id=29%26rf=1&cb_l3=Детали&cb_d3=page.php?id=29%26rf=2&cb_l4=Чертежи&cb_d4=page.php?id=29%26rf=6&cb_l5=Макеты&cb_d5=page.php?id=29%26rf=7";
          break;
    
          case 'K':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Карьер'>Карьер</a></u>";
              $out .= "&cb_h=Количество циклов&cb_c=".$info->level;
              for( $i = 0; $i < $info->level; $i++ ) {
                $out .= "&cb_l$i=".($info->level - $i)."&cb_d$i=page.php?id=210%26x=$x%26y=$y%26cl=".($info->level - $i);
              }
            } else {
              if( $info->busy_type == 2 ) {
                $obj = db_fetch_row( "SELECT o.name, p.res_cnt FROM planets_mines p, objects o WHERE p.event_id = {$info->busy_id} AND p.res_id = o.id" );
                $out = "detail=Добывается {$obj['name']} {$obj['res_cnt']}&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
          break;
    
          case 'M':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Шахта'>Шахта</a></u>";
              $out .= "&cb_h=Количество циклов&cb_c=".$info->level;
              for( $i = 0; $i < $info->level; $i++ ) {
                $out .= "&cb_l$i=".($info->level - $i)."&cb_d$i=page.php?id=210%26x=$x%26y=$y%26cl=".($info->level - $i);
              }
            } else {
              if( $info->busy_type == 2 ) {
                $obj = db_fetch_row( "SELECT o.name, p.res_cnt FROM planets_mines p, objects o WHERE p.event_id = {$info->busy_id} AND p.res_id = o.id" );
                $out = "detail=Добывается {$obj['name']} {$obj['res_cnt']}&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Шахта улучшается";
              }
            }
          break;
    
          case 'O':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Буровая'>Буровая</a></u>";
              $out .= "&cb_h=Количество циклов&cb_c=".$info->level;
              for( $i = 0; $i < $info->level; $i++ ) {
                $out .= "&cb_l$i=".($info->level - $i)."&cb_d$i=page.php?id=210%26x=$x%26y=$y%26cl=".($info->level - $i);
              }
            } else {
              if( $info->busy_type == 2 ) {
                $obj = db_fetch_row( "SELECT o.name, p.res_cnt FROM planets_mines p, objects o WHERE p.event_id = {$info->busy_id} AND p.res_id = o.id" );
                $out = "detail=Добывается {$obj['name']} {$obj['res_cnt']}&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Буровая улучшается";
              }
            }
          break;
    
          case 'P':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Нанодиспенсер'>Нанодиспенсер</a></u>";
              $items = db_fetch_array( "SELECT o.id, o.name, w.object_cnt
                                          FROM warehouse w 
                                    INNER JOIN objects o ON o.id = w.object_id
                                         WHERE w.place_type = 1 AND
                                               w.place_id = $planet_id AND
                                               o.class IN ( 2, 5, 9 ) AND
                                               w.object_cnt > 0
                                      ORDER BY CASE o.class WHEN 5 THEN 1 WHEN 2 THEN 2 WHEN 9 THEN 3 END,
                                               CASE o.class WHEN 5 THEN w.object_cnt ELSE 0 END DESC, o.name" );
  
              if( count( $items ) > 0 ) {
                $out .= "&cb_h=Материал для переработки";
                $out .= "&cb_c=".count( $items );
                $i=0;
                foreach( $items as $item ) {
                  $out .= "&cb_l$i={$item['name']} ({$item['object_cnt']})&cb_d$i=page.php?id=271%26x=$x%26y=$y%26rid={$item['id']}";
                  $i++;
                }
              } else {
                $out .= "&cb_h=Недостаточно сырья для переработки";
                $out .= "&cb_c=0";
              }
            } else {
              if( $info->busy_type == 3 ) {
                $obj = db_fetch_row( "SELECT o.name FROM planets_disp p, objects o WHERE p.event_id = {$info->busy_id} AND p.res_id = o.id" );
                $out = "detail=Перерабатывается {$obj['name']}&btLabel=Остановить переработку&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Нанодиспенсер улучшается";
              }
            }
          break;
    
          case 'F':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Завод'>Завод</a></u>";
              $last = ( $info->last != null ) ? $info->last : 0;
              $items = db_fetch_array( "SELECT o1.id, o1.name
                                          FROM warehouse w
                                    INNER JOIN objects o ON o.id = w.object_id
                                    INNER JOIN objects_sub os ON os.res_id = o.id
                                    INNER JOIN objects o1 ON o1.id = os.object_id
                                         WHERE w.place_id = $planet_id AND
                                               w.place_type = 1 AND
                                               o.class = 6
                                      ORDER BY IF(o1.id=$last,0,1), o1.name, o1.id" );
    
              if( count( $items ) > 0 ) {
                $out .= "&cb_h=Продукт изготовления";
                $out .= "&cb_c=".count( $items );
                $i=0;
                foreach( $items as $item ) {
                  $out .= "&cb_l$i={$item['name']}&cb_d$i=page.php?id=275%26x=$x%26y=$y%26oid={$item['id']}";
                  $i++;
                }
              }
            } else {
              if( $info->busy_type == 5 ) {
                $obj = db_fetch_row( "SELECT o.name FROM planets_make p, objects o WHERE p.event_id = {$info->busy_id} AND p.object_id = o.id" );
                $out = "detail=Изготавливается {$obj['name']}&btLabel=Остановить изготовление&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Завод улучшается";
              }
            }
          break;
    
          case 'R':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Сборочный цех'>Сборочный цех</a></u>";
              $last = ( $info->last != null ) ? $info->last : 0;
              $items = db_fetch_array( "SELECT o1.id, o1.name
                                          FROM warehouse w
                                    INNER JOIN objects o ON o.id = w.object_id
                                    INNER JOIN objects_sub os ON os.res_id = o.id
                                    INNER JOIN objects o1 ON o1.id = os.object_id
                                         WHERE w.place_id = $planet_id AND
                                               w.place_type = 1 AND
                                               o.class = 7
                                      ORDER BY IF(o1.id=$last,0,1), o1.name, o1.id" );
                                                      
              if( count( $items ) > 0 ) {
                $out .= "&cb_h=Объект сборки";
                $out .= "&cb_c=".count( $items );
                $i=0;
                foreach( $items as $item ) {
                  $out .= "&cb_l$i={$item['name']}&cb_d$i=page.php?id=278%26x=$x%26y=$y%26oid={$item['id']}";
                  $i++;
                }
              }
            } else {
              if( $info->busy_type == 5 ) {
                $obj = db_fetch_row( "SELECT o.name FROM planets_make p, objects o WHERE p.event_id = {$info->busy_id} AND p.object_id = o.id" );
                $out = "detail=Собирается {$obj['name']}&btLabel=Остановить сборку&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {         
                $out = "detail=Цех улучшается";
              }
            }
          break;
    
          case 'L':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Лаборатория'>Лаборатория</a></u>";
              $last = ( $info->last != null ) ? $info->last : 0;
              $layouts = db_fetch_array( "SELECT DISTINCT o.id, o.name
                                            FROM warehouse w
                                      INNER JOIN objects o ON w.object_id = o.id
                                           WHERE w.place_id = $planet_id AND w.place_type = 1 AND o.class IN( 6, 7 )
                                        ORDER BY IF(o.id=$last,0,1), o.class, o.name, o.id" );
    
              foreach( $layouts as $item ) {
                $exclude[ $item['id'] ] = 1;
              }
    
              $detail = db_fetch_array( "SELECT DISTINCT o.id, o.name, o2.id lid
                                           FROM warehouse w, objects o, objects_sub os, objects o2
                                          WHERE w.place_id = $planet_id AND w.place_type = 1 AND w.object_id = o.id AND o.class IN( 2, 9 ) AND
                                                os.object_id = o.id AND os.res_id = o2.id AND o2.class IN( 6, 7 )
                                       ORDER BY o.class, o.name, o.id" );
    
              $research = db_fetch_array("SELECT DISTINCT o.id, CONCAT( '%2B ', o.name ) name
                                            FROM warehouse w1
                                      RIGHT JOIN research r ON w1.object_id = r.from_object
                                      INNER JOIN objects o ON o.id = r.to_object
                                       LEFT JOIN warehouse w2 ON w1.place_id = w2.place_id AND w1.place_type = w2.place_type AND w2.object_id = r.to_object
                                           WHERE w1.place_type = 1 AND w1.object_id IS NOT NULL AND w2.object_id IS NULL AND w1.place_id = ".$user->place_id);
    
              $items = array();
              foreach( $detail as $item ) {
                if( !isset( $exclude[ $item['lid'] ] ) || $exclude[ $item['lid'] ] != 1 ) {
                  $items[] = $item;
                }
              }
    
              $items = array_merge( $items, $layouts, $research );
    
              if( count( $items ) > 0 ) {
                $out .= "&cb_h=Объект исследования";
                $out .= "&cb_c=".count( $items );
                $i=0;
                foreach( $items as $item ) {
                  $out .= "&cb_l$i={$item['name']}&cb_d$i=page.php?id=280%26x=$x%26y=$y%26oid={$item['id']}";
                  $i++;
                }
              }
            } else {
              switch( $info->busy_type ) {
                case 4:
                  $out = "detail=Лаборатория улучшается";
                  break;
                case 6:
                  $obj = db_fetch_row( "SELECT o.name FROM planet_events p, objects o WHERE p.id = {$info->busy_id} AND p.object_id = o.id" );
                  $out = "detail=Исследуется {$obj['name']}&btLabel=Остановить исследование&btOnClick=page.php?id=277%26x=$x%26y=$y";
                  break;
                case 7:
                  $obj = db_fetch_row( "SELECT o.name FROM planet_events p, objects o WHERE p.id = {$info->busy_id} AND p.object_id = o.id" );
                  $out = "detail=Разрабатывается {$obj['name']}&btLabel=Остановить разработку&btOnClick=page.php?id=277%26x=$x%26y=$y";
                  break;
                default:
                  $out = "detail=Что-то не так ".$info->busy_type;
                  break;
              }
            }
            break;

          case 'A':
            $name = db_fetch_val( "SELECT a.sname
                                     FROM academy a
                               INNER JOIN academy_build ab ON ab.type = a.id
                                    WHERE ab.build_id = {$info->bid}", 'sname' );
            if( $name ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Академия'>Академия $name</a></u>";
            } else {
              $out = "detail=<u><a href='page.php?id=6%26itm=Академия'>Академия</a></u>";
            }

            if( $info->level == 1 || $name == '' ) {
              if( $info->busy_type == 5 ) {
                $out = "detail=Академия улучшается";
              } else {
                $research = db_fetch_array( "SELECT a.id, a.name
                                               FROM academy a
                                              WHERE a.id NOT IN( SELECT type FROM academy_build WHERE user_id = {$user->uid} )" );

                if( count( $research ) > 0 ) {
                  $out .= "&cb_h=Возможные исследования";
                  $out .= "&cb_c=".count( $research );
                  $i=0;
                  foreach( $research as $item ) {
                    $out .= "&cb_l$i={$item['name']}&cb_d$i=page.php?id=286%26x=$x%26y=$y%26rf={$item['id']}";
                    $i++;
                  }
                } else {
                  $out .= "&cb_h=Все типы академий построены";
                }
              }
            }
            break;
        }
      } else {
        switch( $buildings[ $y ]{$x} ) {

          case '0':
            $out = "detail=Свободная поверхность a";
            $out .= "&cb_h=Возможные постройки";
    
            $items = db_fetch_array( "SELECT o.id, o.name
                                        FROM objects o, buildings b
                                       WHERE o.class = 3 AND
                                             b.id = o.id AND
                                             b.id IN ( 36, 37 )
                                    ORDER BY o.weight DESC" );
            $out .= "&cb_c=".count( $items );
    
            $i=0;
            foreach( $items as $item ) {
            $out .= "&cb_l$i=".$item['name']."&cb_d$i=page.php?id=28%26x=$x%26y=$y%26bid=".$item['id'];
              $i++;
            }
          break;

          case 'M':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Шахта'>Шахта</a></u>";
              $out .= "&cb_h=Количество циклов&cb_c=".$info->level;
              for( $i = 0; $i < $info->level; $i++ ) {
                $out .= "&cb_l$i=".($info->level - $i)."&cb_d$i=page.php?id=210%26x=$x%26y=$y%26cl=".($info->level - $i);
              }
            } else {
              if( $info->busy_type == 2 ) {
                $obj = db_fetch_row( "SELECT o.name, p.res_cnt FROM planets_mines p, objects o WHERE p.event_id = {$info->busy_id} AND p.res_id = o.id" );
                $out = "detail=Добывается {$obj['name']} {$obj['res_cnt']}&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Шахта улучшается";
              }
            }
          break;
    
          case 'O':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Буровая'>Буровая</a></u>";
              $out .= "&cb_h=Количество циклов&cb_c=".$info->level;
              for( $i = 0; $i < $info->level; $i++ ) {
                $out .= "&cb_l$i=".($info->level - $i)."&cb_d$i=page.php?id=210%26x=$x%26y=$y%26cl=".($info->level - $i);
              }
            } else {
              if( $info->busy_type == 2 ) {
                $obj = db_fetch_row( "SELECT o.name, p.res_cnt FROM planets_mines p, objects o WHERE p.event_id = {$info->busy_id} AND p.res_id = o.id" );
                $out = "detail=Добывается {$obj['name']} {$obj['res_cnt']}&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Буровая улучшается";
              }
            }
          break;
  
          case 'B':
            $out = "detail=Ведется стройка или разработка&btLabel=Остановить строительство&btOnClick=page.php?id=277%26x=$x%26y=$y";
    
              if( $info->busy_type == 1 ) {
                $obj = db_fetch_row( "SELECT o.id, o.name FROM planet_events pe, objects o WHERE pe.id = {$info->busy_id} AND pe.object_id = o.id" );
                if( $obj['id'] == 2000 ) {
                  if( $found[ $y ]{$x} == 0 ) {
                    $out = "detail=Разрабатывается средний слой&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
                  } else {
                    $out = "detail=Разрабатывается глубинный слой&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
                  }
                } else {
                  $out = "detail=Строится {$obj['name']}&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
                }
              }
            break;
        }
      }
    } else {
      if( $type != 5 ) {
        switch( $buildings[ $y ]{$x} ) {
          case 'B':
            if( $bt > 0 ) {
              $out = "detail=Ведется стройка или разработка&btLabel=Остановить строительство&btOnClick=page.php?id=277%26x=$x%26y=$y";

              if( $info->busy_type == 1 ) {
                $obj = db_fetch_row( "SELECT o.id, o.name FROM planet_events pe, objects o WHERE pe.id = {$info->busy_id} AND pe.object_id = o.id" );
                if( $obj['id'] == 2000 ) {
                  $out = "detail=Ведется разработка";
                } else {
                  $out = "detail=Строится {$obj['name']}&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
                }
              }
            } else {
              $out = "detail=<u><a href='page.php?id=6%26itm=Ракетная защита'>Ракетная защита</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            }
            break;
    
          case 'D':
            $out = "detail=<u><a href='page.php?id=6%26itm=Ракетная защита'>Ракетная защита</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case 'H':
            $out = "detail=<u><a href='page.php?id=6%26itm=Лазерная защита'>Лазерная защита</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case 'J':
            $out = "detail=<u><a href='page.php?id=6%26itm=Плазменная защита'>Плазменная защита</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case 'N':
            $out = "detail=<u><a href='page.php?id=6%26itm=Коротковолновый мазер'>Коротковолновый мазер</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case 'U':
            $out = "detail=<u><a href='page.php?id=6%26itm=Планетарный щит'>Планетарный щит</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case '0':
            if( $bt > 0 ) {
              $out = "detail=Свободная поверхность";
              $out .= "&cb_h=Возможные постройки";

              $fnd = 'b.id = '.$bt.' AND';

              if( $user->native ) {
                $items = db_fetch_array( "SELECT o.id, o.name
                                            FROM objects o, buildings b
                                           WHERE o.class = 3 AND
                                                    b.id = o.id AND $fnd
                                                b.native IN( 1, 2 ) AND
                                               ( b.req_id IS NULL OR
                                                 b.req_id IN ( SELECT DISTINCT object_id FROM planets_buildings WHERE planet_id = {$user->place_id} ) )
                                        ORDER BY IF(o.id={$info->last_build},0,1), o.weight DESC" );
              } else {
                $items = db_fetch_array( "SELECT o.id, o.name
                                            FROM objects o, buildings b
                                           WHERE o.class = 3 AND
                                                    b.id = o.id AND $fnd
                                                b.native IN ( 0, 1 ) AND
                                               ( b.req_id IS NULL OR
                                                 b.req_id IN ( SELECT DISTINCT object_id FROM planets_buildings WHERE planet_id = {$user->place_id} ) )
                                        ORDER BY IF(o.id={$info->last_build},0,1), o.weight DESC" );
              }
              $out .= "&cb_c=".count( $items );
    
              $i=0;
              foreach( $items as $item ) {
              $out .= "&cb_l$i=".$item['name']."&cb_d$i=page.php?id=28%26x=$x%26y=$y%26bid=".$item['id'];
                $i++;
              }
            } else {
              $out = "detail=Свободная поверхность";
              $out .= "&cb_h=Управление заблокированно";
            }
            break;
    
          case 'S':
            $out = "detail=<u><a href='page.php?id=6%26itm=Склад'>Склад</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case 'E':
            $out = "detail=<u><a href='page.php?id=6%26itm=Электростанция'>Электростанция</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case 'C':
            $out = "detail=<u><a href='page.php?id=6%26itm=Капсула'>Капсула</a></u>";
            $out .= "&cb_h=Управление заблокированно";
            break;
    
          case 'K':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Карьер'>Карьер</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 2 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
    
          case 'M':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Шахта'>Шахта</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 2 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
    
          case 'O':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Буровая'>Буровая</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 2 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
    
          case 'P':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Нанодиспенсер'>Нанодиспенсер</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 3 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить переработку&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
    
          case 'F':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Завод'>Завод</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 5 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить изготовление&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
    
          case 'R':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Сборочный цех'>Сборочный цех</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 5 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить сборку&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
    
          case 'L':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Лаборатория'>Лаборатория</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 6 || $info->busy_type == 7 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить исследование&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
        }
      } else {
        switch( $buildings[ $y ]{$x} ) {
          case '0':
            $out = "detail=Свободная поверхность a";
            $out .= "&cb_h=Возможные постройки";
    
            $fnd = 'b.id = '.$bt;

            $items = db_fetch_array( "SELECT o.id, o.name
                                        FROM objects o, buildings b
                                       WHERE o.class = 3 AND
                                             b.id = o.id AND
                                             b.id IN ( 36, 37 ) AND $fnd
                                    ORDER BY o.weight DESC" );
            $out .= "&cb_c=".count( $items );
    
            $i=0;
            foreach( $items as $item ) {
            $out .= "&cb_l$i=".$item['name']."&cb_d$i=page.php?id=28%26x=$x%26y=$y%26bid=".$item['id'];
              $i++;
            }
            break;
  
          case 'M':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Шахта'>Шахта</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 2 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
    
          case 'O':
            if( $info->busy == 0 ) {
              $out = "detail=<u><a href='page.php?id=6%26itm=Буровая'>Буровая</a></u>";
              $out .= "&cb_h=Управление заблокированно";
            } else {
              if( $info->busy_type == 2 ) {
                $out = "detail=Управление заблокированно&btLabel=Остановить добычу&btOnClick=page.php?id=277%26x=$x%26y=$y";
              } else {
                $out = "detail=Карьер улучшается";
              }
            }
            break;
  
          case 'B':
            $out = "detail=Ведется стройка или разработка&btLabel=Остановить строительство&btOnClick=page.php?id=277%26x=$x%26y=$y";
    
            if( $info->busy_type == 1 ) {
              $obj = db_fetch_row( "SELECT o.id, o.name FROM planet_events pe, objects o WHERE pe.id = {$info->busy_id} AND pe.object_id = o.id" );
              if( $obj['id'] == 2000 ) {
                if( $found[ $y ]{$x} == 0 ) {
                  $out = "detail=Разрабатывается средний слой&cb_h=Управление заблокированно";
                } else {
                  $out = "detail=Разрабатывается глубинный слой&cb_h=Управление заблокированно";
                }
              } else {
                $out = "detail=Строится {$obj['name']}&btLabel=Остановить&btOnClick=page.php?id=277%26x=$x%26y=$y";
              }
            }
            break;
        }
      }
    }
    printOut( $out );
  }
