<?php

  global $user;

  if( isset( $_GET['ships'] ) ) {
    $ships = explode( ':', $_GET['ships'] );
  } else {
    $ships = array();
  }

  if( isset( $_GET['cnt'] ) && is_numeric( $_GET['cnt'] ) &&
      $_GET['cnt'] == count( $ships ) ) {

/*
    $cnt = $_GET['cnt'];

    for( $i=0; $i < $cnt; $i++ ) {
      $ships[ $i ] = $_GET["sh$i"];
      db_safe( $ships[ $i ] );
    }
*/
    $type = substr( $ships[ 0 ], 0, 1 );
    $item = substr( $ships[ 0 ], 1 );
    $fleet = ( $type == 'S' || $type == 'F' );
    if( $type == 'S' ) {
      $base = db_fetch_row( "SELECT place_id, place_type, arg1, arg2 FROM ships WHERE object_id NOT IN( 9310, 9355 ) AND inwar = 0 AND user_id = {$user->uid} AND id = ".$item );
    } else {
      $base = db_fetch_row( "SELECT place_id, place_type, arg1, arg2 FROM fleets WHERE inwar = 0 AND user_id = {$user->uid} AND id = ".$item );
    }

    for( $i=1; ( $i < $cnt ) && $fleet; $i++ ) {
      $type = substr( $ships[ $i ], 0, 1 );
      $item = substr( $ships[ $i ], 1 );

      if( $type == 'S' ) {
        $test = db_fetch_row( "SELECT place_id, place_type, arg1, arg2 FROM ships WHERE object_id NOT IN( 9310, 9355 ) AND inwar = 0 AND place_type IN(0,1,2,3,7,8) AND user_id = {$user->uid} AND id = ".$item );
      } else {
        $test = db_fetch_row( "SELECT place_id, place_type, arg1, arg2 FROM fleets WHERE inwar = 0 AND place_type IN(0,1,2,3,7,8) AND user_id = {$user->uid} AND id = ".$item );
      }

      if( $test[ 'place_id' ] === null || $test[ 'place_id' ] != $base[ 'place_id' ] ||
          $test[ 'arg1' ] != $base[ 'arg1' ] || $test[ 'arg2' ] != $base[ 'arg2' ] ||
          $test[ 'place_type' ] != $base[ 'place_type' ] ||
          ( $type != 'S' && $type != 'F' ) ) {
        $fleet = false;
      }
    }

    $attack = true;
    $item = substr( $ships[ 0 ], 1 );
    $type = substr( $ships[ 0 ], 0, 1 );
    if( $type == 'S' || $type == 'Z' ) {
      $base = db_fetch_row( "SELECT place_id, place_type, arg1, arg2, user_id FROM ships WHERE inwar = 0 AND id = ".$item );
    } else {
      $base = db_fetch_row( "SELECT place_id, place_type, arg1, arg2, user_id FROM fleets WHERE inwar = 0 AND id = ".$item );
    }

    $two_user = false;
    for( $i=1; ( $i < $cnt ) && $attack; $i++ ) {
      $item = substr( $ships[ $i ], 1 );
      $type = substr( $ships[ $i ], 0, 1 );
      if( $type == 'S' || $type == 'Z' ) {
        $test = db_fetch_row( "SELECT place_id, place_type, arg1, arg2, user_id, fleet_id FROM ships WHERE inwar = 0 AND place_type IN(0,1,7,8) AND id = ".$item );
      } else {
        $test = db_fetch_row( "SELECT place_id, place_type, arg1, arg2, user_id FROM fleets WHERE inwar = 0 AND place_type IN(0,1,7,8) AND id = ".$item );
      }

      if( $test['user_id'] != $base['user_id'] ) {
        $two_user = true;

        if( isset( $test['fleet_id'] ) && is_numeric( $test['fleet_id'] ) ) {
          $add_fleet = ' флот';
        } else {
          $add_fleet = '';
        }
      }

      if( $test[ 'place_id' ] != $base[ 'place_id' ] || $test[ 'place_type' ] != $base[ 'place_type' ] ||
          $test[ 'arg1' ] != $base[ 'arg1' ] || $test[ 'arg2' ] != $base[ 'arg2' ] ) {
        $attack = false;
      }
    }

    $l = 0;
    $out = 'err=0';

    if( $base['place_type'] == 0 || $base['place_type'] == 1 ) {
      if( $base['place_id'] ) {
        $home = db_fetch_row( "SELECT type FROM planets WHERE id = {$base['place_id']}" );
        if( isset( $home['type'] ) && $home['type'] == 1 ) {
          $attack = false;
        }
      } else {
        $attack = false;
      }
    }

    if( $fleet ) {
      $out .= "&id$l=0&name$l=Объединить корабли в флот";
      $l++;
    } else {
      if( $attack && $two_user ) {
        $out .= "&id$l=16&name$l=Атаковать".$add_fleet;
        $l++;
      }
    }
    $out .= "&cnt=$l";

    printOut( $out );
  } else {
    printOut( "err=1" );
  }
