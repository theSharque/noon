<?php

  $ans = array( '' => 'Нет', false => 'Нет', true => 'Установлен' );
  $wtp = array( 0 => 'Лазер', 1 => 'Плазма', 2 => 'Квант' );

  if( isset( $_GET['shid'] ) ) {
    $type = substr( $_GET['shid'], 0 , 1 );
    $shid = substr( $_GET['shid'],  1 );
  
    switch( $type ) {
      case 'S' :
      case 'Z' :
        $ship = db_fetch_row( "SELECT o.name, o.mass, o2.mass mass2, st.tactik, s.group, IF( st.corsar = 0, u.login, 'corsar' ) login, IF( st.corsar = 0, ua.char_status, '0' ) char_status, st.cargo, s.shield, st.shield shd, st.w_power, st.agrav, st.planet, st.hyper, st.missile,
                                      st.w_count, st.planet_cnt, st.hyper_cnt, st.radar, st.remote, st.interupt, st.cloak, st.pic, st.w_type
                                 FROM ships s
                           INNER JOIN objects o ON o.id = s.object_id
                           INNER JOIN ship_types st ON st.object_id = s.object_id
                           INNER JOIN objects o2 ON o2.id = st.conserv_id
                           INNER JOIN users u ON u.id = s.user_id
                           INNER JOIN users_active ua ON ua.id = u.id
                                WHERE s.id = $shid" );
    
        $addons = array();
        if( $ship['radar'] ) {
          $addons[] = "радар ".$ship['radar'];
        }
        if( $ship['cloak'] ) {
          $addons[] = "антирадар ".$ship['cloak'];
        }
        if( $ship['remote'] ) {
          $addons[] = "модуль гиперсвязи";
        }
        if( $ship['interupt'] ) {
          $addons[] = "модуль перехвата";
        }
        if( count( $addons ) == 0 ) {
          $addons[] = 'не установлено';
        }

        $shield = ( $ship['shield'] != $ship['shd'] ) ? "<br><font color=\"#FF0000\">Защита: ".$ship['shield']."({$ship['shd']})</font>" : "<br>Защита: ".$ship['shield']."({$ship['shd']})";

        $out = "out=Тип корабля: ".$ship['name'].
            "<br>Владелец: <u><a href='page.php?id=18%26login={$ship['login']}'>".$ship['login']."</a></u> (".$ship['char_status'].")".
            "<br>Группа: ".( $ship['group'] != '' ? $ship['group'] : 'общая' ).
            "<br>Грузоподъемность: ".$ship['cargo'].
            "<br>Масса: ".$ship['mass2'].
            "<br>Масса стыковки: ".$ship['mass'].
            $shield.
            "<br>Сила залпа: ".( ( $ship['w_count'] > 0 ? $ship['w_count'] : 1 ) * $ship['w_power'] )." (".$ship['w_count']."x".$ship['w_power'].")".
            "<br>Тип вооружения: ".( isset( $ship['w_type'] ) ? $wtp[$ship['w_type']] : 'не определен' ).
            "<br>Уровень тактика: ".$ship['tactik'].
            "<br>Антигравитационный двигатель: ".$ans[$ship['agrav']].
            "<br>Скорость в пространстве: ".$ship['planet'].
            "<br>Потребление водорода: ".$ship['planet_cnt'].
            "<br>Скорость в гиперпространстве: ".$ship['hyper'].
            "<br>Потребление урана: ".$ship['hyper_cnt'].
            "<br>Максимальный тип ракет: ".$ship['missile'].
            "<br>Дополнительное оборудование: ".implode( ', ', $addons );

        if( $ship['pic'] ) {
          $out .= "&pic=".$ship['pic'];
        }
        break;

      case 'A' :
        $ship = db_fetch_row( "SELECT o.name, o.mass, o2.mass mass2, st.tactik, st.cargo, s.shield, st.shield shd, st.w_power, st.agrav, st.planet, st.hyper, st.w_count, st.missile,
                                      st.planet_cnt, st.hyper_cnt, st.radar, st.remote, st.interupt, st.cloak, st.pic, st.w_type
                                 FROM ships s
                           INNER JOIN objects o ON o.id = s.object_id
                           INNER JOIN ship_types st ON st.object_id = s.object_id
                           INNER JOIN objects o2 ON o2.id = st.conserv_id
                                WHERE s.user_id IS NULL AND s.id = $shid" );
    
        $addons = array();
        if( $ship['radar'] ) {
          $addons[] = "радар ".$ship['radar'];
        }
        if( $ship['cloak'] ) {
          $addons[] = "антирадар ".$ship['cloak'];
        }
        if( $ship['remote'] ) {
          $addons[] = "модуль гиперсвязи";
        }
        if( $ship['interupt'] ) {
          $addons[] = "модуль перехвата";
        }
        if( count( $addons ) == 0 ) {
          $addons[] = 'не установлено';
        }

        $shield = ( $ship['shield'] != $ship['shd'] ) ? "<br><font color=\"#FF0000\">Защита: ".$ship['shield']."({$ship['shd']})</font>" : "<br>Защита: ".$ship['shield']."({$ship['shd']})";

        $out = "out=Тип корабля: ".$ship['name'].
            "<br>Грузоподъемность: ".$ship['cargo'].
            "<br>Масса: ".$ship['mass2'].
            "<br>Масса стыковки: ".$ship['mass'].
            $shield.
            "<br>Сила залпа: ".( ( $ship['w_count'] > 0 ? $ship['w_count'] : 1 ) * $ship['w_power'] )." (".$ship['w_count']."x".$ship['w_power'].")".
            "<br>Тип вооружения: ".( isset( $ship['w_type'] ) ? $wtp[$ship['w_type']] : 'не определен' ).
            "<br>Уровень тактика: ".$ship['tactik'].
            "<br>Антигравитационный двигатель: ".$ans[$ship['agrav']].
            "<br>Скорость в пространстве: ".$ship['planet'].
            "<br>Потребление водорода: ".$ship['planet_cnt'].
            "<br>Скорость в гиперпространстве: ".$ship['hyper'].
            "<br>Потребление урана: ".$ship['hyper_cnt'].
            "<br>Максимальный тип ракет: ".$ship['missile'].
            "<br>Дополнительное оборудование: ".implode( ', ', $addons );

        if( $ship['pic'] ) {
          $out .= "&pic=".$ship['pic'];
        }
        break;

      case 'F' :
        $ship = db_fetch_row( "SELECT COUNT( s.id ) cnt, f.group, IF( MIN( st.corsar ) = 1, 'corsar', u.login ) login, IF( MIN( st.corsar ) = 1, '0', ua.char_status ) char_status, f.cargo, SUM( s.shield ) shield, SUM( st.shield ) shd, f.w_power, f.w_count, f.agrav, f.planet, f.hyper,
                                      f.planet_cnt, f.hyper_cnt, f.radar, f.remote, f.interupt, f.cloak, SUM( o.mass ) mass
                                 FROM fleets f
                           INNER JOIN ships s ON f.id = s.fleet_id
                           INNER JOIN ship_types st ON st.object_id = s.object_id
                           INNER JOIN objects o ON o.id = s.object_id
                           INNER JOIN users u ON u.id = f.user_id
                           INNER JOIN users_active ua ON ua.id = u.id
                                WHERE f.id = $shid
                             GROUP BY f.cargo, f.shield, f.w_power, f.w_count, f.agrav, f.planet, f.hyper" );
    
        $addons = array();
        if( $ship['radar'] ) {
          $addons[] = "радар ".$ship['radar'];
        }
        if( $ship['cloak'] ) {
          $addons[] = "антирадар ".$ship['cloak'];
        }
        if( $ship['remote'] ) {
          $addons[] = "модуль гиперсвязи";
        }
        if( $ship['interupt'] ) {
          $addons[] = "модуль перехвата";
        }
        if( count( $addons ) == 0 ) {
          $addons[] = 'не установлено';
        }

        $shield = ( $ship['shield'] != $ship['shd'] ) ? "<br><font color=\"#FF0000\">Защита: ".$ship['shield']."({$ship['shd']})</font>" : "<br>Защита: ".$ship['shield']."({$ship['shd']})";

        $out = "out=Количество кораблей: ".$ship['cnt'].
            "<br>Владелец: <u><a href='page.php?id=18%26login={$ship['login']}'>".$ship['login']."</a></u> (".$ship['char_status'].")".
            "<br>Группа: ".( $ship['group'] != '' ? $ship['group'] : 'общая' ).
            "<br>Общая грузоподъемность: ".$ship['cargo'].
            "<br>Общая масса: ".$ship['mass'].
            $shield.
            "<br>Общая мощность залпа: ".$ship['w_power'].
            "<br>Количество вооружения: ".$ship['w_count'].
            "<br>Антигравитационный двигатель: ".$ans[$ship['agrav']].
            "<br>Скорость в пространстве: ".$ship['planet'].
            "<br>Потребление водорода: ".$ship['planet_cnt'].
            "<br>Скорость в гиперпространстве: ".$ship['hyper'].
            "<br>Потребление урана: ".$ship['hyper_cnt'].
            "<br>Дополнительное оборудование: ".implode( ', ', $addons );

        $fleet = db_fetch_array( "SELECT o.name, count(*) cnt
                                    FROM ships s
                              INNER JOIN objects o ON o.id = s.object_id
                                   WHERE s.fleet_id = $shid
                                GROUP BY o.name" ); 
        $out .= "&info=<b>Состав флота:</b>\n";
        foreach( $fleet as $ship ) {
          $out .= $ship['name'].' ('.$ship['cnt'].")\n";
        }
        break;

      case 'C' :
        $ship = db_fetch_row( "SELECT o.name, o.mass, st.tactik, w.object_cnt cnt, st.cargo, st.shield, st.w_power, st.agrav, st.planet, st.hyper, st.w_count, st.missile,
                                      st.planet_cnt, st.hyper_cnt, st.radar, st.remote, st.interupt, st.cloak, st.pic, st.w_type
                                 FROM warehouse w
                           INNER JOIN objects o ON o.id = w.object_id
                           INNER JOIN ship_types st ON st.conserv_id = w.object_id
                                WHERE w.wid = $shid" );

        $addons = array();
        if( $ship['radar'] ) {
          $addons[] = "радар ".$ship['radar'];
        }
        if( $ship['cloak'] ) {
          $addons[] = "антирадар ".$ship['cloak'];
        }
        if( $ship['remote'] ) {
          $addons[] = "модуль гиперсвязи";
        }
        if( $ship['interupt'] ) {
          $addons[] = "модуль перехвата";
        }
        if( count( $addons ) == 0 ) {
          $addons[] = 'не установлено';
        }

        $out = "out=Тип корабля: ".$ship['name'].
            "<br>Количество кораблей: ".$ship['cnt'].
            "<br>Грузоподъемность: ".$ship['cargo'].
            "<br>Масса: ".$ship['mass'].
            "<br>Защита: ".$ship['shield'].
            "<br>Сила залпа: ".( ( $ship['w_count'] > 0 ? $ship['w_count'] : 1 ) * $ship['w_power'] )." (".$ship['w_count']."x".$ship['w_power'].")".
            "<br>Тип вооружения: ".( isset( $ship['w_type'] ) ? $wtp[$ship['w_type']] : 'не определен' ).
            "<br>Уровень тактика: ".$ship['tactik'].
            "<br>Антигравитационный двигатель: ".$ans[$ship['agrav']].
            "<br>Скорость в пространстве: ".$ship['planet'].
            "<br>Потребление водорода: ".$ship['planet_cnt'].
            "<br>Скорость в гиперпространстве: ".$ship['hyper'].
            "<br>Потребление урана: ".$ship['hyper_cnt'].
            "<br>Максимальный тип ракет: ".$ship['missile'].
            "<br>Дополнительное оборудование: ".implode( ', ', $addons );

        if( $ship['pic'] ) {
          $out .= "&pic=".$ship['pic'];
        }
        break;

      default :
        $out = 'err=2';
        break;
    }
  } else {
    $out = 'err=1';
  }

  printOut( $out );