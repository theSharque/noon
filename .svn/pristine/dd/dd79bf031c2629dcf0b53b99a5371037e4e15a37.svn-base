<?php

function printOut( $text ) {
  global $user;

  echo mb_convert_encoding( $text.'&eof=1', 'UTF-8', 'Windows-1251' );
  $data = str_ireplace( "'", "\'", $text );
}

function get_planet_info( $x, $y, $place_id = -1 ) {
  global $user;
  $place = new stdClass();

  $place->type = 1;

  if( $place_id == -1 ) {
    $place->id = $user->place_id;
  } else {
    $place->id = $place_id;
  }

  $place->x = $x;
  $place->y = $y;

  $result = db_fetch_row( "SELECT SQL_NO_CACHE id, event_type FROM planet_events WHERE x=$x AND y=$y AND planet_id={$place->id}" );
  if( $result['id'] ) {
    $place->busy = 1;
    $place->busy_type = $result['event_type'];
    $place->busy_id = $result['id'];
  } else {
    $place->busy = 0;
    $place->busy_type = 0;
    $place->busy_id = 0;
  }

  $result = db_fetch_row( "SELECT id, object_id, level, last_id, last_cyc FROM planets_buildings WHERE x=$x AND y=$y AND planet_id={$place->id}" );
  $place->bid = $result['id'];
  $place->building = $result['object_id'];
  $place->level = $result['level'];
  $place->last = $result['last_id'];
  $place->cyc = $result['last_cyc'];

  $result = db_fetch_row( "SELECT last_build FROM planets WHERE id={$place->id}" );
  $place->last_build = $result['last_build'];

  return $place;
}

function get_orbit_info( $x, $place_id = -1 ) {
  global $user;
  $place = new stdClass();

  $place->type = 2;

  if( $place_id == -1 ) {
    $place->id = $user->place_id;
  } else {
    $place->id = $place_id;
  }

  $place->x = $x;

  $result = db_fetch_row( "SELECT SQL_NO_CACHE id, event_type FROM orbit_events WHERE x=$x AND planet_id={$place->id}" );
  if( $result['id'] ) {
    $place->busy = 1;
    $place->busy_type = $result['event_type'];
    $place->busy_id = $result['id'];
  } else {
    $place->busy = 0;
    $place->busy_type = 0;
    $place->busy_id = 0;
  }

  $result = db_fetch_row( "SELECT id, object_id, level, last_id, last_cyc FROM orbits_buildings WHERE x=$x AND planet_id={$place->id}" );
  $place->bid = $result['id'];
  $place->building = $result['object_id'];
  $place->level = $result['level'];
  $place->last = $result['last_id'];
  $place->cyc = $result['last_cyc'];

  $result = db_fetch_row( "SELECT last_build FROM planets WHERE id={$place->id}" );
  $place->last_build = $result['last_build'];

  return $place;
}

function get_energy( $place_id = -1, $place_type = -1 ) {
  global $user;
  if( $place_id == -1 ) {
    $place_id = $user->place_id;
  }

  if( $place_type == -1 ) {
    $place_type = $user->place_type;
  }

  switch( $place_type ) {
    case 1:
      $type = db_fetch_val( "SELECT type FROM planets WHERE id = $place_id", 'type' );

      if( $type == 5 ) {
        $energy = 1000;
      } else {
        $energy = db_fetch_val( "SELECT IFNULL( SUM( b.energy + IF( b.energy > 0, pb.level * 25, 0 ) ), 0 ) energy
                                   FROM planets_buildings pb INNER JOIN buildings b ON b.id = pb.object_id
                                  WHERE pb.planet_id = $place_id", 'energy' );
      }
    break;
    case 0:
      $energy = db_fetch_val( "SELECT IFNULL( SUM( b.energy + IF( b.energy > 0, pb.level * 250, 0 ) ), 0 ) energy
                                 FROM orbits_buildings pb INNER JOIN buildings b ON b.id = pb.object_id
                                WHERE pb.planet_id = $place_id", 'energy' );
    break;
  }

  return $energy;
}

function get_warehouse( $place_id = -1, $place_type = -1, $free = true ) {
  global $user;

  if( $place_id == -1 ) {
    $place_id = $user->place_id;
  }

  if( $place_type == -1 ) {
    $place_type = $user->place_type;
  }

  if( $place_id == '' || $place_id == 0 ) {
    return 0;
  }

  switch( $place_type ) {
    case 0:
      $silo = db_fetch_val("SELECT IFNULL( SUM( b.warehouse + IF( b.id = 3004, p.level * 100000, 0 ) ), 0 ) silo
                              FROM orbits_buildings p INNER JOIN buildings b ON b.id = p.object_id
                             WHERE p.planet_id = $place_id", 'silo' );
    break;
    case 1:
      $type = db_fetch_val( "SELECT type FROM planets WHERE id = $place_id", 'type' );

      if( $type == 5 ) {
        $silo = 120000;
      } else {
        $silo = db_fetch_val("SELECT IFNULL( SUM( b.warehouse + IF( b.id = 38, p.level * 50000, 0 ) ), 0 ) + 500 silo
                                FROM planets_buildings p INNER JOIN buildings b ON b.id = p.object_id
                               WHERE p.planet_id = $place_id", 'silo' );
      }
    break;
  }
  if( $free ) {
    $ware = db_fetch_val( "SELECT IFNULL( SUM( o.mass * w.object_cnt ), 0 ) warehouse
                             FROM warehouse w INNER JOIN objects o ON w.object_id = o.id AND o.class IN( 1, 2, 5, 9)
                            WHERE w.place_id = $place_id AND w.place_type = $place_type AND w.object_cnt > 0", 'warehouse' );

    return ( $silo - $ware );
  } else {
    return $silo;
  }
}

function time_to_str( $seconds ) {
  $tail = $seconds;
  $d = intval( $tail / 86400 );
  $tail = $tail % 86400;
  $h = intval( $tail / 3600 );
  $tail = $tail % 3600;
  $m = intval( $tail / 60 );
  $s = $tail % 60;

  $str  = ($d>0)?"$d.":'';
  $str .= ($h<=9)?"0$h:":"$h:";
  $str .= ($m<=9)?"0$m:":"$m:";
  $str .= ($s<=9)?"0$s":$s;

  return $str;
}

function get_land_time() {
  return 10;
}

function get_gate_time() {
  return 36000 - ( get_book_level( 26 ) * 1800 ) - ( get_book_level( 39 ) * 360 );
}


function get_harvest_time() {
  return 600 - ( get_book_level( 31 ) * 48 );
}

function get_build_time( $bid ) {
    $result = db_fetch_val( "SELECT make_time FROM objects WHERE id = $bid", 'make_time' );
    $result = $result / 4;
    $level_time = ( $result / 20 ) * get_book_level( 5 );
    return round( $result - $level_time );
}

function get_mine_time( $bid ) {

  global $user;
  static $l_cache;

  if( is_array( $l_cache ) && array_key_exists( $user->uid.':'.$bid, $l_cache ) ) {
    return $l_cache[$user->uid.':'.$bid];
  }

  switch( $bid ) {
    case 23: //K
      $mine_time = 5 * 60 * 3;
    break;
    case 36: //M
      $mine_time = 7 * 60 * 3;
    break;
    case 37: //O
      $mine_time = 10 * 60 * 3;
    break;
    case 3006: //W
      $mine_time = 60 * 60 * 3;
    break;
  }

  $level_down = ( $mine_time / 20 ) * get_book_level( 2 );
  $level_up = ( ( $mine_time - $level_down ) / 10 ) * get_book_level( 15 );

  switch( $bid ) {
    case 23: //K
      $level_adv_up = ( ( $mine_time - $level_down ) / 5 ) * get_book_level( 16 );
    break;
    case 36: //M
      $level_adv_up = ( ( $mine_time - $level_down ) / 5 ) * get_book_level( 17 );
    break;
    case 37: //O
      $level_adv_up = ( ( $mine_time - $level_down ) / 5 ) * get_book_level( 18 );
    break;
    case 3006: //W
      $level_adv_up = ( ( $mine_time - $level_down ) / 5 ) * get_book_level( 19 );
    break;
  }

  $out = round( $mine_time - $level_down + $level_up + $level_adv_up );

  $l_cache[$user->uid.':'.$bid] = $out;

  return $out;
}

function get_mine_count( $bid, $ptype = 1 ) {

  global $user;
  static $l_cache;

  if( is_array( $l_cache ) && array_key_exists( $user->uid.':'.$bid.':'.$ptype, $l_cache ) ) {
    return $l_cache[$user->uid.':'.$bid.':'.$ptype];
  }

  switch( $bid ) {
    case 23: //K
    case 36: //M
    case 37: //O
      $mine_count = 10;
    break;
    case 3006: //W
      $mine_count = 1000;
    break;
  }

  if( $ptype == 5 ) {
    $mine_count *= 100;
  }

  $level_count = ( $mine_count / 10 ) * get_book_level( 15 );

  switch( $bid ) {
    case 23: //K
      $level_adv_count = ( $mine_count / 5 ) * get_book_level( 16 );
    break;
    case 36: //M
      $level_adv_count = ( $mine_count / 5 ) * get_book_level( 17 );
    break;
    case 37: //O
      $level_adv_count = ( $mine_count / 5 ) * get_book_level( 18 );
    break;
    case 3006: //W
      $level_adv_count = ( $mine_count / 5 ) * get_book_level( 19 );
    break;
  }

  $out = round( $mine_count + $level_count + $level_adv_count );
  $l_cache[$user->uid.':'.$bid.':'.$ptype] = $out;

  return $out;
}

function get_disp_time( $rid ) {
  $result = db_fetch_val( "SELECT make_time FROM objects WHERE id = $rid", 'make_time', true );
  $result = $result / 4;
  $level_time = ( $result / 20 ) * get_book_level( 3 );
  return round( $result - $level_time );
}

function get_make_time( $oid ) {
  $result = db_fetch_val( "SELECT make_time FROM objects WHERE id = $oid", 'make_time', true );
  $result = $result / 4;
  $level_time = ( $result / 20 ) * get_book_level( 6 );
  return round( $result - $level_time );
}

function get_sintez_time( $oid ) {
  $result = db_fetch_row( "SELECT make_time FROM objects WHERE id = $oid", true );
  $level_time = ( $result['make_time'] / 20 ) * get_book_level( 6 ) + ( $result['make_time'] / 25 ) * get_book_level( 25 );
  return round( $result['make_time'] - $level_time );
}

function get_lab_time( $oid, $x, $y ) {
  $item = db_fetch_row( "SELECT make_time, class FROM objects WHERE id = $oid", true );

  if( $item['class'] == 2 || $item['class'] == 9 ) {
    $item = db_fetch_row( "SELECT o.make_time * 2 make_time, o.class
                             FROM objects_sub os INNER JOIN objects o ON os.res_id = o.id AND o.class IN( 6, 7 )
                            WHERE os.object_id = $oid", true );
  }

  $real_time = $item['make_time'];
  if( $real_time > 0 ) {
    $info = get_planet_info( $x, $y );
    $real_time = ( $real_time * 2 ) - ( $real_time / 10 * $info->level );
  }

  return $real_time;
}

function get_pmove_time( $len, $speed, $uid = -1 ) {

  global $user;

  if( $uid == -1 ) {
    $uid = $user->uid;
  }

  if( $speed > 0 ) {
    $time = $len / $speed;
  } else {
    $time = 99999999;
  }

  $level_time = ( $time / 40 ) * get_book_level( 8, $uid );

  $db_titul = db_fetch_val( "SELECT titul FROM users WHERE id = $uid", 'titul', true );
  if( $db_titul == 10 || $db_titul == 21 ) {
    $titul_time = ( $time - $level_time ) / 5;
  } else {
    $titul_time = 0;
  }

  return round( $time - $level_time - $titul_time );
}

function get_smove_time( $len, $speed, $uid = -1 ) {

  global $user;

  if( $uid == -1 ) {
    $uid = $user->uid;
  }

  if( $speed > 0 ) {
    $time = $len / $speed;
  } else {
    $time = 99999999;
  }

  $level_time = ( $time / 40 ) * get_book_level( 9, $uid );

  $db_titul = db_fetch_val( "SELECT titul FROM users WHERE id = $uid", 'titul', true );
  if( $db_titul == 10 || $db_titul == 21 ) {
    $titul_time = ( $time - $level_time ) / 5;
  } else {
    $titul_time = 0;
  }

  return round( $time - $level_time - $titul_time );
}

function teach_time( $real_time ) {

  $level_time = ( $real_time / 20 ) * get_book_level( 4 );

  return round( $real_time - $level_time );
}

function send_msg( $from, $to, $message, $type, $time = null ) {
  db_safe( $from );
  db_safe( $to );
  db_safe( $message );
  db_safe( $type );
  db_safe( $time );

  if( $to == '' && $from == 1 ) {
    return;
  }

  if( $type >= 20 ) {
    $param = array( 'chat' => 0, 'mail' => 1 );
  } elseif( $to == '' ) {
    $param = array( 'chat' => 1, 'mail' => 0 );
  } else {
    $param = db_fetch_row( "SELECT chat, mail FROM users_msg_settings WHERE user_id = $to AND type = $type", true );
    if( $param['mail'] == 1 && $type == 17 ) {
      $param['mail'] = 0;
    }
  }

  if( $to == 8 || $to == 9 || $from == 8 || $from == 9 ) {
    if( $from == 8 || $from == 9 ) {
      $aliance = db_fetch_val( "SELECT aliance FROM users WHERE id = $to", 'aliance', true );
      if( $aliance > 0 ) {
        $to_all = db_fetch_array( "SELECT id FROM users WHERE aliance = $aliance", true );
        foreach( $to_all as $to_id ) {
          send_msg( 1, $to_id['id'], $message, $type, $time );
        }
      }
    }

    if( $to == 8 ) {
      $aliance = db_fetch_val( "SELECT aliance FROM users WHERE id = $from", 'aliance', true );
      if( $aliance > 0 ) {
        $to_all = db_fetch_array( "SELECT id FROM users WHERE aliance = $aliance", true );
        foreach( $to_all as $to_id ) {
          send_msg( $from, $to_id['id'], $message, $type, $time );
        }
      }
    }

    if( $to == 9 ) {
      $aliance = db_fetch_val( "SELECT aliance FROM users WHERE id = $from", 'aliance', true );
      if( $aliance > 0 ) {
        $to_id = db_fetch_val( "SELECT own FROM aliance WHERE id = $aliance", 'own', true );
        send_msg( $from, $to_id, $message, $type, $time );
      }
    }
  } else {
    if( $param['mail'] && $to ) {
      $hash = md5( $message );
      $cnt = db_fetch_val( "SELECT count(*) cnt FROM users_messages WHERE to_user = $to AND hash = '$hash'", 'cnt' );

      if( $time === null ) {
        if( $cnt == 0) {
          db_query( "INSERT INTO users_messages ( msg_date, from_user, to_user, hash, text, type ) VALUES ( NOW(), $from, $to, '$hash', '$message', $type )" );
        } else {
          $addon = t( "\nПолучено в %s", date( "Y-m-d H:i:s" ) );
          db_query( "UPDATE users_messages SET readed = 0, msg_date = NOW(), text = CONCAT( text, '$addon' ) WHERE to_user = $to AND hash = '$hash'" );
        }
      } else {
        if( $cnt == 0) {
          db_query( "INSERT INTO users_messages ( msg_date, from_user, to_user, hash, text, type ) VALUES ( '$time', $from, $to, '$hash', '$message', $type )" );
        } else {
          $addon = t( "\nПолучено в %s", $time );
          db_query( "UPDATE users_messages SET readed = 0, msg_date = '$time', text = CONCAT( text, '$addon') WHERE to_user = $to AND hash = '$hash'" );
        }
      }
    }

    if( $param['chat'] ) {
      if( $to == '' ) {
        $to = 'null';
      }

      if( $type == 7 ) {
        $message = '<font color="#00FFFF">'.$message.'</font>';
      }

      if( $time !== null ) {
        if( $from == 1 ) {
          db_query( "INSERT DELAYED INTO chat ( msgtime, user_id, to_user, text ) VALUES ( '$time', 1, $to, '$message' )" );
        } else {
          $from_name = db_fetch_val( "SELECT login FROM users WHERE id = $from", 'login' );
          db_query( "INSERT DELAYED INTO chat ( msgtime, user_id, to_user, text ) VALUES ( '$time', 1, $to, '($from_name) $message' )" );
        }
      } else {
        if( $from == 1 ) {
          db_query( "INSERT DELAYED INTO chat ( msgtime, user_id, to_user, text ) VALUES ( NOW(), 1, $to, '$message' )" );
        } else {
          $from_name = db_fetch_val( "SELECT login FROM users WHERE id = $from", 'login' );
          db_query( "INSERT DELAYED INTO chat ( msgtime, user_id, to_user, text ) VALUES ( NOW(), 1, $to, '($from_name) $message' )" );
        }
      }
    }
  }
}

function get_book_level( $book_id, $uid = -1 ) {
  global $user;

  static $l_cache;

  if( $uid == -1 ) {
    $uid = $user->uid;
  }
  db_safe( $book_id );

  if( is_array( $l_cache ) && array_key_exists( $uid.':'.$book_id, $l_cache ) ) {
    return $l_cache[$uid.':'.$book_id];
  }

  $blev = db_fetch_val( "SELECT IFNULL( ub.level, 0 ) level
                           FROM users_books ub
                          WHERE ub.user_id = $uid AND ub.book_id = $book_id", 'level', true );

  $ilev = db_fetch_val( "SELECT IFNULL( SUM( ui.level ), 0 ) level
                           FROM users_imp ui
                          WHERE ui.user_id = $uid AND ui.book_id = $book_id", 'level', true );

  $mlev = db_fetch_val( "SELECT SUM( level ) level FROM (
                                SELECT DISTINCT mt.object_id, IFNULL( mt.level, 0 ) level
                                  FROM users_medal um
                            INNER JOIN medals_type mt ON mt.object_id = um.object_id
                                 WHERE um.user_id = $uid AND mt.book_id = $book_id ) a", 'level', true );

  $alev = db_fetch_val( "SELECT ( ( IF( IFNULL( pb.level, 1 ) = 1, 0, pb.level ) ) * a.multiply ) level
                           FROM academy_build ab
                     INNER JOIN planets_buildings pb ON pb.id = ab.build_id
                     INNER JOIN academy a ON a.id = ab.type
                          WHERE ab.user_id = $uid AND a.book_id = $book_id", 'level', true );

  $out = $blev + $ilev + $mlev + $alev;

  $l_cache[$uid.':'.$book_id] = $out;

  return $out;
}

function get_abordage_level( $uid = -1 ) {

  static $l_cache;

  if( $uid == -1 ) {
    $uid = $user->uid;
  }

  if( is_array( $l_cache ) && array_key_exists( $uid, $l_cache ) ) {
    return $l_cache[$uid];
  }

  $blev = db_fetch_val( "SELECT IFNULL( ub.level, 0 ) level
                           FROM users_books ub
                          WHERE ub.user_id = $uid AND ub.book_id = 11", 'level', true );

  $ilev = db_fetch_val( "SELECT IFNULL( SUM( ui.level ), 0 ) level
                           FROM users_imp ui
                          WHERE ui.user_id = $uid AND ui.book_id = 11", 'level', true );

  $mlev = db_fetch_val( "SELECT SUM( level ) level FROM (
                                SELECT DISTINCT mt.object_id, IFNULL( mt.level, 0 ) level
                                  FROM users_medal um
                            INNER JOIN medals_type mt ON mt.object_id = um.object_id
                                 WHERE um.user_id = $uid AND mt.book_id = 11 ) a", 'level', true );

  $alevel = $blev * 3 + ( $ilev + $mlev ) * 2;
  $status = db_fetch_val( "SELECT char_status FROM users_active WHERE id = $uid", 'char_status' );

  if( $status < 0 && $status >= -10 ) {
    $alevel += 5;
  }

  if( $status < -10 && $status >= -100 ) {
    $alevel += 10;
  }

  if( $status < -100 && $status >= -1000 ) {
    $alevel += 20;
  }

  if( $status < -1000 && $status >= -10000 ) {
    $alevel += 30;
  }

  if( $status < -10000 ) {
    $alevel += 40;
  }

  $l_cache[$uid] = $alevel;

  return $alevel;
}

function get_implant_level( $imp_id, $uid = -1 ) {
  if( $uid == -1 ) {
    $uid = $user->uid;
  }

  db_safe( $imp_id );

  $ilev = db_fetch_val( "SELECT IFNULL( SUM( ui.level ), 0 ) level
                           FROM users_imp ui
                          WHERE ui.user_id = $uid AND ui.object_id = $imp_id", 'level', true );

  return $ilev;
}

function debug_it( $string ) {
  $time = date("H:i:s");
  $prn = print_r( $string, true );
  file_put_contents( "debug.log", "$time\t$prn\r\n", FILE_APPEND );
}

function debug_me( $string ) {
  global $user;

  if( $user->uid == 16 ) {
    $time = date("H:i:s");
    $prn = print_r( $string, true );
    file_put_contents( "debug.log", "$time\t$prn\r\n", FILE_APPEND );
  }
}

function get_cargo( $ship_id, $is_ship ) {
  if( isset( $ship_id ) && is_numeric( $ship_id ) ) {
    if( $is_ship ) {
      $silo = db_fetch_row( "SELECT st.cargo
                               FROM ships s
                         INNER JOIN ship_types st ON st.object_id = s.object_id
                              WHERE s.id=$ship_id" );

      $result = db_fetch_row( "SELECT SUM( o.mass * w.object_cnt ) warehouse
                                 FROM warehouse w 
                           INNER JOIN objects o ON w.object_id = o.id AND o.class IN( 1, 2, 5, 9)
                                WHERE w.place_id = $ship_id AND w.place_type = 2" );

      $ships = db_fetch_row( "SELECT SUM( o.mass ) shipmass
                                FROM ships s
                          INNER JOIN objects o ON o.id = s.object_id
                               WHERE s.place_type = 2 AND s.place_id = $ship_id" );
    } else {
      $silo = db_fetch_row( "SELECT f.cargo FROM fleets f WHERE f.id=$ship_id" );

      $result = db_fetch_row( "SELECT SUM( o.mass * w.object_cnt ) warehouse
                                 FROM warehouse w 
                           INNER JOIN objects o ON w.object_id = o.id AND o.class IN( 1, 2, 5, 9)
                           INNER JOIN ships s ON s.id = w.place_id AND w.place_type = 2
                                WHERE s.fleet_id = $ship_id" );

      $ships = db_fetch_row( "SELECT SUM( o.mass ) shipmass
                                FROM ships s
                          INNER JOIN ships s2 ON s2.place_id = s.id AND s2.place_type = 2
                          INNER JOIN objects o ON o.id = s2.object_id
                               WHERE s.fleet_id = $ship_id" );
    }

    return ( $silo['cargo'] - $result['warehouse'] - $ships['shipmass'] );
  }
}

function get_place_info( $place_id, $place_type ) {

  $info = new stdClass();

  switch( $place_type ) {
    case '':
      $info->name = '';
      $info->type = 0;
      $info->cargo = '';
      $info->place_id = 0;
      $info->place_type = 0;
      break;

    case 0: // orbit
      $place = db_fetch_row( "SELECT name, star_id, type FROM planets WHERE id = $place_id" );
      $info->name = $place['name'];
      $info->type = $place['type'];
      $info->cargo = 0;
      $info->place_id = $place['star_id'];
      $info->place_type = 4;
      break;

    case 1: // planet
      $place = db_fetch_row( "SELECT p.name, p.type, p.star_id, IFNULL( SUM( b.warehouse + IF( b.id = 38, pb.level * 50000, 0 ) ), 0 ) + 500 cargo
                                FROM planets p LEFT JOIN planets_buildings pb ON pb.planet_id = p.id
                                               LEFT JOIN buildings b ON b.id = pb.object_id
                               WHERE p.id = $place_id GROUP BY p.name" );
      $info->name = $place['name'];
      $info->type = $place['type'];
      if( $place['type'] == 5 ) {
        $info->cargo = 120000;
      } else {
        $info->cargo = $place['cargo'];
      }
      $info->place_id = $place['star_id'];
      $info->place_type = 4;
      break;

    case 2: // ship
      $place = db_fetch_row( "SELECT s.name, s.object_id, s.place_id, s.place_type, st.cargo, s.arg1, s.arg2
                                FROM ships s, ship_types st
                               WHERE s.object_id = st.object_id AND s.id = $place_id" );
      $info->name = $place['name'];
      $info->type = $place['object_id'];
      $info->cargo = $place['cargo'];
      $info->arg1 = $place['arg1'];
      $info->arg2 = $place['arg2'];
      $info->place_id = $place['place_id'];
      $info->place_type = $place['place_type'];
      break;

    case 3: // station
      $place = db_fetch_row( "SELECT ob.planet_id, o.name, ob.object_id
                                FROM orbits_buildings ob INNER JOIN objects o ON o.id = ob.object_id
                               WHERE ob.id = $place_id" );

      $silo = db_fetch_row("SELECT SUM( b.warehouse + IF( b.id = 3004, p.level * 100000, 0 ) ) silo
                              FROM orbits_buildings p INNER JOIN buildings b ON b.id = p.object_id
                             WHERE p.planet_id = ".$place['planet_id'] );

      $info->name = $place['name'];
      $info->type = $place['object_id'];
      $info->cargo = isset( $silo['silo'] ) ? $silo['silo'] : 0;
      $info->place_id = $place['planet_id'];
      $info->place_type = 0;
      break;

    case 4: // star system
      $place = db_fetch_row( "SELECT s.name, s.type FROM stars s WHERE s.id = $place_id" );

      $info->name = isset( $place['name'] ) ? $place['name'] : '';
      $info->type = isset( $place['type'] ) ? $place['type'] : '';
      $info->cargo = 0;
      $info->place_id = 0;
      $info->place_type = 0;
      break;

    case 6: // fleet
      $place = db_fetch_row( "SELECT f.name, f.place_id, f.place_type, f.cargo FROM fleets f WHERE f.id = $place_id" );

      $info->name = $place['name'];
      $info->type = 0;
      $info->cargo = $place['cargo'];
      $info->place_id = $place['place_id'];
      $info->place_type = $place['place_type'];
      break;

    case 7: // point in system
      $place = db_fetch_row( "SELECT s.name FROM stars s WHERE s.id = $place_id" );

      $info->name = $place['name'];
      $info->type = 0;
      $info->cargo = 0;
      $info->place_id = $place_id;
      $info->place_type = 4;
      break;

    default:
      $info->name = '';
      $info->type = 0;
      $info->cargo = '';
      $info->place_id = 0;
      $info->place_type = 0;
      break;
  }
  return $info;
}

function add_warehouse_item( $place_type, $place_id, $object_id, $object_cnt, $real = true, $qid = null ) {
  if( $place_id > 0 && $object_id > 0 && $object_cnt > 0 ) {
    if( $real ) {
      db_query( "INSERT INTO warehouse ( place_id,  place_type,  object_id,  object_cnt  )
                                VALUES ( $place_id, $place_type, $object_id, ".intval( $object_cnt )." )
               ON DUPLICATE KEY UPDATE object_cnt = object_cnt + ".intval( $object_cnt ) );
    } else {
      db_query( "INSERT INTO warequest ( place_id,  place_type,  object_id,  object_cnt, quest_id  )
                                VALUES ( $place_id, $place_type, $object_id, ".intval( $object_cnt ).", $qid )
               ON DUPLICATE KEY UPDATE object_cnt = object_cnt + ".intval( $object_cnt ) );
    }
  }
}

function sub_warehouse_item( $place_type, $place_id, $object_id, $object_cnt, $real = true, $qid = null ) {
  if( $place_id > 0 && $object_id > 0 && $object_cnt > 0 ) {
    if( $real ) {
      db_query( "UPDATE warehouse SET object_cnt = object_cnt - ".intval($object_cnt). 
                " WHERE object_cnt >= ".intval($object_cnt)." AND object_id = $object_id AND place_id = $place_id AND place_type = $place_type" );
    } else {
      db_query( "UPDATE warequest SET object_cnt = object_cnt - ".intval($object_cnt). 
                " WHERE object_cnt >= ".intval($object_cnt)." AND quest_id = $qid AND object_id = $object_id AND place_id = $place_id AND place_type = $place_type" );
    }
  }
}

function do_events( $all = true ) {
  $db_test = db_init();

  $h = @fopen( 'locks/events.dat', 'x' );
  if( $db_test && $h ) {
    require_once( "include/planet_events.inc" );
    require_once( "include/orbit_events.inc" );
    require_once( "include/quest_events.inc" );
    require_once( "include/char_events.inc" );
    require_once( "include/space_events.inc" );
    require_once( "include/market_events.inc" );
    require_once( "include/cleaner.inc" );
    require_once( "include/pilot_events.inc" );

    space_event_all();
    planet_event_all();
    orbit_event_all();
    quest_event_all();
    books_event_all();
    market_event_all();
    pilot_event_all();

    free_warehouse();
    free_trade_in();
    free_trade_out();
    free_defence();
    free_block();
    free_war();

    fclose( $h );
    @unlink( 'locks/events.dat' );
    $ret = 1;
  } else {
    if( file_exists( 'locks/events.dat' ) && @filemtime( 'locks/events.dat' ) + 30 < time() ) {
      @unlink( 'locks/events.dat' );
    }

    $ret = 0;
  }

  if( $all ) {
    $h = @fopen( 'locks/war_events.dat', 'x' );
    if( $db_test && $h ) {
      require_once( "include/war_events.inc" );
  
      war_event_all();
  
      fclose( $h );
      @unlink( 'locks/war_events.dat' );
      $ret = 1;
    } else {
      if( file_exists( 'locks/war_events.dat' ) && @filemtime( 'locks/war_events.dat' ) + 30 < time() ) {
        @unlink( 'locks/war_events.dat' );
      }
  
      $ret = 0;
    }
  }

  return $ret;
}

function levelUp( $level, $uid ) {

  global $user;

  $result = db_fetch_row( "SELECT u.level, u.lastlevel, t.premium, u.parent_id, u.meta_in, u.login, u.relid, substr( u.register_date, 1, 10 ) reg_date
                             FROM users u
                       INNER JOIN tutorials t ON t.level = u.lastlevel
                            WHERE u.id = $uid" );

  if( isset( $result['level'] ) && $result['level'] == $level && $result['lastlevel'] == $level ) {

    ca_message( $uid, array( 'level' => $level ) );

    if( $level == 39 ) {
      add_warehouse_item( 0, $user->planet_id, 9124, 1 );
    }

    if( $level == 7 ) {
/*
      if( $result['meta_in'] > 0 ) {
      $ext_meta_id = $result['meta_in'];
      $price_rur = '0';
      $hash = md5("'$price_rur'80347");
      $target_id = 763;
      $answ = @file_get_contents( "http://luxup.ru/extmeta/?ext_meta_id=$ext_meta_id&lx_price=$price_rur&user_id=76025&lx_price_hash=$hash&target_id=$target_id" );
      }
*/

      wasd_send( $uid );
    }

    if( $level == 41 ) {
      send_msg( 1, $uid, t( "Вы полностью закончили обучающий курс!" ), 20 );

      if( $result['meta_in'] > 0 ) {
        $ext_meta_id = $result['meta_in'];
        $price_rur = '0';
        $hash = md5("'$price_rur'80347");
        $target_id = 764;
        $answ = @file_get_contents( "http://luxup.ru/extmeta/?ext_meta_id=$ext_meta_id&lx_price=$price_rur&user_id=76025&lx_price_hash=$hash&target_id=$target_id" );
      }

      if( $result['relid'] > 0 ) {
        $result = db_fetch_row( "SELECT u.level, u.lastlevel, t.premium, u.parent_id, u.meta_in, u.login, u.relid, substr( u.register_date, 1, 10 ) reg_date
                                   FROM users u
                             INNER JOIN tutorials t ON t.level = u.lastlevel
                                  WHERE u.id = $uid" );

        $url = 'http://inetrek.com/s2s/statistic.php?type=json&partner=sharque&key=b6f0963638abc2d60cd84696a03a6562';
        $data = "[{\"uid\":$uid,\"login\":\"{$result['login']}\",\"relid\":{$result['relid']},\"date_reg\":\"{$result['reg_date']}\",\"lvl\":42,\"date_lvl\":\"".date('Y-m-d')."\"}]";

        $options = array(
          'http' => array(
            'method'  => 'POST',
            'header' => 'Content-Type: application/x-www-form-urlencoded'.PHP_EOL,
            'content' => 'data='.$data,
          ),
        );

        $context  = stream_context_create( $options );

debug_it( $url );
debug_it( $options );
        $answ = file_get_contents( $url, false, $context );
debug_it( $answ );
      }
    }

    if( $level == 34 ) {
      db_query( "UPDATE users u SET u.credits = u.credits + 10 WHERE u.id = $uid" );
      send_msg( 1, $uid, t( "Вы получаете %d конфедерат за пройденое обучение.", array( 10 ) ), 20 );

      db_query( "UPDATE users u SET u.credits = u.credits + 1 WHERE u.id = ".$result['parent_id'] );
      send_msg( 1, $result['parent_id'], t( "Приведенный вами игрок проходит обучение и вы получаете %d конфедерат.", array( 1 ) ), 20 );
    }

    if( $result['premium'] > 0 ) {
      db_query( "UPDATE users u SET u.level = u.level + 1, money = money + {$result['premium']} WHERE u.id = $uid" );
      send_msg( 1, $uid, t( "Вы удачно выполнили задание и получаете премию %d", $result['premium'] ), 15 );

    } else {
      db_query( "UPDATE users u SET u.level = u.level + 1 WHERE u.id = $uid" );
    }

    return true;
  }

  return false;
}

function setChar( $name, $level, $uid = null ) {
  global $user;

  if( $uid == null ) {
    $uid = $user->uid;
  }

  if( $level != 0 && $uid >= 15 ) {
    db_query( "UPDATE users_active SET char_$name = char_$name + $level WHERE id = $uid" );
  }
}

function getChar( $name, $uid ) {
  $result = db_fetch_val( "SELECT char_$name lev FROM users_active WHERE id = $uid", 'lev' );
  return $result;
}

function StartWar( $a_type, $a_oid, $d_type, $d_oid, $fire_time = null, $from_id = 1 ) {

  if( $a_type === null || !$a_oid || $d_type === null || !$d_oid ) {
    return;
  }

  $inwar = db_fetch_val( "SELECT id
                            FROM war_events
                           WHERE a_object_id = $a_oid AND a_type = $a_type AND d_object_id = $d_oid AND d_type = $d_type", 'id' );

  if( $inwar ) {
    return;
  }

  $inwar = db_fetch_val( "SELECT id
                            FROM war_events
                           WHERE a_object_id = $d_oid AND a_type = $d_type AND d_object_id = $a_oid AND d_type = $a_type", 'id' );

  if( $inwar ) {
    return;
  }

  $a_stat = '';
  switch( $a_type ) {
    case 0:
      $a_row = db_fetch_row( "SELECT s.user_id, s.guard, st.corsar, s.place_type, s.place_id, s.arg1, s.arg2, s.group
                                FROM ships s
                          INNER JOIN ship_types st ON st.object_id = s.object_id
                               WHERE s.id = $a_oid" );

      $a_corsar = $a_row['corsar'];
      $auser = $a_row['user_id'];
      $group = $a_row['group'];

      $stat = db_fetch_row( "SELECT o.name FROM ships s INNER JOIN objects o ON s.object_id = o.id WHERE s.id = $a_oid" );

      $a_stat = $stat['name'];

      $aconf = db_fetch_row( "SELECT st.w_power * IF( st.w_count, st.w_count, 1 ) power, st.shield
                                FROM ships s
                          INNER JOIN ship_types st ON st.object_id = s.object_id
                               WHERE s.id = $a_oid" );

      $drones = db_fetch_array( "SELECT w.object_id, w.object_cnt, st.shield, st.code, st.object_id type
                                   FROM warehouse w
                             INNER JOIN ship_types st ON st.conserv_id = w.object_id
                                  WHERE w.object_id IN( 9473 ) AND w.place_type = 2 AND w.place_id = $a_oid" );

      foreach( $drones as $line ) {
        $max_cnt = ( 1 + get_book_level( 35, $auser ) ) * 3;
        $dr_cnt = $line['object_cnt'] > $max_cnt ? $max_cnt : $line['object_cnt'];

        if( $dr_cnt > 0 ) {
          sub_warehouse_item( 2, $a_oid, $line['object_id'], $dr_cnt );

          if( $dr_cnt > 1 ) {
            if( $a_row['place_type'] == 7 || $a_row['place_type'] == 8 ) {
              db_query( "INSERT INTO fleets ( name,                                `group`, user_id,             place_type,             place_id,             arg1,             arg2 ) 
                                     VALUES ( '{$line['code']}-{$a_row['name']}', '$group',  $auser, {$a_row['place_type']}, {$a_row['place_id']}, {$a_row['arg1']}, {$a_row['arg2']} )" );
            } else {
              db_query( "INSERT INTO fleets ( name,                                `group`, user_id,             place_type,             place_id, arg1, arg2 ) 
                                     VALUES ( '{$line['code']}-{$a_row['name']}', '$group',  $auser, {$a_row['place_type']}, {$a_row['place_id']}, null, null )" );
            }
            $fleet_id = mysql_insert_id();
          } else {
            $fleet_id = 'null';
          }

          while( $dr_cnt ) {
            if( $a_row['place_type'] == 7 || $a_row['place_type'] == 8 ) {
              db_query( "INSERT INTO ships ( fleet_id,        object_id,  `group`,             place_id,             place_type,               arg1,               arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '$group', {$a_row['place_id']}, {$a_row['place_type']}, '{$a_row['arg1']}', '{$a_row['arg2']}',  $auser, {$line['shield']} )" );
            } else {
              db_query( "INSERT INTO ships (  fleet_id,       object_id,  `group`,             place_id,             place_type, arg1, arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '$group', {$a_row['place_id']}, {$a_row['place_type']}, null, null,  $auser, {$line['shield']} )" );
            }

            $ship_id = mysql_insert_id();
            db_query( "UPDATE ships SET name='{$line['code']}-$ship_id-$a_oid' WHERE id=$ship_id" );
            $dr_cnt--;
          }

          if( $fleet_id != 'null' ) {
            update_fleet( $fleet_id );
            StartWar( 1, $fleet_id, $d_type, $d_oid, $fire_time, $from_id );
          } else {
            StartWar( 0, $ship_id, $d_type, $d_oid, $fire_time, $from_id );
          }
        }
      }
      break;

    case 1:
      $a_row = db_fetch_row( "SELECT f.user_id, f.guard, f.place_type, f.place_id, f.arg1, f.arg2, f.corsar
                                FROM fleets f
                               WHERE f.id = $a_oid" );

      $a_corsar = $a_row['corsar'];
      $auser = $a_row['user_id'];

      $res = db_fetch_array( "SELECT o.name, count(*) cnt
                                FROM ships s
                          INNER JOIN objects o ON s.object_id = o.id
                               WHERE s.fleet_id = $a_oid
                            GROUP BY s.object_id" );

      $aconf = db_fetch_row( "SELECT SUM( st.w_power * IF( st.w_count, st.w_count, 1 ) ) power, SUM( st.shield ) shield
                                FROM ships s
                          INNER JOIN ship_types st ON st.object_id = s.object_id
                               WHERE s.fleet_id = $a_oid" );

      foreach( $res as $item ) {
        $a_stat .= ($a_stat?', ':'').$item['name'].' ('.$item['cnt'].')';
      }

      $drones = db_fetch_array( "SELECT w.object_id, w.object_cnt, st.shield, st.code, st.object_id type, s.group, s.name, s.id
                                   FROM warehouse w
                             INNER JOIN ships s ON s.id = w.place_id
                             INNER JOIN ship_types st ON st.conserv_id = w.object_id
                                  WHERE w.object_id IN( 9473 ) AND w.place_type = 2 AND s.fleet_id = $a_oid" );
      foreach( $drones as $line ) {
        $max_cnt = ( 1 + get_book_level( 35, $auser ) ) * 3;
        $dr_cnt = $line['object_cnt'] > $max_cnt ? $max_cnt : $line['object_cnt'];

        if( $dr_cnt > 0 ) {
          sub_warehouse_item( 2, $line['id'], $line['object_id'], $dr_cnt );

          if( $dr_cnt > 1 ) {
            if( $a_row['place_type'] == 7 || $a_row['place_type'] == 8 ) {
              db_query( "INSERT INTO fleets ( name,                                         `group`, user_id,             place_type,             place_id,             arg1,             arg2 ) 
                                     VALUES ( '{$line['code']}-{$line['name']}', '{$line['group']}',  $auser, {$a_row['place_type']}, {$a_row['place_id']}, {$a_row['arg1']}, {$a_row['arg2']} )" );
            } else {
              db_query( "INSERT INTO fleets ( name,                                         `group`, user_id,             place_type,             place_id, arg1, arg2 ) 
                                     VALUES ( '{$line['code']}-{$line['name']}', '{$line['group']}',  $auser, {$a_row['place_type']}, {$a_row['place_id']}, null, null )" );
            }
            $fleet_id = mysql_insert_id();
          } else {
            $fleet_id = 'null';
          }

          while( $dr_cnt ) {
            if( $a_row['place_type'] == 7 || $a_row['place_type'] == 8 ) {
              db_query( "INSERT INTO ships ( fleet_id,        object_id,            `group`,             place_id,             place_type,               arg1,               arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '{$line['group']}', {$a_row['place_id']}, {$a_row['place_type']}, '{$a_row['arg1']}', '{$a_row['arg2']}',  $auser, {$line['shield']} )" );
            } else {
              db_query( "INSERT INTO ships (  fleet_id,       object_id,            `group`,             place_id,             place_type, arg1, arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '{$line['group']}', {$a_row['place_id']}, {$a_row['place_type']}, null, null,  $auser, {$line['shield']} )" );
            }

            $ship_id = mysql_insert_id();
            db_query( "UPDATE ships SET name='{$line['code']}-$ship_id-{$line['id']}' WHERE id=$ship_id" );
            $dr_cnt--;
          }

          if( $fleet_id != 'null' ) {
            update_fleet( $fleet_id );
            StartWar( 1, $fleet_id, $a_type, $a_oid, $fire_time, $from_id );
          } else {
            StartWar( 0, $ship_id, $a_type, $a_oid, $fire_time, $from_id );
          }
        }
      }
      break;
  }

  if( !is_numeric( $auser ) || $auser == 0 ) {
    return;
  }

  $ast = get_book_level( 13, $auser );
  $ata = get_book_level( 12, $auser );

  $d_stat = '';
  switch( $d_type ) {
    case 0:
      $d_row = db_fetch_row( "SELECT s.user_id, s.guard, st.corsar, s.place_type, s.place_id, s.arg1, s.arg2, s.group, s.name
                                FROM ships s
                          INNER JOIN ship_types st ON st.object_id = s.object_id
                               WHERE s.id = $d_oid" );

      $d_corsar = isset( $d_row['corsar'] ) ? $d_row['corsar'] : 0;
      $duser = db_fetch_val( "SELECT s.user_id FROM ships s WHERE s.id = $d_oid", 'user_id' );
      $duser = $duser === null ? 10 : $duser;
      $group = $d_row['group'];

      $stat = db_fetch_row( "SELECT o.name FROM ships s INNER JOIN objects o ON s.object_id = o.id WHERE s.id = $d_oid" );

      $d_stat = $stat['name'];

      $dconf = db_fetch_row( "SELECT st.w_power * IF( st.w_count, st.w_count, 1 ) power, st.shield
                                FROM ships s
                          INNER JOIN ship_types st ON st.object_id = s.object_id
                               WHERE s.id = $d_oid" );

      $drones = db_fetch_array( "SELECT w.object_id, w.object_cnt, st.shield, st.code, st.object_id type
                                   FROM warehouse w
                             INNER JOIN ship_types st ON st.conserv_id = w.object_id
                                  WHERE w.object_id IN( 9473 ) AND w.place_type = 2 AND w.place_id = $d_oid" );
      foreach( $drones as $line ) {
        $max_cnt = ( 1 + get_book_level( 35, $duser ) ) * 3;
        $dr_cnt = $line['object_cnt'] > $max_cnt ? $max_cnt : $line['object_cnt'];

        if( $dr_cnt > 0 ) {
          sub_warehouse_item( 2, $d_oid, $line['object_id'], $dr_cnt );

          if( $dr_cnt > 1 ) {
            if( $d_row['place_type'] == 7 || $d_row['place_type'] == 8 ) {
              db_query( "INSERT INTO fleets ( name,                                `group`, user_id,             place_type,             place_id,             arg1,             arg2 ) 
                                     VALUES ( '{$line['code']}-{$d_row['name']}', '$group',  $duser, {$d_row['place_type']}, {$d_row['place_id']}, {$d_row['arg1']}, {$d_row['arg2']} )" );
            } else {
              db_query( "INSERT INTO fleets ( name,                                `group`, user_id,             place_type,             place_id, arg1, arg2 ) 
                                     VALUES ( '{$line['code']}-{$d_row['name']}', '$group',  $duser, {$d_row['place_type']}, {$d_row['place_id']}, null, null )" );
            }
            $fleet_id = mysql_insert_id();
          } else {
            $fleet_id = 'null';
          }

          while( $dr_cnt ) {
            if( $d_row['place_type'] == 7 || $d_row['place_type'] == 8 ) {
              db_query( "INSERT INTO ships ( fleet_id,        object_id,  `group`,             place_id,             place_type,               arg1,               arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '$group', {$d_row['place_id']}, {$d_row['place_type']}, '{$d_row['arg1']}', '{$d_row['arg2']}',  $duser, {$line['shield']} )" );
            } else {
              db_query( "INSERT INTO ships (  fleet_id,       object_id,  `group`,             place_id,             place_type, arg1, arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '$group', {$d_row['place_id']}, {$d_row['place_type']}, null, null,  $duser, {$line['shield']} )" );
            }

            $ship_id = mysql_insert_id();
            db_query( "UPDATE ships SET name='{$line['code']}-$ship_id' WHERE id=$ship_id" );
            $dr_cnt--;
          }

          if( $fleet_id != 'null' ) {
            update_fleet( $fleet_id );
            StartWar( 1, $fleet_id, $a_type, $a_oid, $fire_time, $from_id );
          } else {
            StartWar( 0, $ship_id, $a_type, $a_oid, $fire_time, $from_id );
          }
        }
      }
      break;

    case 1:
      $d_row = db_fetch_row( "SELECT f.user_id, f.guard, f.place_type, f.place_id, f.arg1, f.arg2, f.corsar
                                FROM fleets f
                               WHERE f.id = $d_oid" );

      $d_corsar = isset( $d_row['corsar'] ) ? $d_row['corsar'] : 0;
      $duser = db_fetch_val( "SELECT f.user_id FROM fleets f WHERE f.id = $d_oid", 'user_id' );
      $duser = $duser === null ? 10 : $duser;

      $res = db_fetch_array( "SELECT o.name, count(*) cnt
                                FROM ships s
                          INNER JOIN objects o ON s.object_id = o.id
                               WHERE s.fleet_id = $d_oid
                            GROUP BY s.object_id" );

      $dconf = db_fetch_row( "SELECT SUM( st.w_power * IF( st.w_count, st.w_count, 1 ) ) power, SUM( st.shield ) shield
                                FROM ships s
                          INNER JOIN ship_types st ON st.object_id = s.object_id
                               WHERE s.fleet_id = $d_oid" );

      foreach( $res as $item ) {
        $d_stat .= ($d_stat?', ':'').$item['name'].' ('.$item['cnt'].')';
      }

      $drones = db_fetch_array( "SELECT w.object_id, w.object_cnt, st.shield, st.code, st.object_id type, s.group, s.name, s.id
                                   FROM warehouse w
                             INNER JOIN ships s ON s.id = w.place_id
                             INNER JOIN ship_types st ON st.conserv_id = w.object_id
                                  WHERE w.object_id IN( 9473 ) AND w.place_type = 2 AND s.fleet_id = $d_oid" );
      foreach( $drones as $line ) {
        $max_cnt = ( 1 + get_book_level( 35, $duser ) ) * 3;
        $dr_cnt = $line['object_cnt'] > $max_cnt ? $max_cnt : $line['object_cnt'];

        if( $dr_cnt > 0 ) {
          sub_warehouse_item( 2, $line['id'], $line['object_id'], $dr_cnt );

          if( $dr_cnt > 1 ) {
            if( $d_row['place_type'] == 7 || $d_row['place_type'] == 8 ) {
              db_query( "INSERT INTO fleets ( name,                                         `group`, user_id,             place_type,             place_id,             arg1,             arg2 ) 
                                     VALUES ( '{$line['code']}-{$line['name']}', '{$line['group']}',  $duser, {$d_row['place_type']}, {$d_row['place_id']}, {$d_row['arg1']}, {$d_row['arg2']} )" );
            } else {
              db_query( "INSERT INTO fleets ( name,                                         `group`, user_id,             place_type,             place_id, arg1, arg2 ) 
                                     VALUES ( '{$line['code']}-{$line['name']}', '{$line['group']}',  $duser, {$d_row['place_type']}, {$d_row['place_id']}, null, null )" );
            }
            $fleet_id = mysql_insert_id();
          } else {
            $fleet_id = 'null';
          }

          while( $dr_cnt ) {
            if( $d_row['place_type'] == 7 || $d_row['place_type'] == 8 ) {
              db_query( "INSERT INTO ships ( fleet_id,        object_id,            `group`,             place_id,             place_type,               arg1,               arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '{$line['group']}', {$d_row['place_id']}, {$d_row['place_type']}, '{$d_row['arg1']}', '{$d_row['arg2']}',  $duser, {$line['shield']} )" );
            } else {
              db_query( "INSERT INTO ships (  fleet_id,       object_id,            `group`,             place_id,             place_type, arg1, arg2, user_id,            shield )
                                    VALUES ( $fleet_id, {$line['type']}, '{$line['group']}', {$d_row['place_id']}, {$d_row['place_type']}, null, null,  $duser, {$line['shield']} )" );
            }

            $ship_id = mysql_insert_id();
            db_query( "UPDATE ships SET name='{$line['code']}-$ship_id' WHERE id=$ship_id" );
            $dr_cnt--;
          }

          if( $fleet_id != 'null' ) {
            update_fleet( $fleet_id );
            StartWar( 1, $fleet_id, $a_type, $a_oid, $fire_time, $from_id );
          } else {
            StartWar( 0, $ship_id, $a_type, $a_oid, $fire_time, $from_id );
          }
        }
      }
      break;

    case 2:
      $duser = db_fetch_val( "SELECT d.user_id
                                FROM defence d
                          INNER JOIN planets_buildings pb ON pb.object_id IN (27, 28, 29, 30, 31) AND pb.planet_id = d.place_id
                               WHERE d.place_type = 1 AND d.place_id = $d_oid", 'user_id' );
      $d_corsar = 0;

      $res = db_fetch_array( "SELECT o.name, count(*) cnt, sum( pb.shield ) shield
                                FROM planets_buildings pb
                          INNER JOIN objects o ON pb.object_id = o.id
                               WHERE pb.object_id IN (27, 28, 29, 30, 31) AND pb.planet_id = $d_oid
                            GROUP BY pb.object_id" );

      foreach( $res as $item ) {       
        $d_stat .= ($d_stat?', ':'').$item['name'].' ('.$item['cnt'].') щит '.$item['shield'];
      }
      break;

    case 3:
      $duser = db_fetch_val( "SELECT d.user_id
                                FROM defence d
                          INNER JOIN orbits_buildings ob ON ob.object_id IN (3007, 3008, 3009) AND ob.planet_id = d.place_id
                               WHERE d.place_type = 0 AND d.place_id = $d_oid", 'user_id' );
      $d_corsar = 0;

      $res = db_fetch_array( "SELECT o.name, count(*) cnt, sum( ob.shield ) shield
                                FROM orbits_buildings ob
                          INNER JOIN objects o ON ob.object_id = o.id
                               WHERE ob.object_id IN (3007, 3008, 3009) AND ob.planet_id = $d_oid
                            GROUP BY ob.object_id" );

      $dconf = db_fetch_row( "SELECT sum( b.atack * ob.level ) power, sum( ob.shield ) shield
                                FROM orbits_buildings ob
                          INNER JOIN buildings b ON b.id = ob.object_id
                               WHERE ob.object_id IN (3007, 3008, 3009) AND ob.planet_id = $d_oid" );

      foreach( $res as $item ) {
        $d_stat .= ($d_stat?', ':'').$item['name'].' ('.$item['cnt'].') щит '.$item['shield'];
      }
      break;
  }

  if( !is_numeric( $duser ) || $duser == 0 ) {
    return;
  }

  if( $auser == $duser ) {
    return;
  }

  if( ( $a_type == 0 || $a_type == 1 ) && ( $a_row['place_type'] == 0 || $a_row['place_type'] == 1 ) && $a_row['place_id'] ) {
    $planet_type = db_fetch_val( "SELECT type FROM planets WHERE id = {$a_row['place_id']}" );

    if( $planet_type == 1 ) {
      return;
    }
  }

  if( ( $d_type == 0 || $d_type == 1 ) && ( $d_row['place_type'] == 0 || $d_row['place_type'] == 1 ) && $d_row['place_id'] ) {
    $planet_type = db_fetch_val( "SELECT type FROM planets WHERE id = {$d_row['place_id']}" );

    if( $planet_type == 1 ) {
      return;
    }
  }

  if( $duser != 10 && $duser && ( $d_type == 0 || $d_type == 1 ) && ( $d_row['place_type'] == 0 || $d_row['place_type'] == 1 ) ) {
    $defence = db_fetch_val( "SELECT IFNULL( d.status, 0 ) status
                                FROM defence d
                               WHERE d.place_id = {$d_row['place_id']} AND
                                     d.place_type = {$d_row['place_type']} AND
                                     d.user_id = $duser", 'status' );
    if( $defence > 0 ) {
      if( $d_row['place_type'] == 1 ) {
        StartWar( $a_type, $a_oid, 2, $d_row['place_id'], $fire_time, $from_id );
      } else {
        StartWar( $a_type, $a_oid, 3, $d_row['place_id'], $fire_time, $from_id );
      }
    }
  }

  $dst = get_book_level( 13, $duser );
  $dta = get_book_level( 12, $duser );

  $astat = getChar( 'status', $auser );
  $dstat = getChar( 'status', $duser );

  $def = db_fetch_val( "SELECT count(*) FROM defence d WHERE d.place_type = 3 AND d.place_id = $d_oid", 'id' );

  if( ( $def && ( $a_type == 0 || $a_type == 1 ) && $d_type == 3 && $dstat >= 0 ) && 
      ( $dconf['power'] == 0 || ( $aconf['power'] > 0 && ( $dconf['shield'] / $aconf['power'] <= $aconf['shield'] / $dconf['power'] ) ) )
  ) {
    $need = round( $aconf['shield'] / 10000 );

    if( $need > 0 ) {
      db_query( "INSERT INTO fleets (                  name, user_id, place_type, place_id, arg1, arg2, guard )
                             VALUES ( ".t('Конфедерация').",       5,          0,   $d_oid, null, null, 2     )" );
      $fleet_id = mysql_insert_id();

      for( $i=0; $i < $need; $i++ ) {
        db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id, name, arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                     (     9485,   $d_oid,          0,       5, 'ГП', null, null, $fleet_id, 25000,     0,     2)" );
        $ship_id = mysql_insert_id();
        add_warehouse_item( 2, $ship_id, 9217, 32 );
      }

      update_fleet( $fleet_id );
      StartWar( 1, $fleet_id, $a_type, $a_oid, $fire_time, $from_id );

      db_query( "DELETE FROM defence WHERE place_type = 3 AND place_id = $d_oid" );
    }
  }

  if( $a_corsar === null ) {
    $a_corsar = 0;
  }

  if( $d_corsar === null ) {
    $d_corsar = 0;
  }

  if( $auser >= 15 && $duser >= 15 && $a_row['guard'] == 0 && $a_corsar == 0 && $d_corsar == 0 ) {

    $corr = abs( 15000 - abs( $auser ) ) / 150;
    if( $dstat >= 0 ) {
      $diff = round( ( $dstat + $corr ) / $corr ) * -1;
    } else {
      $diff = round( $dstat / $corr ) * -1;
    }

    if( $astat + $diff > 15000 ) {
      $diff = 15000 - $astat;
    }
    if( $astat + $diff < -15000 ) {
      $diff = -15000 - $astat;
    }

    setChar( 'status', $diff, $auser );
  }

  if( $auser >= 15 && $duser >= 15 && $astat < 0 && $a_corsar == 0 && $d_corsar == 0 ) {

    $corr = abs( 15000 - abs( $duser ) ) / 150;
    $diff = round( $astat / $corr ) * -1;

    if( $dstat + $diff > 15000 ) {
      $diff = 15000 - $dstat;
    }
    if( $dstat + $diff < -15000 ) {
      $diff = -15000 - $dstat;
    }

    setChar( 'status', $diff, $duser );
  }

  if( $from_id == 1 ) {
    if( $duser != 10 && $duser != $auser && $a_corsar == 0 && $d_corsar == 0 ) {
      db_query( "DELETE FROM friend WHERE user_id = $duser AND friend_id = $auser" );
      db_query( "DELETE FROM friend WHERE user_id = $auser AND friend_id = $duser" );
      db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $duser, $auser )" );
      db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $auser, $duser )" );
    }
  } else {
    if( $a_corsar == 0 && $d_corsar == 0 ) {
      $aown = db_fetch_val( "SELECT a.own
                               FROM users u
                         INNER JOIN aliance a ON a.id = u.aliance
                              WHERE u.id = ".$auser, 'own' );

      $down = db_fetch_val( "SELECT a.own
                               FROM users u
                         INNER JOIN aliance a ON a.id = u.aliance
                              WHERE u.id = ".$duser, 'own' );

      if( $duser && $auser && $duser != $auser ) {
        db_query( "DELETE FROM friend WHERE user_id = $duser AND friend_id = $auser" );
        db_query( "DELETE FROM friend WHERE user_id = $auser AND friend_id = $duser" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $duser, $auser )" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $auser, $duser )" );
      }

      if( $down && $auser && $down != $auser ) {
        db_query( "DELETE FROM friend WHERE user_id = $down AND friend_id = $auser" );
        db_query( "DELETE FROM friend WHERE user_id = $auser AND friend_id = $down" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $down, $auser )" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $auser, $down )" );
      }
  
      if( $duser && $aown && $duser != $aown ) {
        db_query( "DELETE FROM friend WHERE user_id = $duser AND friend_id = $aown" );
        db_query( "DELETE FROM friend WHERE user_id = $aown AND friend_id = $duser" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $duser, $aown )" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $aown, $duser )" );
      }
  
      if( $down && $aown && $down != $aown ) {
        db_query( "DELETE FROM friend WHERE user_id = $down AND friend_id = $aown" );
        db_query( "DELETE FROM friend WHERE user_id = $aown AND friend_id = $down" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $down, $aown )" );
        db_query( "INSERT IGNORE INTO foe (user_id, foe_id) VALUES ( $aown, $down )" );
      }
    }
  }

  switch( $d_type ) {
    case 0:
      $place = db_fetch_row( "SELECT s.place_type, s.place_id, s.arg1, s.arg2 FROM ships s WHERE s.id = ".$d_oid );
      break;

    case 1:
      $place = db_fetch_row( "SELECT f.place_type, f.place_id, f.arg1, f.arg2 FROM fleets f WHERE f.id = ".$d_oid );
      break;

    case 2:
      $place = array(
        'place_type' => 1,
        'place_id' => $d_oid,
      );
      break;

    case 3:
      $place = array(
        'place_type' => 0,
        'place_id' => $d_oid,
      );
      break;
  }

  if( !isset( $place['place_id'] ) || $place['place_id'] == '' ) {
    $place['place_id'] = 'null';
    $place['place_type'] = 'null';
  }

  switch( $place['place_type'] ) {
    case 0:
      $names = db_fetch_row( "SELECT p.name pname, s.name sname, s.id sid
                                FROM planets p
                          INNER JOIN stars s ON s.id = p.star_id
                               WHERE p.id = ".$place['place_id'] );

      $place_name = t( 'Орбита %s - %s', array( $names['pname'], $names['sname'] ) );

      if( $auser != 3 && $duser != 3 ) {
        user_report( $names['sid'], $auser, 100, t( "Астрономы зафиксировали вспышки орудийных выстрелов и взрывов на орбите планеты <font color=\"#FF0000\">%s - %s</font>.", array( $names['pname'], $names['sname'] ) ) );
      }
      break;

    case 1:
      $names = db_fetch_row( "SELECT p.name pname, s.name sname, s.id sid
                                FROM planets p
                          INNER JOIN stars s ON s.id = p.star_id
                               WHERE p.id = ".$place['place_id'] );

      $place_name = t( 'Планета %s - %s', array( $names['pname'], $names['sname'] ) );

      if( $auser != 3 && $duser != 3 ) {
        user_report( $names['sid'], $auser, 50, t( "Астрономы зафиксировали яркие вспышки взрывов на планете <font color=\"#FF0000\">%s - %s</font>.", array( $names['pname'], $names['sname'] ) ) );
      }
      break;

    case 7:
      $names = db_fetch_row( "SELECT s.name sname, s.id sid
                                FROM stars s
                               WHERE s.id = ".$place['place_id'] );

      $place_name = t( 'Система %s %d:%d', array( $names['sname'], $place['arg1'], $place['arg2'] ) );

      user_report( $names['sid'], $auser, 200, t( "Астрономы зафиксировали излучение, по частоте совпадающее с орудийными выстрелами. Излучение исходит из системы <font color=\"#FF0000\">%s точка %d:%d</font>.", array( $names['sname'], $place['arg1'], $place['arg2'] ) ) );
      break;

    case 8:
      $place_name = t( 'Гиперпространство %d:%d', array( $place['arg1'], $place['arg2'] ) );

      if( $auser != 3 && $duser != 3 ) {
        user_report( 0, $auser, 200, t( "Астрономы зафиксировали аномальное излучение из гиперпространства, скорее всего это выстрелы. Точка излучения <font color=\"#FF0000\">%d:%d</font>.", array( $place['arg1'], $place['arg2'] ) ), $place['arg1'], $place['arg2'] );
      }
      break;

    default:
      $place_name = t( 'Полное уничтожение, координаты не определены' );
      break;
  }

  $from_id = 1;
  $all = db_fetch_val( "SELECT aliance FROM users WHERE id = $auser", 'aliance' );
  if( $all != 0 && $a_corsar == 0 ) {
    $from_id = 8;
  }

  switch( $a_type ) {
    case 0:
      send_msg( $from_id, $auser, t( "Ваш корабль %s атаковал %s координаты боя %s", array( $a_stat, $d_stat, $place_name ) ), 18, $fire_time );
      break;

    case 1:
      send_msg( $from_id, $auser, t( "Ваш флот %s атаковал %s координаты боя %s", array( $a_stat, $d_stat, $place_name ) ), 18, $fire_time );
      break;
  }
  $from_id = 1;

  $all = db_fetch_val( "SELECT aliance FROM users WHERE id = $duser", 'aliance' );
  if( $all != 0 && $d_corsar == 0 ) {
    $from_id = 8;
  }

  if( $auser > 14 && $place['place_type'] == 8 && ( ( $a_type == 0 || $a_type == 1 ) && ( $d_type == 0 || $d_type == 1 ) && $duser == 4 ) && 
      ( $dconf['power'] == 0 || ( $aconf['power'] > 0 && ( $dconf['shield'] / $aconf['power'] <= $aconf['shield'] / $dconf['power'] ) ) )
  ) {
    $foe = db_fetch_array( "SELECT fo.user_id
                              FROM foe fo
                        INNER JOIN users_active ua ON ua.id = fo.user_id
                             WHERE UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(ua.lastlogin) <= 60 AND fo.foe_id = $auser" );
    if( count( $foe ) ) {
      $fname = db_fetch_val( "SELECT login FROM users WHERE id = $auser", 'login' );
      foreach( $foe as $foe_id ) {
        send_msg( 4, $foe_id['user_id'], t( "Вас приветствуют пираты, у нас было недопонимание, однако сейчас мы ведем неравный бой с вашим врагом %s, и просим вас помочь нам с нашим общим врагом.\nКоординаты боя: %s\nОбщий щит противника: %s\nОбщая сила орудий: %s\n", array( $fname, $place_name, $aconf['shield'], $aconf['power'] ) ), 20 );
      }
      switch( $d_type ) {
        case 0:
          db_query( "UPDATE ships SET guard = 0 WHERE id = $d_oid" );
          break;

        case 1:
          db_query( "UPDATE fleets SET guard = 0 WHERE id = $d_oid" );
          db_query( "UPDATE ships SET guard = 0 WHERE fleet_id = $d_oid" );
          break;
      }
    }
  }

  if( $duser > 14 && $place['place_type'] == 8 && ( ( $a_type == 0 || $a_type == 1 ) && ( $d_type == 0 || $d_type == 1 ) && $auser == 4 ) && 
      ( $aconf['power'] == 0 || ( $dconf['power'] > 0 && ( $aconf['shield'] / $dconf['power'] <= $dconf['shield'] / $aconf['power'] ) ) )
  ) {
    $foe = db_fetch_array( "SELECT fo.user_id
                              FROM foe fo
                        INNER JOIN users_active ua ON ua.id = fo.user_id
                             WHERE UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(ua.lastlogin) <= 60 AND fo.foe_id = $duser" );
    if( count( $foe ) ) {
      $fname = db_fetch_val( "SELECT login FROM users WHERE id = $duser", 'login' );
      foreach( $foe as $foe_id ) {
        send_msg( 4, $foe_id['user_id'], t( "Вас приветствуют пираты, у нас было недопонимание, однако сейчас мы ведем неравный бой с вашим врагом %s, и просим вас помочь нам с нашим общим врагом.\nКоординаты боя: %s\nОбщий щит противника: %s\nОбщая сила орудий: %s\n", array( $fname, $place_name, $dconf['shield'], $dconf['power'] ) ), 20 );
      }

      switch( $a_type ) {
        case 0:
          db_query( "UPDATE ships SET guard = 0 WHERE id = $a_oid" );
          break;

        case 1:
          db_query( "UPDATE fleets SET guard = 0 WHERE id = $a_oid" );
          db_query( "UPDATE ships SET guard = 0 WHERE fleet_id = $a_oid" );
          break;
      }
    }
  }

  switch( $d_type ) {
    case 0:
      send_msg( $from_id, $duser, t( "На корабль %s напал %s координаты боя %s", array( $d_stat, $a_stat, $place_name ) ), 18, $fire_time );
      break;

    case 1:
      send_msg( $from_id, $duser, t( "На флот %s напал %s координаты боя %s", array( $d_stat, $a_stat, $place_name ) ), 18, $fire_time );
      break;

    case 2:
      send_msg( $from_id, $duser, t( "На планету %s напал %s координаты боя %s", array( $d_stat, $a_stat, $place_name ) ), 18, $fire_time );
      break;

    case 3:
      send_msg( $from_id, $duser, t( "На орбиту %s напал %s координаты боя %s", array( $d_stat, $a_stat, $place_name ) ), 18, $fire_time );
      break;
  }

  $pre_hash = 'none';

  switch( $d_type ) {
    case 0:
    case 1:
      switch( $d_row['place_type'] ) {
        case 0:
        case 1:
          $pre_hash = 'orb.'.$d_row['place_id'];
          break;
        case 7:
          $pre_hash = 'pnt.'.$d_row['place_id'].'.'.$d_row['arg1'].'.'.$d_row['arg2'];
          break;
        case 8:
          $pre_hash = 'hpr.'.$d_row['place_id'].'.'.$d_row['arg1'].'.'.$d_row['arg2'];
          break;
      }
      break;

    case 2:
      $pre_hash = 'bld_pln.'.$d_oid;
      break;

    case 3:
      $pre_hash = 'bld_orb.'.$d_oid;
      break;
  }

  db_query( "INSERT IGNORE INTO war_places ( place ) VALUES ( '$pre_hash' )" );

  $place_hash = mysql_insert_id();
  if( !$place_hash ) {
    $place_hash = db_fetch_val( "SELECT id FROM war_places WHERE place = '$pre_hash'" );
  }

  while( !( $h = @fopen( 'locks/war_events.dat', 'x' ) ) ) {
    usleep( 10 );
  }

  if( $fire_time ) {
    db_query( "INSERT IGNORE INTO war_events ( fire_time,    place_hash,  a_user_id, a_corsar,  a_object_id, a_type,  a_strateg, a_tactic, d_user_id, d_corsar,  d_object_id, d_type,  a_stat,    d_stat,    d_strateg, d_tactic )
                               VALUES ( '$fire_time', $place_hash, $auser,    $a_corsar, $a_oid     , $a_type, $ast     , $ata    , $duser   , $d_corsar, $d_oid     , $d_type, '$a_stat', '$d_stat', $dst     , $dta )" );
  } else {
    db_query( "INSERT IGNORE INTO war_events ( fire_time, place_hash,  a_user_id, a_corsar,  a_object_id, a_type,  a_strateg, a_tactic, d_user_id, d_corsar,  d_object_id, d_type,  a_stat,    d_stat,    d_strateg, d_tactic )
                               VALUES ( NOW()    , $place_hash, $auser,    $a_corsar, $a_oid     , $a_type, $ast     , $ata    , $duser   , $d_corsar, $d_oid     , $d_type, '$a_stat', '$d_stat', $dst     , $dta )" );
  }
  $war_id = mysql_insert_id();

  if( $war_id ) {
    switch( $a_type ) {
      case 0:
        db_query( "UPDATE ships  SET inwar = $war_id WHERE id = $a_oid" );
  
        db_query( "INSERT IGNORE INTO ships_war SELECT * FROM ships WHERE id = $a_oid" );
        break;
      case 1:
        db_query( "UPDATE fleets SET inwar = $war_id WHERE id = $a_oid" );
        db_query( "UPDATE ships  SET inwar = $war_id WHERE fleet_id = $a_oid" );
  
        db_query( "INSERT IGNORE INTO ships_war SELECT * FROM ships WHERE fleet_id = $a_oid" );
        break;
    }

    switch( $d_type ) {
      case 0:
        db_query( "UPDATE ships  SET inwar = $war_id WHERE id = $d_oid" );
  
        db_query( "INSERT IGNORE INTO ships_war SELECT * FROM ships WHERE id = $d_oid" );
        break;
      case 1:
        db_query( "UPDATE fleets SET inwar = $war_id WHERE id = $d_oid" );
        db_query( "UPDATE ships  SET inwar = $war_id WHERE fleet_id = $d_oid" );
  
        db_query( "INSERT IGNORE INTO ships_war SELECT * FROM ships WHERE fleet_id = $d_oid" );
        break;
    }
  }

  fclose( $h );
  @unlink( 'locks/war_events.dat' );
}

function enter_place( $shid, $isfleet ) {

  if( $isfleet ) {
    $place = db_fetch_row( "SELECT f.user_id, u.aliance, f.place_type, f.place_id, f.arg1, f.arg2
                              FROM fleets f
                        INNER JOIN users u ON u.id = f.user_id
                             WHERE f.id = $shid" );

    $corsar = db_fetch_val( "SELECT MIN( st.corsar ) corsar
                               FROM ships s
                         INNER JOIN ship_types st ON st.object_id = s.object_id
                              WHERE s.fleet_id = $shid", 'corsar' );
  } else {
    $place = db_fetch_row( "SELECT s.user_id, u.aliance, s.place_type, s.place_id, s.arg1, s.arg2
                              FROM ships s
                        INNER JOIN users u ON u.id = s.user_id
                             WHERE s.id = $shid" );

    $corsar = db_fetch_val( "SELECT st.corsar
                               FROM ships s
                         INNER JOIN ship_types st ON st.object_id = s.object_id
                              WHERE s.id = $shid", 'corsar' );
  }

  if( !$place['place_id'] ) {
    return;
  }

  $defence['status'] = 0;
  $s_guard = array();
  $f_guard = array();

  if( $corsar != 1 ) {
    $corsar = 0;
  }

  switch( $place['place_type'] ) {
    case 0:
    case 1:
      $defence = db_fetch_row( "SELECT IFNULL( d.status, 0 ) status
                                  FROM defence d
                            INNER JOIN users u ON u.id = d.user_id
                             LEFT JOIN foe fe ON fe.user_id = d.user_id AND fe.foe_id = {$place['user_id']}
                             LEFT JOIN friend fr ON fr.user_id = d.user_id AND fr.friend_id = {$place['user_id']}
                                 WHERE d.place_id = ".$place['place_id']." AND d.place_type = {$place['place_type']} AND (
                                         ( d.status = 1 ) OR
                                         ( $corsar = 1 AND d.status > 1 ) OR
                                         ( d.status = 2 AND fe.user_id is not null ) OR
                                         ( d.status = 3 AND fr.user_id is null ) OR
                                         ( d.status = 4 AND u.aliance != {$place['aliance']} )
                                       ) AND d.user_id != ".$place['user_id'] );

      $s_guard = db_fetch_array( "SELECT s.id, s.guard
                                    FROM ships s
                              INNER JOIN users u ON u.id = s.user_id
                               LEFT JOIN foe fe ON fe.user_id = s.user_id AND fe.foe_id = {$place['user_id']}
                               LEFT JOIN friend fr ON fr.user_id = s.user_id AND fr.friend_id = {$place['user_id']}
                                   WHERE ( ( s.guard = 1 ) OR
                                           ( $corsar = 1 AND s.guard > 1 ) OR
                                           ( s.guard = 2 AND fe.user_id is not null ) OR
                                           ( s.guard = 3 AND fr.user_id is null ) OR
                                           ( s.guard = 4 AND u.aliance != {$place['aliance']} )
                                         ) AND s.fleet_id IS null AND s.user_id != ".$place['user_id']." AND s.place_type = {$place['place_type']} AND s.place_id = ".$place['place_id'] );

      $f_guard = db_fetch_array( "SELECT f.id, f.guard
                                    FROM fleets f
                              INNER JOIN users u ON u.id = f.user_id
                               LEFT JOIN foe fe ON fe.user_id = f.user_id AND fe.foe_id = {$place['user_id']}
                               LEFT JOIN friend fr ON fr.user_id = f.user_id AND fr.friend_id = {$place['user_id']}
                                   WHERE ( ( f.guard = 1 ) OR
                                           ( $corsar = 1 AND f.guard > 1 ) OR
                                           ( f.guard = 2 AND fe.user_id is not null ) OR
                                           ( f.guard = 3 AND fr.user_id is null ) OR
                                           ( f.guard = 4 AND u.aliance != {$place['aliance']} )
                                         ) AND f.user_id != ".$place['user_id']." AND f.place_type = {$place['place_type']} AND f.place_id = ".$place['place_id'] );
      break;

    case 7:
    case 8:
      $s_guard = db_fetch_array( "SELECT s.id, s.guard
                                    FROM ships s
                              INNER JOIN users u ON u.id = s.user_id
                               LEFT JOIN foe fe ON fe.user_id = s.user_id AND fe.foe_id = {$place['user_id']}
                               LEFT JOIN friend fr ON fr.user_id = s.user_id AND fr.friend_id = {$place['user_id']}
                                   WHERE s.arg1={$place['arg1']} AND s.arg2={$place['arg2']} AND
                                         s.fleet_id is null AND (
                                           ( s.guard = 1 ) OR
                                           ( $corsar = 1 AND s.guard > 1 ) OR
                                           ( s.guard = 2 AND fe.user_id is not null ) OR
                                           ( s.guard = 3 AND fr.user_id is null ) OR
                                           ( s.guard = 4 AND u.aliance != {$place['aliance']} )
                                         ) AND s.place_type = {$place['place_type']} AND s.user_id != {$place['user_id']} AND s.place_id = ".$place['place_id'] );

      $f_guard = db_fetch_array( "SELECT f.id, f.guard
                                    FROM fleets f
                              INNER JOIN users u ON u.id = f.user_id
                               LEFT JOIN foe fe ON fe.user_id = f.user_id AND fe.foe_id = {$place['user_id']}
                               LEFT JOIN friend fr ON fr.user_id = f.user_id AND fr.friend_id = {$place['user_id']}
                                   WHERE f.arg1={$place['arg1']} AND f.arg2={$place['arg2']} AND (
                                           ( f.guard = 1 ) OR
                                           ( $corsar = 1 AND f.guard > 1 ) OR
                                           ( f.guard = 2 AND fe.user_id is not null ) OR
                                           ( f.guard = 3 AND fr.user_id is null ) OR
                                           ( f.guard = 4 AND u.aliance != {$place['aliance']} )
                                         ) AND f.place_type = {$place['place_type']} AND f.user_id != {$place['user_id']} AND f.place_id = ".$place['place_id'] );
      break;
  }


  switch( $place['place_type'] ) {
    case 0:
      if( $defence['status'] > 0 ) {
        if( $isfleet ) {
          if( $defence['status'] == 4 ) {
            StartWar( 1, $shid, 3, $place['place_id'], null, 8 );
          } else {
            StartWar( 1, $shid, 3, $place['place_id'], null, 1 );
          }
        } else {
          if( $defence['status'] == 4 ) {
            StartWar( 0, $shid, 3, $place['place_id'], null, 8 );
          } else {
            StartWar( 0, $shid, 3, $place['place_id'], null, 1 );
          }
        }
      }
      break;

    case 1:
      if( $defence['status'] > 0 ) {
        if( $isfleet ) {
          if( $defence['status'] == 4 ) {
            StartWar( 1, $shid, 2, $place['place_id'], null, 8 );
          } else {
            StartWar( 1, $shid, 2, $place['place_id'], null, 1 );
          }
        } else {
          if( $defence['status'] == 4 ) {
            StartWar( 0, $shid, 2, $place['place_id'], null, 8 );
          } else {
            StartWar( 0, $shid, 2, $place['place_id'], null, 1 );
          }
        }
      }
      break;
  }

  if( count( $s_guard ) ) {
    foreach( $s_guard as $atack ) {
      if( $isfleet ) {
        if( $atack['guard'] == 4 ) {
          StartWar( 0, $atack['id'], 1, $shid, null, 8 );
        } else {
          StartWar( 0, $atack['id'], 1, $shid, null, 1 );
        }
      } else {
        if( $atack['guard'] == 4 ) {
          StartWar( 0, $atack['id'], 0, $shid, null, 8 );
        } else {
          StartWar( 0, $atack['id'], 0, $shid, null, 1 );
        }
      }
    }
  }

  if( count( $f_guard ) ) {
    foreach( $f_guard as $atack ) {
      if( $isfleet ) {
        if( $atack['guard'] == 4 ) {
          StartWar( 1, $atack['id'], 1, $shid, null, 8 );
        } else {
          StartWar( 1, $atack['id'], 1, $shid, null, 1 );
        }
      } else {
        if( $atack['guard'] == 4 ) {
          StartWar( 1, $atack['id'], 0, $shid, null, 8 );
        } else {
          StartWar( 1, $atack['id'], 0, $shid, null, 1 );
        }
      }
    }
  }
}                 

function render_page( $filename, $vars = null, $width = 1000, $attach = "" ) {

  global $user;

  $anticache = md5( filesize( "swf/$filename.jpg" ).':'.filemtime( "swf/$filename.jpg" ) );

  if( $vars ) {
    $vars .= "&sv=".$user->sound;
  } else {
    $vars = "sv=".$user->sound;
  }

  if( $user->level < 42 ) {
    $wmode = 'transparent';
    $div_s = '<div style="z-index: 1; position: absolute; top: 0; left: 0; width: 100%;"><center>';
    $div_e = '</center></div>';
  } else {
    $wmode = 'window';
    $div_s = '';
    $div_e = '';
  }

  print <<<EOL
<HTML>
<HEAD>
<meta http-equiv=Content-Type content="text/html; charset=windows-1251">
<TITLE>planet</TITLE>
</HEAD>
<BODY bgcolor=#000000 TOPMARGIN=0 LEFTMARGIN=0 MARGINHEIGHT=0 MARGINWIDTH=0>
$div_s
<OBJECT classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"
 WIDTH="$width" HEIGHT="500" id="topmenu" ALIGN="">
 <PARAM NAME=movie VALUE="swf/$filename.jpg?$anticache">
 <PARAM NAME=quality VALUE=high>
 <PARAM NAME=bgcolor VALUE=#000000>
 <param name=wmode value=$wmode>
 <PARAM NAME=flashvars VALUE="$vars">
 <EMBED src="swf/$filename.jpg?$anticache" quality=high bgcolor=#000000 WIDTH="$width" HEIGHT="500" NAME="topmenu" ALIGN="" wmode="$wmode"
 TYPE="application/x-shockwave-flash" PLUGINSPAGE="http://www.macromedia.com/go/getflashplayer" flashvars="$vars"></EMBED>
</OBJECT>
$div_e
$attach
</BODY>
</HTML>
EOL;
}

function update_fleet( $fleet_id ) {
  $fleet = db_fetch_row( "SELECT COUNT(*) cnt, SUM( st.cargo ) cargo, SUM( st.w_power ) w_power, SUM( st.w_count ) w_count, MIN( st.agrav ) agrav,
                                 MIN( st.planet ) planet, MIN( st.hyper ) hyper,
                                 SUM( o.mass ) mass, SUM( st.shield ) shield, SUM( st.planet_cnt ) planet_cnt, SUM( st.hyper_cnt ) hyper_cnt,
                                 SUM( st.radar ) radar, MAX( st.remote ) remote, MAX( s.guard ) guard, MAX( s.interupt ) interupt, SUM( st.cloak ) cloak,
                                 MAX( s.abordage ) abordage, MIN( st.corsar ) corsar, MAX( s.group ) `group`, MAX( st.titul ) titul,
                                 MAX( st.harvest ) harvest, MAX( st.hot ) hot
                            FROM ships s
                      INNER JOIN objects o ON o.id = s.object_id
                      INNER JOIN ship_types st ON st.object_id = s.object_id
                           WHERE s.fleet_id = $fleet_id" );

  if( $fleet['interupt'] == 0 ) {
    db_query( "DELETE FROM interupt_msg WHERE ship_id = $fleet_id AND type = 1" );
  }

  if( isset( $fleet ) && count( $fleet ) && $fleet['cnt'] > 1 ) {
    db_query( "UPDATE fleets
                  SET cargo = ".$fleet['cargo'].
                 ", w_power = ".$fleet['w_power'].
                 ", w_count = ".$fleet['w_count'].
                   ", agrav = ".$fleet['agrav'].
                  ", planet = ".$fleet['planet'].
                   ", hyper = ".$fleet['hyper'].
                    ", mass = ".$fleet['mass'].
                  ", shield = ".$fleet['shield'].
              ", planet_cnt = ".$fleet['planet_cnt'].
               ", hyper_cnt = ".$fleet['hyper_cnt'].
                   ", radar = ".$fleet['radar'].
                  ", remote = ".$fleet['remote'].
                   ", guard = ".$fleet['guard'].
                ", interupt = ".$fleet['interupt'].
                   ", cloak = ".$fleet['cloak'].
                ", abordage = ".$fleet['abordage'].
                  ", corsar = ".$fleet['corsar'].
                   ", titul = ".$fleet['titul'].
                 ", harvest = ".$fleet['harvest'].
                     ", hot = ".$fleet['hot'].
                 ", `group` = '".$fleet['group']."'".
                 " WHERE id = $fleet_id" );
  }

  return ( isset( $fleet['cnt'] ) ? $fleet['cnt'] : 0 );
}

function lock_me() {
  global $user;
  $uid = $user->uid;

  $h = @fopen( 'locks/tmp_'.$user->uid.'.dat', 'x' );
  if( $h ) {
    return true;
  } else {
    if( file_exists( 'locks/tmp_'.$user->uid.'.dat' ) && @filemtime( 'locks/tmp_'.$user->uid.'.dat' ) + 150 < time() ) {
      @unlink( 'locks/tmp_'.$user->uid.'.dat' );
      return true;
    }
  }

  return false;
}

function unlock_me() {
  global $user;
  $uid = $user->uid;

  @unlink( 'locks/tmp_'.$user->uid.'.dat' );
}

function correct_price() {
  $stock = db_fetch_array( "SELECT m.object_id, TRUNCATE( m.day_sell / m.min_count, 0 ) sell, TRUNCATE( m.day_buy / m.min_count, 0 ) buy, o.myprice, o.minprice
                              FROM market m
                        INNER JOIN objects o ON o.id = m.object_id" );

  foreach( $stock as $line ) {
    $price = round( $line['myprice'], 2 );
    if( $price < 0.02 ) {
      $price = 0.02;
    }

    if( $line['sell'] > $line['buy'] ) {
      $price = round( $line['myprice'] + ( 0.01 * ( $line['sell'] - $line['buy'] ) ), 2 );
    }

    if( $line['sell'] < $line['buy'] ) {
      $price = round( $line['myprice'] - ( 0.01 * ( $line['buy'] - $line['sell'] ) ), 2 );
    }

    if( $line['myprice'] != $price ) {
      $n_price = number_format( $price, 2, '.', '' );
      db_query( "UPDATE market SET day_sell = day_sell % min_count, day_buy = day_buy % min_count, avg_price = '$n_price' WHERE object_id = ".$line['object_id'] );
    }

    $price_sell = round( $price + ( $price * 0.2 ) + 0.01, 2 );
    $price_buy = round( $price - ( $price * 0.2 ) - 0.01, 2 );

    if( $price_sell < 0.03 ) {
      $price_sell = 0.03;
    }

    if( $price_buy < 0.01 ) {
      $price_buy = 0.01;
    }

    $price_buy = number_format( $price_buy, 2, '.', '' );
    $price_sell = number_format( $price_sell, 2, '.', '' );

    db_query( "UPDATE trade_in SET price = '$price_buy' WHERE ob_id = 26 AND object_id = ".$line['object_id'] );
    db_query( "UPDATE trade_out SET price = '$price_sell' WHERE ob_id = 26 AND object_id = ".$line['object_id'] );
  }

  db_query( "UPDATE objects o, market m
                SET o.myprice = m.avg_price
              WHERE o.class = 1 AND o.id = m.object_id" );

  for( $i = 0; $i < 5; $i++ ) {
    $new_price = db_fetch_array( "SELECT o.id, o.make_time, o.price, o.minprice, ( SUM( o2.myprice * os.res_cnt ) * IF( o.cprice > 0, 3, 2 ) ) newprice
                                    FROM objects o
                              INNER JOIN objects_sub os ON os.object_id = o.id
                              INNER JOIN objects o2 ON o2.id = os.res_id
                                   WHERE o.class IN( 2, 9 )
                                GROUP BY o.id" );

    foreach( $new_price as $item ) {
      if( $item['price'] > 0 && $item['make_time'] > 0 ) {
        if( $item['minprice'] == 0 ) {
          $price = ceil( $item['newprice'] * 1.20 );
        } else {
          if( $item['minprice'] < $item['newprice'] ) {
            $price = ceil( $item['newprice'] * 1.20 );
          } else {
            $price = $item['minprice'] + ceil( $item['newprice'] / 20 );
          }
        }

        db_query( "UPDATE objects SET price = '$price', myprice = '{$item['newprice']}' WHERE id = ".$item['id'] );
      } else {
        db_query( "UPDATE objects SET myprice = '{$item['newprice']}' WHERE id = ".$item['id'] );
      }
    }
  }
}

function user_report( $sid, $user_id, $type, $text, $x = null, $y = null ) {

  if( $x === null && $y === null && isset( $sid ) && is_numeric( $sid ) ) {
    $coord = db_fetch_row( "SELECT s.x, s.y FROM stars s WHERE s.id = $sid" );

    $x = $coord['x'];
    $y = $coord['y'];
  }

  if( $x !== null && $y !== null ) {
    $users = db_fetch_array( "SELECT p.user_id, UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(ua.lastlogin) logon
                                FROM stars s
                          INNER JOIN planets p ON p.user_id IS NOT NULL AND p.star_id = s.id
                          INNER JOIN users_active ua ON ua.id = p.user_id
                               WHERE p.user_id != $user_id AND SQRT( POW( s.x - $x, 2 ) + POW( s.y - $y, 2 ) ) < $type" );

    foreach( $users as $item ) {
      db_query( "INSERT DELAYED INTO users_report ( user_id, type, message ) VALUES ( {$item['user_id']}, $type, '$text' )" );

      if( $item['logon'] < 30 ) {
        send_msg( 1, $item['user_id'], $text, 15 );
      }
    }
  }
}

function gen_report( $user_id ) {
  $alevel = 10 + get_book_level( 27, $user_id ) * 10;

  $result = db_fetch_array( "SELECT count(*) cnt, min( ur.msg_date ) min_date, max( ur.msg_date ) max_date, ur.type, ur.message
                               FROM users_report ur
                              WHERE user_id = $user_id AND rand() * 110 < $alevel
                           GROUP BY ur.type, ur.message
                           ORDER BY max_date DESC, type DESC" );

  if( count( $result ) ) {
    $message = t( "Доклад министерств и ведомств от %s\n\nЗа время вашего отсутствия были получены следующие сообщения:\n", array( $result[0]['max_date'] ) );
    foreach( $result as $item ) {
      if( $item['cnt'] > 1 ) {
        $message .= t( "В период с %s по %s получено %d сообщений: %s\n", array( $item['min_date'], $item['max_date'], $item['cnt'], $item['message'] ) );
      } else {
        $message .= t( "В %s получено сообщение: %s\n", array( $item['min_date'], $item['message'] ) );
      }
    }

    if( $alevel < 100 ) {
      $message .= t( "\n\nВы получили только %d%%25 сообщений. Чтобы получать больше сообщений, изучите навык Астроном.", array( $alevel ) );
    }

    send_msg( 1, $user_id, $message, 20 );
  }

  db_query( "DELETE FROM users_report WHERE user_id = $user_id" );
}

function quest_field( $user, $ft, $fv ) {

  $ret = array( 'err' => 1 );

  switch( $ft ) {

    case 1: // int number
      if( is_numeric( $fv ) && intval( $fv ) == $fv ) {
        $ret = array( 'err' => 0 );
      } else {
        $ret = array( 'err' => 2, 'errtext' => t( 'Значение должно быть целым числом' ) );
      }
      break;

    case 2: // float number
      if( is_numeric( $fv ) && round( $fv, 2 ) == $fv ) {
        $ret = array( 'err' => 0 );
      } else {
        $ret = array( 'err' => 3, 'errtext' => t( 'Значение должно быть дробным числом' ) );
      }
      break;

    case 3: // my planet
      $result = db_fetch_row( "SELECT p.id, p.type, p.planet_pos, s.id sid, s.name
                                 FROM planets p
                           INNER JOIN stars s ON s.id = p.star_id
                            LEFT JOIN defence d ON d.place_id = p.id
                                WHERE ( d.user_id IS NULL OR d.user_id = {$user->uid} ) AND p.type != 1 AND p.name = '$fv'
                                LIMIT 0,1" );

      if( isset( $result['id'] ) && $result['id'] > 0 ) {
        $ret = array( 'err' => 0, 'pid' => $result['id'], 'ptype' => $result['type'], 'ppos' => $result['planet_pos'], 'sid' => $result['sid'], 'sname' => $result['name'] );
      } else {
        $ret = array( 'err' => 4, 'errtext' => t( 'Планета с таким именем не найдена или у вас нет над ней контроля' ) );
      }
      break;

    case 4: // credit
      if( is_numeric( $fv ) && $fv > 0 ) {
        if( $fv <= $user->money ) {
          $ret = array( 'err' => 0 );
        } else {
          $ret = array( 'err' => 5, 'errtext' => t( 'У вас недостаточно кредитов' ) );
        }
      } else {
        $ret = array( 'err' => 5, 'errtext' => t( 'Неверное значение суммы' ) );
      }
      break;

    case 5: // confederate
      if( is_numeric( $fv ) && $fv > 0 ) {
        if( $fv <= $user->credits ) {
          $ret = array( 'err' => 0 );
        } else {
          $ret = array( 'err' => 6, 'errtext' => t( 'У вас недостаточно конфедерат' ) );
        }
      } else {
        $ret = array( 'err' => 6, 'errtext' => t( 'Неверное значение суммы' ) );
      }
      break;

    case 6: // user
      $result = db_fetch_row( "SELECT u.id, p.id pid, UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(ua.lastlogin) timer, u.ssid
                                 FROM users u
                           INNER JOIN users_active ua ON ua.id = u.id
                           INNER JOIN planets p ON p.user_id = u.id
                                WHERE u.login = '$fv'" );

      if( isset( $result['id'] ) && $result['id'] > 0 ) {
        if( $result['timer'] < 60 && $result['ssid'] != 1 ) {
          $ret = array( 'err' => 0, 'uid' => $result['id'], 'pid' => $result['pid'], 'active' => true );
        } else {
          $ret = array( 'err' => 0, 'uid' => $result['id'], 'pid' => $result['pid'], 'active' => false );
        }
      } else {
        $ret = array( 'err' => 4, 'errtext' => t( 'Пилот с таким именем не найден' ) );
      }
      break;

    case 7: // time
      if( is_numeric( $fv ) && intval( $fv ) == $fv ) {
        if( $fv <= 0 || $fv > 168 ) {
          $ret = array( 'err' => 7, 'errtext' => t( 'Значение времени может быть от 1 до 168 часов' ) );
        } else {
          $ret = array( 'err' => 0 );
        }
      } else {
        $ret = array( 'err' => 7, 'errtext' => t( 'Укажите время выполнения' ) );
      }
      break;

    case 8: // planet
      $result = db_fetch_row( "SELECT p.id, p.type, p.planet_pos, s.id sid, s.name
                                 FROM planets p
                           INNER JOIN stars s ON s.id = p.star_id
                                WHERE p.type != 1 AND p.name = '$fv'" );

      if( isset( $result['id'] ) && $result['id'] > 0 ) {
        $ret = array( 'err' => 0, 'pid' => $result['id'], 'ptype' => $result['type'], 'ppos' => $result['planet_pos'], 'sid' => $result['sid'], 'sname' => $result['name'] );
      } else {
        $ret = array( 'err' => 4, 'errtext' => t( 'Планета с таким именем не найдена' ) );
      }
      break;

    case 9: // star
      $result = db_fetch_row( "SELECT s.id, s.name
                                 FROM stars s
                                WHERE s.type != 4 AND s.name LIKE '$fv (%'
                                LIMIT 0,1" );

      if( isset( $result['id'] ) && $result['id'] > 0 ) {
        $ret = array( 'err' => 0, 'sid' => $result['id'], 'sname' => $result['name'] );
      } else {
        $ret = array( 'err' => 4, 'errtext' => t( 'Звезда с таким именем не найдена' ) );
      }
      break;
  }

  return $ret;
}

function on_login() {
  $login = $_POST['login'];
  $pass = md5( $_POST['pass'] );
  $sid = isset( $_COOKIE[ 'chat_sid' ] ) ? $_COOKIE[ 'chat_sid' ] : 0;

  db_safe( $login );
  db_safe( $pass );
  db_safe( $sid );

  $uid = db_fetch_val( "SELECT u.id FROM users u WHERE u.status = 1 AND u.login='$login' AND u.password='$pass'", 'id' );

  if( $uid ) {
    db_query( "INSERT INTO bot_analyze ( user_id, clone_id, size )
                    SELECT $uid, id, 100
                      FROM users
                     WHERE id != $uid AND email != 'From VK' AND password = '$pass'
   ON DUPLICATE KEY UPDATE size = size + 100" );

    db_query( "INSERT INTO bot_analyze ( user_id, clone_id, size )
                    SELECT $uid, id, 10
                      FROM users
                     WHERE id != $uid AND last_ip = '{$_SERVER["REMOTE_ADDR"]}'
   ON DUPLICATE KEY UPDATE size = size + 10" );

    db_query( "INSERT INTO bot_analyze ( user_id, clone_id, size )
                    SELECT $uid, id, 25
                      FROM users
                     WHERE id != $uid AND ssid = '$sid'
   ON DUPLICATE KEY UPDATE size = size + 25" );
  } else {
    $uid = db_fetch_val( "SELECT u.id FROM users u WHERE u.status = 1 AND u.login='$login'", 'id' );
    if( $uid ) {
      db_query( "INSERT INTO bot_analyze ( user_id, clone_id, size )
                      SELECT $uid, id, 50
                        FROM users
                       WHERE id != $uid AND email != 'From VK' AND password = '$pass'
     ON DUPLICATE KEY UPDATE size = size + 50" );

      db_query( "INSERT INTO bot_analyze ( user_id, clone_id, size )
                      SELECT $uid, id, 25
                        FROM users
                       WHERE id != $uid AND ssid = '$sid'
     ON DUPLICATE KEY UPDATE size = size + 25" );
    }
  }
}

function get_clons( $uid ) {
  $clons = db_fetch_val( "SELECT group_concat( login ) clons
                            FROM bot_analyze ba
                      INNER JOIN users u ON u.id = ba.clone_id
                           WHERE ba.user_id = $uid AND ba.size >= 100", 'clons' );
  return $clons;
}

function disasseble( $sell, $oid, $class, $ocnt, $place ) {
  if( $class == 1 ) {
    $subs = array( array( 'class' => 1, 'res_id' => $oid, 'res_cnt' => $ocnt ) );
  } else {
    $subs = db_fetch_array( "SELECT o.class, os.res_id, os.res_cnt * $ocnt res_cnt
                               FROM objects_sub os
                         INNER JOIN objects o ON o.id = os.res_id AND o.class IN( 1, 2, 9 )
                              WHERE os.object_id = $oid" );
  }

  if( $sell ) {
    foreach( $subs as $item ) {
      if( $item['class'] == 1 ) {
        db_query( "UPDATE market SET day_sell = day_sell + {$item['res_cnt']} WHERE object_id = {$item['res_id']}" );
//        db_query( "UPDATE trade_in SET object_cnt = object_cnt + {$item['res_cnt']} WHERE object_id = {$item['res_id']} AND ob_id = ".$place );
      } else {
        disasseble( $sell, $item['res_id'], $item['class'], $item['res_cnt'] * $ocnt, $place );
      }
    }
  } else {
    foreach( $subs as $item ) {
      if( $item['class'] == 1 ) {
        db_query( "UPDATE market SET day_buy = day_buy + {$item['res_cnt']} WHERE object_id = {$item['res_id']}" );
//        db_query( "UPDATE trade_out SET object_cnt = object_cnt + {$item['res_cnt']} WHERE object_id = {$item['res_id']} AND ob_id = ".$place );
      } else {
        disasseble( $sell, $item['res_id'], $item['class'], $item['res_cnt'] * $ocnt, $place );
      }
    }
  }
}

function ca_message( $user_id, $data = array() ) {

  return 1;

  db_safe( $user_id );

  $result = db_fetch_row( "SELECT ca_prx, ca_click_id FROM users WHERE id = $user_id" );

  $prx = $result['ca_prx'];
  $click_id = $result['ca_click_id'];

  if( $prx == 0 ) {
    return 0;
  }

  $str_data = '';
  foreach( $data as $key => $val ) {
    $str_data .= '&'.$key.'='.$val;
  }

  $url = "https://cityads.ru/service/postback?order_id={$user_id}&prx={$prx}&click_id={$click_id}".$str_data;
//  $url = "https://mad.21noon.com/service/postback?order_id={$user_id}&prx={$prx}&click_id={$click_id}";

  try {
    $ch = curl_init();
    curl_setopt( $ch, CURLOPT_URL, $url );
    curl_setopt( $ch, CURLOPT_HEADER, false );
    curl_setopt( $ch, CURLOPT_FOLLOWLOCATION, false );
    curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
    curl_setopt( $ch, CURLOPT_SSL_VERIFYPEER, false );
    curl_setopt( $ch, CURLOPT_SSL_VERIFYHOST, false );

    $response = curl_exec( $ch );
    $xml = new SimpleXMLElement( $response );
    $code = strval( $xml->code );
  } catch(Exception $e){
    debug_it( $response );
    db_query( "INSERT INTO city_ads ( order_id, ca_prx, ca_click_id, data ) VALUES ( $user_id, '$prx', '$click_id', '$str_data' )" );

    return 0;
  }

  if( $code == 'OK' ) {
 //   debug_it( $response );

    return 1;
  } else {
    debug_it( $response );
    db_query( "INSERT INTO city_ads ( order_id, ca_prx, ca_click_id, data ) VALUES ( $user_id, '$prx', '$click_id', '$str_data' )" );

    return 0;
  }
}

function so_message( $user_id, $type = 0, $price = 0 ) {

  $result = db_fetch_row( "SELECT so_source, so_tid FROM users WHERE id = $user_id" );

//  $link = urlencode( "http://pixel.7offers.ru/id_offer/id_goal/?source={$result['so_source']}&tid={$result['so_tid']}&ip=$cpa7_ip&ua=$cpa7_ua&ip_forwarded=$cpa7_forwarded&ip_real=$cpa7_real&ip_client=$cpa7_ip_client" );
//  $link = urlencode( "http://pixel.7offers.ru/65/68/pixel.png?source={$result['so_source']}&tid={$result['so_tid']}&ip=$cpa7_ip&ua=$cpa7_ua&ip_forwarded=$cpa7_forwarded&ip_real=$cpa7_real&ip_client=$cpa7_ip_client" );

  if( isset( $result['so_source'] ) && $result['so_source'] ) {
    debug_it( 'user='.$user_id );

    $cpa7_ip = $_SERVER['REMOTE_ADDR'];
    $cpa7_ua = $_SERVER['HTTP_USER_AGENT'];
    $cpa7_ip_forwarded = $_SERVER['HTTP_X_FORWARDED_FOR'];
    $cpa7_ip_real = $_SERVER['HTTP_X_REAL_IP'];
    $cpa7_ip_client = $_SERVER['HTTP_CLIENT_IP'];

    if( $type == 0 ) {
      $link = "http://pixel.7offers.ru/65/68/?source={$result['so_source']}&tid={$result['so_tid']}&ip=$cpa7_ip&ua=".urlencode($cpa7_ua)."&ip_forwarded=$cpa7_forwarded&ip_real=$cpa7_real&ip_client=$cpa7_ip_client";
    } else {
//      $price = round( $price / 10 * 4, 2 );
      $link = "http://pixel.7offers.ru/65/69/?source={$result['so_source']}&tid={$result['so_tid']}&price=$price&currency=USD&ip=$cpa7_ip&ua=".urlencode($cpa7_ua)."&ip_forwarded=$cpa7_forwarded&ip_real=$cpa7_real&ip_client=$cpa7_ip_client";
    }

    debug_it( 'link='.$link );
    $ret = file_get_contents($link);
    debug_it( 'answer='.$ret );
  }
}

function get_ship_limit( $uid ) {
  $limit_ships = db_fetch_val( "SELECT count(*) cnt FROM ships WHERE user_id = $uid", 'cnt' );
  $limit_planets = db_fetch_val( "SELECT count(*) cnt FROM defence WHERE status != 0 AND place_type = 1 AND user_id = $uid", 'cnt' );
  $limit_implant = ( get_implant_level( 9308, $uid ) > 0 ) ? 10000 : 0;

  $limit = ( $limit_planets + 1 ) * ( 100 + ( 100 * get_book_level( 36, $uid ) ) ) + $limit_implant - $limit_ships;

  return $limit;
}

function decode_in( $s ) {
    $in = array( "%u0430","%u0431","%u0432","%u0433","%u0434","%u0435","%u0436","%u0437","%u0438","%u0439","%u043A","%u043B","%u043C","%u043D","%u043E","%u043F","%u0440","%u0441","%u0442","%u0443","%u0444","%u0445","%u0446","%u0447","%u0448","%u0449","%u044A","%u044B","%u044C","%u044D","%u044E","%u044F","%u0451","%u0410","%u0411","%u0412","%u0413","%u0414","%u0415","%u0416","%u0417","%u0418","%u0419","%u041A","%u041B","%u041C","%u041D","%u041E","%u041F","%u0420","%u0421","%u0422","%u0423","%u0424","%u0425","%u0426","%u0427","%u0428","%u0429","%u042A","%u042B","%u042C","%u042D","%u042E","%u042F","%u0401" );
    $out = array( "а","б","в","г","д","е","ж","з","и","й","к","л","м","н","о","п","р","с","т","у","ф","х","ц","ч","ш","щ","ъ","ы","ь","э","ю","я","ё","А","Б","В","Г","Д","Е","Ж","З","И","Й","К","Л","М","Н","О","П","Р","С","Т","У","Ф","Х","Ц","Ч","Ш","Щ","Ъ","Ы","Ь","Э","Ю","Я","Ё" );
    return str_replace( $in, $out, $s );  
}

function wasd_send( $uid ) {
  $key = '322ed071404bf9b3e466f9605affbba9b83f9698';
  $request_id = db_fetch_val( "SELECT wasd_id FROM users WHERE id = $uid", 'wasd_id' );

  if( $request_id ) {
//    debug_it( "Start request($request_id)" );
    $url = 'http://api.wasdclub.com/request/complete/id/'.$request_id.'/key/'.$key;

    file_get_contents( $url );
  }
}
