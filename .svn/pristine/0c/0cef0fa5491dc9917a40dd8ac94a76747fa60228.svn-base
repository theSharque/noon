<?php

  $url = "https://sci.interkassa.com/";

  $amount = intval( $_GET['summ'] );

  db_query( "INSERT INTO pay_log ( user_id, mess ) VALUES ( {$user->uid}, 'Start pay of $amount' )" );
  $log_id = mysql_insert_id();

  $out = 'err=0&logid='.$log_id;

  printOut( $out );

/*
  $fields = "ik_co_id=5294ed71bf4efc6549330c4d&ik_pm_no=$log_id&ik_am=$amount&ik_cur=USD&ik_desc=Покупка 100 конфедерат для {$user->login}&".
            "ik_act=payways&ik_ia_u=http://21noon.com/inter2.php&ik_ia_m=post&ik_int=json&ik_am_t=invoice&ik_x_ik_baggage_uid={$user->uid}";

  try {
    $ch = curl_init();
    curl_setopt( $ch, CURLOPT_URL, $url );
    curl_setopt( $ch, CURLOPT_HEADER, false );
    curl_setopt( $ch, CURLOPT_FOLLOWLOCATION, false );
    curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
    curl_setopt( $ch, CURLOPT_SSL_VERIFYPEER, false );
    curl_setopt( $ch, CURLOPT_SSL_VERIFYHOST, false );
    curl_setopt( $ch, CURLOPT_POST, true );
    curl_setopt( $ch, CURLOPT_POSTFIELDS, $fields );

    $response = curl_exec( $ch );
    $ans = json_decode( $response, true );
    if( $ans['resultCode'] == 0 ) {
      debug_it( $ans );


    }

  } catch(Exception $e){
    debug_it( $response );
  }

  if( isset( $_GET['summ'] ) && is_numeric( $_GET['summ'] ) ) {

    $amount = intval( $_GET['summ'] );

    db_query( "INSERT INTO pay_log ( user_id, mess ) VALUES ( {$user->uid}, 'Start pay of $amount' )" );
    $log_id = mysql_insert_id();

<form id="payment" name="payment" method="post" action="https://sci.interkassa.com/" enctype="utf-8">
	<input type="hidden" name="ik_co_id" value="5294ed71bf4efc6549330c4d" />
	<input type="hidden" name="ik_pm_no" value="4523" />
	<input type="hidden" name="ik_am" value="100" />
	<input type="hidden" name="ik_cur" value="USD" />
	<input type="hidden" name="ik_desc" value="Покупка 100 конфедерат для Sharque" />
	<input type="hidden" name="ik_act" value="payways" />
	<input type="hidden" name="ik_ia_u" value="http://21noon.com/inter2.php" />
	<input type="hidden" name="ik_ia_m" value="post" />
	<input type="hidden" name="ik_exp" value="2013-12-22" />
	<input type="hidden" name="ik_int" value="json" />
	<input type="hidden" name="ik_am_t" value="invoice" />
	<input type="text" name="ik_x_ik_baggage_uid" value="16" />
        <input type="submit" value="Pay">
</form>

    $xml = file_get_contents( "http://www.interkassa.com/lib/paysystems.currencies.export.php?format=xml&shop_id=0F1495D5-FF97-A645-149C-E02C00C224BF&key=9vvHKIH1vtYEZC7b&amount=$amount" );

    $xml_parser = xml_parser_create();
    xml_parse_into_struct( $xml_parser, $xml, $parsed );

    $options = array();
    $tab1 = 0;
    $tab2 = 0;

    foreach( $parsed as $item ) {
      if( $item['type'] == 'complete' && isset( $item['attributes']['AMOUNT'] ) ) {

        $preopt[ $item['attributes']['ALIAS'] ] = array( $item['attributes']['AMOUNT'], mb_convert_encoding( $item['attributes']['CURRENCYNAME'], 'CP1251', 'UTF-8' ), mb_convert_encoding( $item['value'], 'CP1251', 'UTF-8' ) );

        if( strlen( $item['attributes']['AMOUNT'] ) > $tab1 ) {
          $tab1 = strlen( $item['attributes']['AMOUNT'] );
        }
        
        if( strlen( mb_convert_encoding( $item['attributes']['CURRENCYNAME'], 'CP1251', 'UTF-8' ) ) > $tab2 ) {
          $tab2 = strlen( mb_convert_encoding( $item['attributes']['CURRENCYNAME'], 'CP1251', 'UTF-8' ) );
        }
      }
    }

    foreach( $preopt as $key => $item ) {
      $options[ $key ] = str_replace( '#', " ", str_pad( $item[0], $tab1 + 1, '#' ).str_pad( $item[1], $tab2 + 1, '#' ).$item[2] );
    }
    krsort( $options );

    $out = 'err=0&cnt='.count( $options );

    $out .= '&logid='.$log_id;
    $out .= '&uid='.$user->uid;
    $out .= '&uname='.$user->login;

    $l=0;
    foreach( $options as $key => $item ) {
      $out .= "&pa$l=$key&pl$l=$item";
      $l++;
    }

  } else {
    $out = 'err=1';
  }
*/