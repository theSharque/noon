<?php

function quest_event_all() {

  global $user;
  global $repeat;

  $uid = ( is_object( $user ) && isset( $user->uid ) ) ? $user->uid : 0;

  $microtime_start = microtime(true);

  do {
    $repeat = false;

    if( $uid ) {
      $result = db_fetch_array( "SELECT SQL_NO_CACHE uc.id, uc.type, uc.status, uc.user_id, uc.arg0, uc.arg1, uc.arg2,
                                        uc.arg3, uc.arg4, uc.arg5, uc.arg6, uc.arg7, uc.arg8, uc.arg9
                                   FROM users_quests uc FORCE INDEX (user_id)
                                  WHERE uc.user_id IN ( $uid, 4, 6 ) AND uc.status > 0" );
    } else {
      $result = db_fetch_array( "SELECT SQL_NO_CACHE uc.id, uc.type, uc.status, uc.user_id, uc.arg0, uc.arg1, uc.arg2,
                                        uc.arg3, uc.arg4, uc.arg5, uc.arg6, uc.arg7, uc.arg8, uc.arg9
                                   FROM users_quests uc FORCE INDEX (user_id)
                                  WHERE uc.user_id IS NOT NULL AND uc.status > 0 LIMIT 0,500" );
    }

    foreach( $result as $item ) {

      if( microtime(true) - $microtime_start > 2 ) {
        return;
      }

      switch( $item['type'] ) {
        case 1:
        case 5:
        case 6:
        case 7:
        case 32:
          quest_mine_event( $item );
          break;
        case 2:
          quest_search_event( $item );
          break;
        case 3:
          quest_courier_event( $item );
          break;
        case 4:
        case 8:
          quest_tritit_event( $item );
          break;
        case 9:
          quest_pirates_event( $item );
          break;
        case 10:
          quest_dolphin_event( $item );
          break;
        case 11:
          quest_atack_event( $item );
          break;
        case 12:
          quest_explore_event( $item );
          break;
        case 13:
          quest_battle_event( $item );
          break;
        case 14:
          quest_battle2_event( $item );
          break;
        case 15:
          quest_lost_ship( $item );
          break;

        case 16: // user
          quest_planet_exchange( $item );
          break;

        case 17:
        case 18:
          quest_destroy_mission( $item );
          break;

        case 19:
        case 20:
        case 21:
        case 22:
        case 23:
        case 24:
        case 25:
        case 26:
        case 27:
          quest_build_mission( $item );
          break;

        case 28:
        case 29:
          quest_upgrade_mission( $item );
          break;

        case 30:
          quest_ring_event( $item );
          break;

        case 31:
          quest_find_event( $item );
          break;

        case 33:
        case 34:
          quest_duel_event( $item );
          break;
      }
    }
  } while ( $repeat );
}

function step_up( $event_id, $level = -1 ) {
  global $repeat;

  db_query( "UPDATE users_quests SET status = status + $level WHERE id = $event_id" );
  $repeat = true;
}

function quest_mine_event( $event ) {
  switch( $event['status'] ) {
    case 2:
      $test = db_fetch_row( "SELECT w.object_cnt, p.name FROM planets p, warehouse w
                              WHERE w.place_type = 1 AND w.place_id = p.id AND p.user_id = ".$event['user_id'].
                                  " AND w.object_id = ".$event['arg2'] );
      if( $test['object_cnt'] < $event['arg1'] ) {
        send_msg( 1, $event['user_id'], t( "Вам необходимо добыть '%s' %s или доставить их на вашу планету %s.", array( $event['arg1'], $event['arg5'], $test['name'] ) ), 7 );
      }
      step_up( $event['id'] );
    break;
    case 1:
      $test = db_fetch_row( "SELECT w.object_cnt, p.id FROM planets p, warehouse w
                              WHERE w.place_type = 1 AND w.place_id = p.id AND p.user_id = ".$event['user_id'].
                                  " AND w.object_id = ".$event['arg2'] );

      if( isset( $test['object_cnt'] ) && $test['object_cnt'] >= $event['arg1'] ) {
        sub_warehouse_item( 1, $test['id'], $event['arg2'], $event['arg1'] );
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg3']} WHERE u.id = {$event['user_id']}" );

        setChar( 'status', $event['arg4'], $event['user_id'] );

        send_msg( 1, $event['user_id'], t( "Конфедерация гордится вами! Корабль конфедерации загрузил %s в количестве %s и улетел с вашей планеты. Именно такие колонисты как вы покоряют космос шаг за шагом. За выполнение задания вы получаете %s кредитов.", array( $event['arg5'], $event['arg1'], $event['arg3'] ) ), 7 );
        step_up( $event['id'] );
      }
    break;
  }
}

function quest_search_event( $event ) {
  switch( $event['status'] ) {
    case 6:
      db_query( "UPDATE users_quests SET arg1 = (SELECT id FROM stars WHERE name = '{$event['arg4']}') WHERE id = ".$event['id'] );
      $test = db_fetch_row( "SELECT count(*) cnt
                               FROM ships s
                         INNER JOIN ship_types st ON st.object_id = s.object_id
                              WHERE st.radar > 0 AND s.user_id = ".$event['user_id'] );
      if( $test['cnt'] == 0 ) {
        send_msg( 1, $event['user_id'], t( "Вам необходимо приобрести или построить радарный корабль." ), 7 );
      } else {
        send_msg( 1, $event['user_id'], t( "Отправьте ваш радарный корабль к звезде %s.", array( $event['arg4'] ) ), 7 );
      }
      step_up( $event['id'] );
    break;

    case 5:
      if( $event['arg1'] ) {
        $test = db_fetch_row( "SELECT count(*) cnt
                                 FROM ships s
                           INNER JOIN ship_types st ON st.object_id = s.object_id
                                WHERE s.place_type = 7 AND s.place_id = {$event['arg1']} AND st.radar > 0 AND s.user_id = ".$event['user_id'] );
      } else {
        db_query( "DELETE FROM users_quests WHERE id = ".$event['id'] );
      }
      if( isset( $test['cnt'] ) && $test['cnt'] > 0 ) {
        do {
          $xr = mt_rand( 1, 684 );
          $yr = mt_rand( 1, 460 );
          $xdiff = 340 - $xr;
          $ydiff = 220 - $yr;
          $len = round( sqrt( $xdiff * $xdiff + $ydiff * $ydiff ) );
        } while ( $len < 30 );
        
        db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id,  name,   arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                     (9010,     {$event['arg1']},   7,       1, 'S-O-S', $xr,  $yr,  NULL,     500,    0,     0    )" );
        $ship_id = mysql_insert_id();
        db_query( "UPDATE users_quests SET arg5 = $ship_id WHERE id=".$event['id'] );

        send_msg( 1, $event['user_id'], t( "Найдите потерянный корабль, будьте осторожны, в системе могут быть Трититы и пираты! Для поиска переместитесь любым вашим кораблем к желтой метке" ), 7 );
        step_up( $event['id'] );
      }
    break;

    case 4:
      $lost = db_fetch_row( "SELECT id, arg1, arg2 FROM ships WHERE id = ".$event['arg5'] );
      if( !isset( $lost['id'] ) || !is_numeric( $lost['id'] ) || $lost['id'] <= 0 ) {
        setChar( 'status', -1 * $event['arg3'], $event['user_id'] );

        send_msg( 1, $event['user_id'], t( "Корабль просивший вас о помощи потерян, вы нарушили договоренность! Конфедерация не одобряет ваших действий." ), 7 );
        step_up( $event['id'], -4 );
      }

      $test = db_fetch_row( "SELECT count(*) cnt
                               FROM ships
                              WHERE place_type = 7 AND place_id = {$event['arg1']} AND arg1 = {$lost['arg1']} AND arg2 = {$lost['arg2']} AND user_id = ".$event['user_id'] );
      if( $test['cnt'] ) {
        send_msg( 1, $event['user_id'], t( "СОС!!! СОС!!! Щиты нашего корабля не смогли отразить метеорит, и он пробил топливные баки. Пожалуйста, возьмите нас во флот, нам надо добраться до любой станции конфедерации." ), 7 );
        db_query( "UPDATE ships SET user_id = {$event['user_id']} WHERE id=".$event['arg5'] );
        step_up( $event['id'] );
      }
    break;

    case 3:
      $test = db_fetch_row( "SELECT id FROM ships WHERE id = ".$event['arg5'] );
      if( !$test['id'] ) {
        setChar( 'status', -1 * $event['arg3'], $event['user_id'] );

        send_msg( 1, $event['user_id'], t( "Корабль просивший вас о помощи потерян, вы нарушили договоренность! Конфедерация не одобряет ваших действий." ), 7 );
        step_up( $event['id'], -3 );
      }

      $test = db_fetch_row( "SELECT IFNULL(fleet_id,0) fleet FROM ships WHERE id = ".$event['arg5'] );
      if( $test['fleet'] ) {
        send_msg( 1, $event['user_id'], t( "В составе флота отбуксируйте корабль на ближайшую станцию конфедерации." ), 7 );
        step_up( $event['id'] );
      }
    break;

    case 2:
      $test = db_fetch_row( "SELECT id FROM ships WHERE id = ".$event['arg5'] );
      if( !$test['id'] ) {
        setChar( 'status', -1 * $event['arg3'], $event['user_id'] );
        send_msg( 1, $event['user_id'], t( "Корабль просивший вас о помощи потерян, вы нарушили договоренность! Конфедерация не одобряет ваших действий." ), 7 );
        step_up( $event['id'], -2 );
      }

      $test = db_fetch_row( "SELECT place_type FROM ships WHERE id = ".$event['arg5'] );
      if( $test['place_type'] == 3 ) {
        send_msg( 1, $event['user_id'], t( "Корабль доставлен на станцию, расформируйте флот для завершения задания." ), 7 );
        step_up( $event['id'] );
      }
    break;

    case 1:
      $test = db_fetch_row( "SELECT id FROM ships WHERE id = ".$event['arg5'] );
      if( !$test['id'] ) {
        setChar( 'status', -1 * $event['arg3'], $event['user_id'] );
        send_msg( 1, $event['user_id'], t( "Корабль просивший вас о помощи потерян, вы нарушили договоренность! Конфедерация не одобряет ваших действий." ), 7 );
        step_up( $event['id'], -1 );
      }

      $test = db_fetch_row( "SELECT place_type FROM ships WHERE fleet_id is null AND id = ".$event['arg5'] );
      if( $test['place_type'] == 3 ) {
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg2']} WHERE u.id = {$event['user_id']}" );
        setChar( 'status', $event['arg3'], $event['user_id'] );

        db_query( "DELETE FROM ships WHERE id = ".$event['arg5'] );
        send_msg( 1, $event['user_id'], t( "Конфедерация гордится вами! Корабль спасен и доставлен в целости и сохранности. Вы получаете %s кредитов.", array( $event['arg2'] ) ), 7 );
        step_up( $event['id'] );
      }
    break;
  }
}

function quest_courier_event( $event ) {
  switch( $event['status'] ) {
  
    case 5:
      db_query( "UPDATE users_quests SET arg0 = (SELECT id FROM stars WHERE name = '{$event['arg1']}') WHERE id = ".$event['id'] );
      db_query( "UPDATE users_quests SET arg2 = (SELECT id FROM stars WHERE name = '{$event['arg3']}') WHERE id = ".$event['id'] );
      db_query( "UPDATE users_quests SET arg8 = (SELECT id FROM stars WHERE name = '{$event['arg9']}') WHERE id = ".$event['id'] );

      $test = db_fetch_row( "SELECT place_type FROM users WHERE id = ".$event['user_id'] );
      if( $test['place_type'] != 2 && $test['place_type'] != 6 ) {
        send_msg( 1, $event['user_id'], t( "Вам необходим корабль для доставки секретного пакета. Для получения пакета необходимо ваше личное присутствие на корабле. После получения пакета вы можете сменить корабль, пакет всегда будет с вами." ), 7 );
      }
      step_up( $event['id'] );
    break;
    
    case 4:
      $test = db_fetch_row( "SELECT place_type FROM users WHERE id = ".$event['user_id'] );
      if( $test['place_type'] == 2 || $test['place_type'] == 6 ) {
        $upd = db_fetch_row( "SELECT ob1.id fid, ob2.id tid, ob3.id pid
                                FROM planets p1, orbits_buildings ob1, planets p2, orbits_buildings ob2, planets p3, orbits_buildings ob3
                               WHERE p1.star_id = {$event['arg0']} AND p1.id = ob1.planet_id AND ob1.object_id = 3001 AND
                                     p2.star_id = {$event['arg2']} AND p2.id = ob2.planet_id AND ob2.object_id = 3001 AND
                                     p3.star_id = {$event['arg8']} AND p3.id = ob3.planet_id AND ob3.object_id = 3001" );

        db_query( "UPDATE users_quests SET arg6 = {$upd['fid']}, arg7={$upd['tid']}, arg8={$upd['pid']} WHERE id = ".$event['id'] );

        send_msg( 1, $event['user_id'], t( "Летите в систему %s и пристыкуйтесь к торговой станции, не имеет значение на каком корабле, вы должны лично прилететь в систему. К вам на корабль поднимется наш человек и передаст пакет.", array( $event['arg1'] ) ), 7 );
        step_up( $event['id'] );
      }
    break;
    
    case 3:
      $test = db_fetch_row( "SELECT place_type, place_id FROM users WHERE id = ".$event['user_id'] );
      if( $test['place_type'] == 2 || $test['place_type'] == 6 ) {
        $ship = get_place_info( $test['place_id'], $test['place_type'] );
        if( $ship->place_type == 3 && $ship->place_id == $event['arg6'] ) {
          send_msg( 1, $event['user_id'], t( "Вы получили пакет, ваша задача как можно быстрее доставить его в систему %s, мы предприняли все меры по сохранению секретности, однако по пути вас могут перехватить, постарайтесь не вступать в конфликт. Помните, что вы лично должны присутствовать на корабле", array( $event['arg3'] ) ), 7 );
          step_up( $event['id'] );
        }
      }
    break;
    
    case 2:
      $test = db_fetch_row( "SELECT place_type, place_id FROM users WHERE id = ".$event['user_id'] );
      if( $test['place_type'] == 2 || $test['place_type'] == 6 ) {
        $ship = get_place_info( $test['place_id'], $test['place_type'] );
        if( $ship->place_type == 5 ) {
          $star = db_fetch_val( "SELECT arg2 FROM space_events se WHERE se.ship_id = ".$test['place_id'], 'arg2' );
          if( $star == $event['arg2'] ) {
            send_msg( 4, $event['user_id'], t( "Мы знаем, что вы везете пакет в систему %s, лучевой канал гиперпередачи невозможно отследить и мы с радостью сделаем вам щедрое предложение. Мы заплатим вам %d кредитов, если вы привезете пакет в систему %s.", array( $event['arg3'], $event['arg4']*2, $event['arg9'] ) ), 7 );
	      step_up( $event['id'] );
          }
        }

        if( $ship->place_type == 3 ) {
          if( $ship->place_id == $event['arg7'] ) {
            db_query( "UPDATE users u SET u.money = u.money + {$event['arg4']} WHERE u.id = {$event['user_id']}" );
            setChar( 'status', $event['arg5'], $event['user_id'] );

            send_msg( 1, $event['user_id'], t( "Конфедерация благодарит вас за оказанную услугу! Мы надеемся, что вы не будете говорить о проделанной работе, помните сведения которые вы привезли помогут спасти чью-то жизнь. В качества поощрения примите %d кредитов.", array( $event['arg4'] ) ), 7 );
            send_msg( 4, $event['user_id'], t( "Мы видели, как к вам на корабль пришел человек конфедерации, надеемся вы не сболтнули лишнего, потому что космос огромен и в нем часто теряются корабли..." ), 7 );
            step_up( $event['id'], -2 );
          }
          if( $ship->place_id == $event['arg8'] ) {
            db_query( "UPDATE users u SET u.money = u.money + ".($event['arg4']*2)." WHERE u.id = {$event['user_id']}" );
            setChar( 'status', $event['arg5'] * -10, $event['user_id'] );

            send_msg( 1, $event['user_id'], t( "Вы предали конфедерацию! В пакете были сведения которые могли спасти чью-то жизнь, из-за вас во вселенной будет больше смертей! Такие как вы позорят конфедерацию!" ), 7 );
            send_msg( 4, $event['user_id'], t( "Держите ваши тридцать серебренников, помните мы с вами не встречались, вы нам ничего не отдавали, к чему лишние хлопоты по потерянным кораблям. Тут ровно %d можете не пересчитывать.", array( $event['arg4']*2 ) ), 7 );
            step_up( $event['id'], -2 );
          }
        }
      }
    break;
    
    case 1:
      $test = db_fetch_row( "SELECT place_type, place_id FROM users WHERE id = ".$event['user_id'] );
      if( $test['place_type'] == 2 || $test['place_type'] == 6 ) {
        $ship = get_place_info( $test['place_id'], $test['place_type'] );
        if( $ship->place_type == 3 ) {
          if( $ship->place_id == $event['arg7'] ) {
            db_query( "UPDATE users u SET u.money = u.money + {$event['arg4']} WHERE u.id = {$event['user_id']}" );
            setChar( 'status', $event['arg5'], $event['user_id'] );

            send_msg( 1, $event['user_id'], t( "Конфедерация благодарит вас за оказанную услугу! Мы надеемся, что вы не будете говорить о проделанной работе, помните сведения которые вы привезли помогут спасти чью-то жизнь. В качества поощрения примите %d кредитов.", array( $event['arg4'] ) ), 7 );
            send_msg( 4, $event['user_id'], t( "Мы видели, как к вам на корабль пришел человек конфедерации, надеемся вы не сболтнули лишнего, потому что космос огромен и в нем часто теряются корабли..." ), 7 );
            step_up( $event['id'] );
          }
          if( $ship->place_id == $event['arg8'] ) {
            db_query( "UPDATE users u SET u.money = u.money + ".($event['arg4']*2)." WHERE u.id = {$event['user_id']}" );
            setChar( 'status', $event['arg5'] * -10, $event['user_id'] );

            send_msg( 1, $event['user_id'], t( "Вы предали конфедерацию! В пакете были сведения которые могли спасти чью-то жизнь, из-за вас во вселенной будет больше смертей! Такие как вы позорят конфедерацию!" ), 7 );
            send_msg( 4, $event['user_id'], t( "Держите ваши тридцать серебренников, помните мы с вами не встречались, вы нам ничего не отдавали, к чему лишние хлопоты по потерянным кораблям. Тут ровно %d можете не пересчитывать.", array( $event['arg4']*2 ) ), 7 );
            step_up( $event['id'] );
          }
        }
      }
    break;
  }
}

function quest_tritit_event( $event ) {
  switch( $event['status'] ) {
    case 4:
      db_query( "UPDATE users_quests SET arg0 = (SELECT id FROM stars WHERE name = '{$event['arg1']}') WHERE id = ".$event['id'] );
      $test = db_fetch_row( "SELECT count(*) cnt
                               FROM ships s
                         INNER JOIN ship_types st ON st.object_id = s.object_id
                              WHERE st.radar > 0 AND s.user_id = ".$event['user_id'] );
      if( $test['cnt'] == 0 ) {
        send_msg( 1, $event['user_id'], t( "Вам необходимо приобрести или построить радарный корабль. Трититы могут не перехватить ваш флот." ), 7 );
      } else {
        send_msg( 1, $event['user_id'], t( "Отправьте ваш флот к звезде %s. Не забудьте включить в состав флота радарный корабль. Трититы могут не перехватить ваш флот.", array( $event['arg1'] ) ), 7 );
      }
      step_up( $event['id'] );
    break;

    case 3:
      $test = db_fetch_row( "SELECT count(*) cnt
                               FROM ships s
                         INNER JOIN ship_types st ON st.object_id = s.object_id
                              WHERE s.place_type = 7 AND s.place_id = {$event['arg0']} AND st.radar > 0 AND s.user_id = ".$event['user_id'] );
      if( isset( $test['cnt'] ) && $test['cnt'] > 0 ) {
        do {
          $xr = mt_rand( 1, 684 );
          $yr = mt_rand( 1, 460 );
          $xdiff = 340 - $xr;
          $ydiff = 220 - $yr;
          $len = round( sqrt( $xdiff * $xdiff + $ydiff * $ydiff ) );
        } while ( $len < 30 );

        db_query( "INSERT INTO fleets ( user_id, place_type, place_id, arg1, arg2, inwar, guard ) VALUES ( 3, 7, {$event['arg0']}, $xr, $yr, 0, 1 )" );
        $fleet_id = mysql_insert_id();
        db_query( "UPDATE users_quests SET arg4 = $fleet_id WHERE id=".$event['id'] );

        $trit = array( 9141, 9146, 9148 );
        $shield = array( 5, 7, 10);
        for( $i=0; $i < $event['arg2']; $i++ ) {
          if( $event['type'] == 4 ) {
            $rnd = mt_rand(0,2);
          } else {
            $rnd = 2;
          }
          db_query( "INSERT INTO ships (object_id,     place_id, place_type, user_id,  name,    arg1, arg2, fleet_id,          shield, inwar, guard) VALUES
                                       ({$trit[$rnd]},{$event['arg0']},   7,       3, 'Тритит', $xr,  $yr,  $fleet_id,{$shield[$rnd]},     0,     1)" );
        }

        update_fleet( $fleet_id );

        send_msg( 1, $event['user_id'], t( "Найдите Трититов, их флот находится в этой системе! Для поиска переместитесь любым вашим кораблем к желтой метке" ), 7 );
        step_up( $event['id'] );
      }
    break;

    case 2:
      $test = db_fetch_row( "SELECT id FROM fleets WHERE id = ".$event['arg4'] );
      if( !$test['id'] ) {
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg3']} WHERE u.id = {$event['user_id']}" );
        setChar( 'status', $event['arg2'], $event['user_id'] );

        send_msg( 1, $event['user_id'], t( "Флот Трититов разбит! Возможно Вам помогли, но это все равно великолепное выполнение миссии. Вы получаете %d кредитов.", array( $event['arg3'] ) ), 7 );
        step_up( $event['id'], -2 );
      } else {
        $lost = db_fetch_row( "SELECT arg1, arg2 FROM fleets WHERE id = ".$event['arg4'] );
        $test = db_fetch_row( "SELECT count(*) cnt
                                 FROM ships
                                WHERE place_type = 7 AND place_id = {$event['arg0']} AND arg1 = {$lost['arg1']} AND arg2 = {$lost['arg2']} AND user_id = ".$event['user_id'] );      
        if( $test['cnt'] ) {
          send_msg( 1, $event['user_id'], t( "Уничтожьте Трититов! Ваш флот должен одержать победу в этой битве!" ), 7 );
          step_up( $event['id'] );
        }
      }
    break;

    case 1:
      $test = db_fetch_row( "SELECT id FROM fleets WHERE id = ".$event['arg4'] );
      if( !$test['id'] ) {
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg3']} WHERE u.id = {$event['user_id']}" );
        setChar( 'status', $event['arg2'], $event['user_id'] );

        send_msg( 1, $event['user_id'], t( "Флот Трититов разбит, вы проявили себя как истинный военачальник! Вы получаете %d кредитов.", array( $event['arg3'] ) ), 7 );
        step_up( $event['id'] );
      }
    break;
  }
}

function quest_pirates_event( $event ) {
  switch( $event['status'] ) {
    case 4:
      db_query( "UPDATE users_quests SET arg0 = (SELECT id FROM stars WHERE name = '{$event['arg1']}') WHERE id = ".$event['id'] );
      db_query( "UPDATE users_quests SET arg2 = (SELECT id FROM planets WHERE name = '{$event['arg3']}') WHERE id = ".$event['id'] );

      send_msg( 1, $event['user_id'], t( "Отправьте ваш флот к звезде %s. Пираты оккупировали планету %s и требуют у конфедерации выкуп за освобождение планеты. Расправьтесь с вражеским флотом.", array( $event['arg1'], $event['arg3'] ) ), 7 );
      step_up( $event['id'] );
    break;

    case 3:
      $test = db_fetch_row( "SELECT count(*) cnt
                               FROM ships s
                         INNER JOIN ship_types st ON st.object_id = s.object_id
                              WHERE s.place_type = 7 AND s.place_id = {$event['arg0']} AND s.user_id = ".$event['user_id'] );
      if( isset( $test['cnt'] ) && $test['cnt'] ) {

        db_query( "INSERT INTO fleets ( user_id, place_type,         place_id, arg1, arg2, guard, abordage )
                               VALUES (       4,          0, {$event['arg2']}, null, null,     1,        0 )" );
        $fleet_id = mysql_insert_id();
        db_query( "UPDATE users_quests SET arg6 = $fleet_id WHERE id=".$event['id'] );

        $pirates = array( 9072, 9128, 9053, 9136, 9042, 9021, 9167, 9127, 9080, 9280, 9260, 9264, 9284, 9295, 9281 );
        $shield  = array( 2000, 250,  2000, 6000, 500,  100,  200,  100,  500, 10100,10100,10100,   -1,   -1,   -1 );
        $missile = array( 9215,    0, 9215, 9215, 9212, 9210, 9211, 9210, 9209,    0,    0,    0,    0,    0,    0 );

        for( $i=0; $i < $event['arg4']; $i++ ) {
          $rnd = mt_rand(0,count($pirates)-1);

          db_query( "INSERT INTO ships (object_id,       place_id, place_type, user_id, name,    arg1, arg2, fleet_id,          shield, inwar, guard, abordage) VALUES
                                       ({$pirates[$rnd]},{$event['arg2']},  0,       4, 'Пираты',null, null, $fleet_id,{$shield[$rnd]},     0,     1,        0)" );
          $ship_id = mysql_insert_id();
          if( $missile[$rnd] > 0 ) {
            add_warehouse_item( 2, $ship_id, $missile[$rnd], 4 );
          }
        }

        update_fleet( $fleet_id );

        send_msg( 1, $event['user_id'], t( "Атакуйте орбиту захваченной планеты %s! Флот пиратов находится на орбите.", array( $event['arg3'] ) ), 7 );
        step_up( $event['id'] );
      }
    break;

    case 2:
      $test = db_fetch_row( "SELECT id FROM fleets WHERE id = ".$event['arg6'] );
      if( !$test['id'] ) {
        db_query( "UPDATE users u SET u.pirate_status = u.pirate_status + 1, u.money = u.money + {$event['arg5']} WHERE u.id = {$event['user_id']}" );
        setChar( 'status', $event['arg4'], $event['user_id'] );

        send_msg( 1, $event['user_id'], t( "Флот пиратов разбит! Возможно Вам помогли, но это все равно великолепное выполнение миссии. Вы получаете %d кредитов.", array( $event['arg5'] ) ), 7 );
        step_up( $event['id'], -2 );
      } else {
        $test = db_fetch_row( "SELECT count(*) cnt FROM ships WHERE place_type = 0 AND place_id = {$event['arg2']} AND user_id = ".$event['user_id'] );
        if( $test['cnt'] ) {
          send_msg( 1, $event['user_id'], t( "Уничтожьте пиратов! Ваш флот должен одержать победу в этой битве!" ), 7 );
          step_up( $event['id'] );
        }
      }
    break;

    case 1:
      $test = db_fetch_row( "SELECT id FROM fleets WHERE id = ".$event['arg6'] );
      if( !$test['id'] ) {
        db_query( "UPDATE users u SET u.pirate_status = u.pirate_status + 1, u.money = u.money + {$event['arg5']} WHERE u.id = {$event['user_id']}" );
        setChar( 'status', $event['arg4'], $event['user_id'] );

        send_msg( 1, $event['user_id'], t( "Флот пиратов разбит, вы проявили себя как истинный военачальник! Вы получаете %d кредитов.", array( $event['arg5'] ) ), 7 );
        step_up( $event['id'] );
      }
    break;
  }
}

function quest_dolphin_event( $event ) {

  // args: 0 - object, 1 - count, 2 - b-price, 3 - s-price, 4,5 - stars, 6,7 - ships, 8,9 - planets (stations)
  switch( $event['status'] ) {
    case 4: // fly to stars
      $fstar = db_fetch_row( "SELECT x, y FROM stars WHERE id = {$event['arg4']}" );
      $tstar = db_fetch_row( "SELECT x, y FROM stars WHERE id = {$event['arg5']}" );

      $len = round( sqrt( ( pow( $fstar['x'] - $tstar['x'], 2 ) + pow( $fstar['y'] - $tstar['y'], 2 ) ) ) );

      if( $event['arg8'] == 1 ) {
        $time = get_smove_time( $len * 20, 1, 6 );
      } else {
        $time = get_smove_time( $len, 15, 6 );
      }

      db_query( "UPDATE ships SET guard = 0, arg1 = null, arg2 = null, place_type = 5, place_id = 0 WHERE id IN( {$event['arg6']}, {$event['arg7']} )" );
      db_query( "INSERT INTO space_events ( event_type, ship_id, event_time, timer, user_id, arg1, arg2, from_arg1, from_arg2, from_type )
                                   VALUES ( 4, {$event['arg6']}, DATE_ADD( NOW(), INTERVAL $time SECOND ), $time, 6, 0, {$event['arg5']}, 0, 0, 0 )" );
      $inter = db_fetch_array( "SELECT f.user_id, f.interupt, f.name, s.name sname
                                  FROM fleets f
                            INNER JOIN stars s ON s.id = f.place_id
                                 WHERE f.interupt > 0 AND f.place_type = 7 AND f.place_id = {$event['arg5']}
                                union
                                SELECT s.user_id, s.interupt, s.name, st.name sname
                                  FROM ships s
                            INNER JOIN stars st ON st.id = s.place_id
                                 WHERE s.fleet_id IS NULL AND s.interupt > 0 AND s.place_type = 7 AND s.place_id = {$event['arg5']}" );

      if( count( $inter ) ) {
        foreach( $inter as $mess ) {
          if( $mess['interupt'] == 1 ) {
            send_msg( 1, $mess['user_id'], t( "Обнаружено искажение пространства в системе %s перехватчиком %s. Приближается корабль Дельфинов. Ожидается прибытие через %s", array( $mess['sname'], $mess['name'], time_to_str( $time ) ) ), 6 );
          } else {
            send_msg( 1, $mess['user_id'], t( "Обнаружено искажение пространства в системе %s перехватчиком %s, возможен гиперперехват. Приближается корабль Дельфинов. Ожидается прибытие через %s", array( $mess['sname'], $mess['name'], time_to_str( $time ) ) ), 6 );
          }
        }
      }

      db_query( "INSERT INTO space_events ( event_type, ship_id, event_time, timer, user_id, arg1, arg2, from_arg1, from_arg2, from_type )
                                   VALUES ( 4, {$event['arg7']}, DATE_ADD( NOW(), INTERVAL $time SECOND ), $time, 6, 0, {$event['arg4']}, 0, 0, 0 )" );
      $inter = db_fetch_array( "SELECT f.user_id, f.interupt, f.name, s.name sname
                                  FROM fleets f
                            INNER JOIN stars s ON s.id = f.place_id
                                 WHERE f.interupt > 0 AND f.place_type = 7 AND f.place_id = {$event['arg4']}
                                union
                                SELECT s.user_id, s.interupt, s.name, st.name sname
                                  FROM ships s
                            INNER JOIN stars st ON st.id = s.place_id
                                 WHERE s.fleet_id IS NULL AND s.interupt > 0 AND s.place_type = 7 AND s.place_id = {$event['arg4']}" );

      if( count( $inter ) ) {
        foreach( $inter as $mess ) {
          if( $mess['interupt'] == 1 ) {
            send_msg( 1, $mess['user_id'], t( "Обнаружено искажение пространства в системе %s перехватчиком %s. Приближается корабль Дельфинов. Ожидается прибытие через %s", array( $mess['sname'], $mess['name'], time_to_str( $time ) ) ), 6 );
          } else {
            send_msg( 1, $mess['user_id'], t( "Обнаружено искажение пространства в системе %s перехватчиком %s, возможен гиперперехват. Приближается корабль Дельфинов. Ожидается прибытие через %s", array( $mess['sname'], $mess['name'], time_to_str( $time ) ) ), 6 );
          }
        }
      }

      step_up( $event['id'] );
    break;

    case 3: // fly to planets
      $test = db_fetch_val( "SELECT COUNT(*) cnt FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6 AND place_type = 7 AND inwar = 0", 'cnt' );
      if( $test == 2 ) {
        db_query( "UPDATE ships SET guard = 0, arg1 = null, arg2 = null, place_type = 5, place_id = {$event['arg5']} WHERE id = {$event['arg6']}" );
        db_query( "UPDATE ships SET guard = 0, arg1 = null, arg2 = null, place_type = 5, place_id = {$event['arg4']} WHERE id = {$event['arg7']}" );
        if( $event['arg8'] == 1 ) {
          $time = get_pmove_time( 250, 2, 6 );
        } else {
          $time = get_pmove_time( 250, 15, 6 );
        }

        $pto = db_fetch_val( "SELECT id FROM planets WHERE star_id = {$event['arg5']} AND user_id IS NOT null", 'id' );
        $pfrom = db_fetch_val( "SELECT id FROM planets WHERE star_id = {$event['arg4']} AND user_id IS NOT null", 'id' );

        db_query( "UPDATE users_quests SET arg8 = $pto, arg9 = $pfrom WHERE id=".$event['id'] );
        db_query( "INSERT INTO space_events ( event_type, ship_id,                               event_time, timer, user_id, arg1, arg2, from_arg1, from_arg2, from_type )
                                     VALUES ( 3, {$event['arg6']}, DATE_ADD( NOW(), INTERVAL $time SECOND ), $time,        6,   0, $pto,         0,         0,         0 )" );
        db_query( "INSERT INTO space_events ( event_type, ship_id,                               event_time, timer, user_id, arg1,   arg2, from_arg1, from_arg2, from_type )
                                     VALUES ( 3, {$event['arg7']}, DATE_ADD( NOW(), INTERVAL $time SECOND ), $time,        6,   0, $pfrom,         0,         0,         0 )" );

        step_up( $event['id'] );
      } else {
        $test = db_fetch_val( "SELECT COUNT(*) cnt FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6", 'cnt' );
        if( $test < 2 ) {
          db_query( "DELETE FROM warehouse WHERE place_type = 2 AND place_id IN( {$event['arg6']}, {$event['arg7']} )" );
          db_query( "DELETE FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6" );
          step_up( $event['id'], -3 );
        }
      }
    break;

    case 2: // dock
      $test = db_fetch_val( "SELECT COUNT(*) cnt FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6 AND place_type = 0 AND inwar = 0", 'cnt' );
      if( $test == 2 ) {
        $sto = db_fetch_val( "SELECT id FROM orbits_buildings WHERE planet_id = {$event['arg8']} AND object_id = 3001", 'id' );
        $sfrom = db_fetch_val( "SELECT id FROM orbits_buildings WHERE planet_id = {$event['arg9']} AND object_id = 3001", 'id' );

        db_query( "UPDATE users_quests SET arg8 = $sto, arg9 = $sfrom WHERE id=".$event['id'] );

        db_query( "UPDATE ships SET guard = 0, place_type = 3, place_id = $sto WHERE id = {$event['arg6']}" );
        db_query( "UPDATE ships SET guard = 0, place_type = 3, place_id = $sfrom WHERE id = {$event['arg7']}" );

        step_up( $event['id'] );
      } else {
        $test = db_fetch_val( "SELECT COUNT(*) cnt FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6", 'cnt' );
        if( $test < 2 ) {
          db_query( "DELETE FROM warehouse WHERE place_type = 2 AND place_id IN( {$event['arg6']}, {$event['arg7']} )" );
          db_query( "DELETE FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6" );
          step_up( $event['id'], -2 );
        }
      }
    break;

    case 1: // test & trade
      $test = db_fetch_val( "SELECT COUNT(*) cnt FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6 AND place_type = 3 AND inwar = 0", 'cnt' );
      if( $test == 2 ) {
        $tin = db_fetch_row( "SELECT ti.object_cnt, p.user_id, p.id planet_id, ti.price, o.name
                                FROM trade_in ti
                          INNER JOIN objects o ON o.id = ti.object_id
                          INNER JOIN orbits_buildings ob ON ob.id = ti.ob_id
                          INNER JOIN planets p ON p.id = ob.planet_id
                               WHERE ti.price >= {$event['arg2']} AND
                                     ti.object_id = {$event['arg0']} AND
                                     ti.object_cnt >= {$event['arg1']} AND 
                                     ti.ob_id = {$event['arg9']}" );

        $tou = db_fetch_row( "SELECT tu.object_cnt, p.user_id, tu.price, o.name
                                FROM trade_out tu
                          INNER JOIN objects o ON o.id = tu.object_id
                          INNER JOIN orbits_buildings ob ON ob.id = tu.ob_id
                          INNER JOIN planets p ON p.id = ob.planet_id
                               WHERE tu.price <= {$event['arg3']} AND
                                     tu.object_id = {$event['arg0']} AND
                                     tu.object_cnt >= {$event['arg1']} AND 
                                     tu.ob_id = {$event['arg8']}" );

        if( isset( $tin['user_id'] ) && isset( $tou['user_id'] ) && $tin['object_cnt'] >= $event['arg1'] && $tou['object_cnt'] >= $event['arg1'] ) {

          if( $tin['object_cnt'] > $event['arg1'] ) {
            db_query( "UPDATE trade_in SET object_cnt = object_cnt - {$event['arg1']} WHERE object_id = {$event['arg0']} AND ob_id = {$event['arg9']}" );
          } else {
            db_query( "DELETE FROM trade_in WHERE object_id = {$event['arg0']} AND ob_id = {$event['arg9']}" );
          }
          $summ = number_format( $event['arg1'] * $tin['price'], 2, '.', '' );

          db_query( "INSERT INTO trade_log ( bayer_id, seller_id, object_id, object_cnt, log_sum ) VALUES ( {$tin['user_id']}, 6, {$event['arg0']}, {$event['arg1']}, '$summ' )" );
          db_query( "UPDATE users SET money = money + '$summ' WHERE id = 6" );

          if( $tin['planet_id'] != 21222 ) {
            add_warehouse_item( 0, $tin['planet_id'], $event['arg0'], $event['arg1'] );
          }

          send_msg( 6, $tin['user_id'], t( "Вам продали %s в количестве %s на общую сумму %s.", array( $tin['name'], $event['arg1'], $summ ) ), 16 );

          if( $tou['object_cnt'] > $event['arg1'] ) {
            db_query( "UPDATE trade_out SET object_cnt = object_cnt - {$event['arg1']} WHERE object_id = {$event['arg0']} AND ob_id = {$event['arg8']}" );
          } else {
            db_query( "DELETE FROM trade_out WHERE object_id = {$event['arg0']} AND ob_id = {$event['arg8']}" );
          }
          $summ = number_format( $event['arg1'] * $tou['price'], 2, '.', '' );

          db_query( "INSERT INTO trade_log ( bayer_id, seller_id, object_id, object_cnt, log_sum ) VALUES ( 6, {$tou['user_id']}, {$event['arg0']}, {$event['arg1']}, '$summ' )" );
          db_query( "UPDATE users SET money = money - '$summ' WHERE id = 6" );
          db_query( "UPDATE users SET money = money + '$summ' WHERE id = ".$tou['user_id'] );

          send_msg( 6, $tou['user_id'], t( "У вас купили %s в количестве %s на общую сумму %s.", array( $tou['name'], $event['arg1'], $summ ) ), 16 );
        }

        db_query( "DELETE FROM warehouse WHERE place_type = 2 AND place_id IN( {$event['arg6']}, {$event['arg7']} )" );
        db_query( "DELETE FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6" );
        step_up( $event['id'] );
      } else {
        $test = db_fetch_val( "SELECT COUNT(*) cnt FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6", 'cnt' );
        if( $test < 2 ) {
          db_query( "DELETE FROM warehouse WHERE place_type = 2 AND place_id IN( {$event['arg6']}, {$event['arg7']} )" );
          db_query( "DELETE FROM ships WHERE id IN( {$event['arg6']}, {$event['arg7']} ) AND user_id = 6" );
          step_up( $event['id'] );
        }
      }
    break;
  }
}

function quest_atack_event( $event ) {

  // args: 0 - star_id, 1 - planet_id, 2 - fleet_id
  if( $event['status'] > 1 ) {
    step_up( $event['id'] );
  }

  if( $event['status'] == 1 ) {

    $test = db_fetch_row( "SELECT f.place_type, f.planet FROM fleets f WHERE f.inwar = 0 AND f.id = {$event['arg2']}" );
    if( $test['place_type'] == 7 ) {
      db_query( "UPDATE fleets SET guard = 1, arg1 = null, arg2 = null, place_type = 5, place_id = {$event['arg0']} WHERE id = {$event['arg2']}" );
      db_query( "UPDATE ships SET guard = 1, arg1 = null, arg2 = null, place_type = 5, place_id = {$event['arg0']} WHERE fleet_id = {$event['arg2']}" );

      $time = get_pmove_time( 250, $test['planet'], 4 );
      db_query( "INSERT INTO space_events ( event_type,   ship_id,                               event_time, timer, user_id, arg1,             arg2, from_arg1, from_arg2, from_type )
                                   VALUES ( 103, {$event['arg2']}, DATE_ADD( NOW(), INTERVAL $time SECOND ), $time,       4,    0, {$event['arg1']},         0,         0,         0 )" );

      step_up( $event['id'] );
    } else if( $test['place_type'] === null ) {
      step_up( $event['id'] );
    }
  }
}

function quest_explore_event( $event ) {
  // args: 0 - premium, 1 - type, 2,3 - coords, 4 - control object, 5 - control type(0=ship, 1=fleet)
  switch( $event['status'] ) {

    case 2: // generate objects

      $xr = $event['arg2'];
      $yr = $event['arg3'];
      send_msg( 1, $event['user_id'], t( "Отправьте ваш флот на исследование точки пространства %d:%d.", array( $xr, $yr ) ), 7 );

      switch( $event['arg1'] ) {

        case 0: // Pirate ship with TGP full of rockets
          db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id,     name, arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                       (     9136,        0,          8,       4, 'Hunter',  $xr,  $yr,     NULL,   6000,     0,     1)" );
          $ship_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $ship_id, arg5 = 0 WHERE id = ".$event['id'] );

          db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id,    name, arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                       (     9010,        0,          8,    null, 'Wares',  $xr,  $yr,     NULL,    500,     0,     0)" );
          $ship_id = mysql_insert_id();
          add_warehouse_item( 2, $ship_id, 9215, 4 );
          break;

        case 1: // Abandon with strange layout
          db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id,    name, arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                       (     9010,        0,          8,    null, 'Trade',  $xr,  $yr,     NULL,    500,     0,     0)" );
          $ship_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $ship_id, arg5 = 0 WHERE id = ".$event['id'] );

          $layouts = db_fetch_array( "SELECT o.id FROM objects o WHERE o.class = 6 AND o.make_time > 0 ORDER BY rand() LIMIT 0, 4" );
          foreach( $layouts as $lay ) {
            add_warehouse_item( 2, $ship_id, $lay['id'], 1 );
          }
          break;

        case 2: // Pirates (40-150)
          db_query( "INSERT INTO fleets (              name, user_id, place_type, place_id, arg1, arg2, guard, abordage ) 
                                 VALUES ( '".t('Пираты')."',       4,          8,        0,  $xr,  $yr,     1,        0 )" );
          $fleet_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $fleet_id, arg5 = 1 WHERE id = ".$event['id'] );

          $pirates = array( 9053, 9077, 9072, 9042, 9080, 9167, 9230, 9127, 9021, 9280, 9260, 9264, 9284, 9295, 9281 );
          $shield  = array( 2000, 2000, 2000,  500,  500,  200,  500,  100,  100,10100,10100,10100,   -1,   -1,   -1 );
          $missile = array( 9215,    0, 9215, 9212, 9209, 9211, 9215, 9210, 9210,    0,    0,    0,    0,    0,    0 );

          $cnt = mt_rand( 40, 150 );
          for( $i=0; $i < $cnt; $i++ ) {
            $rnd = mt_rand(0,count($pirates)-1);

            db_query( "INSERT INTO ships (       object_id, place_type, place_id, user_id,              name, arg1, arg2, fleet_id,           shield, inwar, guard, abordage)
                                  VALUES ({$pirates[$rnd]},          8,        0,       4, '".t('Пираты')."',  $xr,  $yr, $fleet_id, {$shield[$rnd]},     0,     1,        0)" );
            $ship_id = mysql_insert_id();
            if( $missile[$rnd] > 0 ) {
              add_warehouse_item( 2, $ship_id, $missile[$rnd], 4 );
            }
          }
          update_fleet( $fleet_id );
          break;

        case 3: // Abandon aircraft carrier and 20-30 pirates
          db_query( "INSERT INTO fleets (     name, user_id, place_type, place_id, arg1, arg2, guard, abordage ) 
                                 VALUES ( 'Пираты',       4,          8,        0,  $xr,  $yr,     1,        0 )" );
          $fleet_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $fleet_id, arg5 = 1 WHERE id = ".$event['id'] );

          $pirates = array( 9053, 9077, 9072, 9042, 9080, 9167, 9230, 9127, 9021, 9280, 9260, 9264, 9284, 9295, 9281 );
          $shield  = array( 2000, 2000, 2000,  500,  500,  200,  500,  100,  100,10100,10100,10100,   -1,   -1,   -1 );
          $missile = array( 9215,    0, 9215, 9212, 9209, 9211, 9215, 9210, 9210,    0,    0,    0,    0,    0,    0 );

          $cnt = mt_rand( 40, 50 );
          for( $i=0; $i < $cnt; $i++ ) {
            $rnd = mt_rand(0,count($pirates)-1);

            db_query( "INSERT INTO ships (       object_id, place_type, place_id, user_id,              name, arg1, arg2, fleet_id,           shield, inwar, guard, abordage)
                                  VALUES ({$pirates[$rnd]},          8,        0,       4, '".t('Пираты')."',  $xr,  $yr, $fleet_id, {$shield[$rnd]},     0,     1,        0)" );
            $ship_id = mysql_insert_id();
            if( $missile[$rnd] > 0 ) {
              add_warehouse_item( 2, $ship_id, $missile[$rnd], 4 );
            }
          }
          update_fleet( $fleet_id );

          db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id,    name, arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                       (     9010,        0,          8,    null, 'Trade',  $xr,  $yr,     NULL,    500,     0,     0)" );

          $ship_id = mysql_insert_id();
          $layouts = db_fetch_array( "SELECT o.id FROM objects o WHERE o.class = 6 AND o.make_time > 0 ORDER BY rand() LIMIT 0, 4" );
          foreach( $layouts as $lay ) {
            add_warehouse_item( 2, $ship_id, $lay['id'], 1 );
          }
          break;

        case 4: // Fleet of tritit (100-300)
          db_query( "INSERT INTO fleets (     name, user_id, place_type, place_id, arg1, arg2, guard ) 
                                 VALUES ( 'Тритит',       3,          8,        0,  $xr,  $yr,     1 )" );
          $fleet_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $fleet_id, arg5 = 1 WHERE id = ".$event['id'] );

          $pirates = array( 9141, 9146, 9148 );
          $shield  = array(    5,    7,   10 );

          $cnt = mt_rand( 100, 300 );
          for( $i=0; $i < $cnt; $i++ ) {
            $rnd = mt_rand(0,count($pirates)-1);

            db_query( "INSERT INTO ships (       object_id, place_type, place_id, user_id,              name, arg1, arg2, fleet_id,           shield, inwar, guard)
                                  VALUES ({$pirates[$rnd]},          8,        0,       3, '".t('Тритит')."',  $xr,  $yr, $fleet_id, {$shield[$rnd]},     0,     1)" );
            $ship_id = mysql_insert_id();
          }
          update_fleet( $fleet_id );
          break;

        case 5: // Abandon ship
          $type = db_fetch_val( "SELECT object_id FROM ship_types WHERE titul = 0 AND hyper > 0 AND planet > 0 ORDER BY rand() LIMIT 0, 1", 'object_id' );
          db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id,    name, arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                       (    $type,        0,          8,    null, 'Trade',  $xr,  $yr,     NULL,    500,     0,     0)" );
          $ship_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $ship_id, arg5 = 0 WHERE id = ".$event['id'] );
          break;

        case 6: // Abandon TGP full of some mineral
          db_query( "INSERT INTO ships (object_id, place_id, place_type, user_id,    name, arg1, arg2, fleet_id, shield, inwar, guard) VALUES
                                       (     9010,        0,          8,    null, 'Trade',  $xr,  $yr,     NULL,    500,     0,     0)" );
          $ship_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $ship_id, arg5 = 0 WHERE id = ".$event['id'] );

          $mineral = db_fetch_val( "SELECT o.id FROM objects o WHERE o.class = 1 ORDER BY rand() LIMIT 0, 1" );
          add_warehouse_item( 2, $ship_id, $mineral, 12000 );
          break;

        case 7: // A2 - alone
          db_query( "INSERT INTO ships ( object_id, place_id, place_type, user_id, name, arg1, arg2, fleet_id, shield, inwar, guard ) VALUES
                                       (      9358,        0,          8,       4, 'A2',  $xr,  $yr,     NULL,     -1,     0,     1 )" );
          $ship_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg4 = $ship_id, arg5 = 0 WHERE id = ".$event['id'] );
          break;
      }

      step_up( $event['id'] );
      break;

    case 1: // mission accomplished
      switch( $event['arg5'] ) {
        case 0:
          $control = db_fetch_val( "SELECT s.id FROM ships s WHERE s.place_type = 8 AND s.arg1 = {$event['arg2']} AND s.arg2 = {$event['arg3']} AND s.id = ".$event['arg4'], 'id' );
          break;
        case 1:
          $control = db_fetch_val( "SELECT f.id FROM fleets f WHERE f.place_type = 8 AND f.arg1 = {$event['arg2']} AND f.arg2 = {$event['arg3']} AND f.id = ".$event['arg4'], 'id' );
          break;
        default:
          $control = null;
          break;
      }

      if( $control === null ) {
        send_msg( 1, $event['user_id'], t( "Конфедерация гордится вами! Все, что вы обнаружили в этой точке по праву принадлежит вам." ), 7 );
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg0']} WHERE u.id = {$event['user_id']}" );
        setChar( 'status', $event['arg0'], $event['user_id'] );

        step_up( $event['id'] );
      }
      break;
  }
}

function quest_battle_event( $event ) {
  // args: 0 - premium, 1 - type, 2,3 - coords, 4 - confederate fleet, 5 - pirate fleet
  switch( $event['status'] ) {

    case 3: // generate objects and subquest
      $xr = $event['arg2'];
      $yr = $event['arg3'];
      send_msg( 1, $event['user_id'], t( "Отправьте ваш флот в точку пространства %d:%d.", array( $xr, $yr ) ), 7 );
      send_msg( 4, $event['user_id'], t( "Мы знаем, что вы отправляетесь в точку пространства %d:%d, наши радары засекли вас, лучевой канал гиперпередачи невозможно отследить и мы с радостью сделаем вам предложение. Мы заплатим вам %d кредитов, если по прилету вы атакуете флот конфедерации.", array( $xr, $yr, $event['arg0'] ) ), 7 );

      $cnt = mt_rand( 80, 200 );

      db_query( "INSERT INTO fleets (              name, user_id, place_type, place_id, arg1, arg2, guard, abordage ) 
                             VALUES ( '".t('Пираты')."',       4,          8,        0,  $xr,  $yr,     0,        0 )" );
      $p_fleet_id = mysql_insert_id();
      db_query( "UPDATE users_quests SET arg5 = $p_fleet_id WHERE id = ".$event['id'] );

      $pirates = array( 9053, 9077, 9072, 9042, 9080, 9167, 9230, 9127, 9021, 9280, 9260, 9264, 9284, 9295, 9281 );
      $shield  = array( 2000, 2000, 2000,  500,  500,  200,  500,  100,  100,10100,10100,10100,   -1,   -1,   -1 );
      $missile = array( 9215,    0, 9215, 9212, 9209, 9211, 9215, 9210, 9210,    0,    0,    0,    0,    0,    0 );

      for( $i=0; $i < $cnt; $i++ ) {
        $rnd = mt_rand(0,count($pirates)-1);

        db_query( "INSERT INTO ships (       object_id, place_type, place_id, user_id,              name, arg1, arg2,    fleet_id,          shield, inwar, guard, abordage)
                              VALUES ({$pirates[$rnd]},          8,        0,       4, '".t('Пираты')."',  $xr,  $yr, $p_fleet_id, {$shield[$rnd]},     0,     0,        0)" );
        $ship_id = mysql_insert_id();
        if( $missile[$rnd] > 0 ) {
          add_warehouse_item( 2, $ship_id, $missile[$rnd], 4 );
        }
      }
      update_fleet( $p_fleet_id );

      db_query( "INSERT INTO fleets (                    name, user_id, place_type, place_id, arg1, arg2, guard, abordage ) 
                             VALUES ( '".t('Конфедерация')."',       5,          8,        0,  $xr,  $yr,     0,        0 )" );
      $c_fleet_id = mysql_insert_id();
      db_query( "UPDATE users_quests SET arg4 = $c_fleet_id WHERE id = ".$event['id'] );

      $pirates = array( 9053, 9077, 9072, 9042, 9080, 9167, 9230, 9127, 9021, 9280, 9260, 9264, 9284, 9295, 9281 );
      $shield  = array( 2000, 2000, 2000,  500,  500,  200,  500,  100,  100,10100,10100,10100,   -1,   -1,   -1 );
      $missile = array( 9215,    0, 9215, 9212, 9209, 9211, 9215, 9210, 9210,    0,    0,    0,    0,    0,    0 );

      for( $i=0; $i < $cnt; $i++ ) {
        $rnd = mt_rand(0,count($pirates)-1);

        db_query( "INSERT INTO ships (       object_id, place_type, place_id, user_id,                    name, arg1, arg2,    fleet_id,          shield, inwar, guard, abordage)
                              VALUES ({$pirates[$rnd]},          8,        0,       5, '".t('Конфедерация')."',  $xr,  $yr, $c_fleet_id, {$shield[$rnd]},     0,     0,        0)" );
        $ship_id = mysql_insert_id();
        if( $missile[$rnd] > 0 ) {
          add_warehouse_item( 2, $ship_id, $missile[$rnd], 4 );
        }
      }
      update_fleet( $c_fleet_id );

      db_query( "INSERT INTO users_quests ( status, type,             arg0,             arg2,             arg3,        arg4,        arg5,           arg6 )
                                   VALUES (      3,   14, {$event['arg0']}, {$event['arg2']}, {$event['arg3']}, $c_fleet_id, $p_fleet_id, {$event['id']} )" );

      step_up( $event['id'] );
      break;

    case 2: // Start war!
      $isend = db_fetch_val( "SELECT count(*) cnt FROM fleets f WHERE f.id IN ( {$event['arg4']}, {$event['arg5']} )", 'cnt' );
      if( $isend < 2 ) {
        step_up( $event['id'] );
      }

      $wars = db_fetch_val( "SELECT count(*) cnt
                               FROM war_events
                              WHERE ( a_type = 1 AND a_object_id IN ( {$event['arg4']}, {$event['arg5']} ) ) OR
                                    ( d_type = 1 AND d_object_id IN ( {$event['arg4']}, {$event['arg5']} ) )", 'cnt' );
      if( $wars > 0 ) {
        db_query( "UPDATE fleets SET guard = 2 WHERE id IN ( {$event['arg4']}, {$event['arg5']} )" );
        db_query( "UPDATE ships SET guard = 2 WHERE fleet_id IN ( {$event['arg4']}, {$event['arg5']} )" );

        StartWar( 1, $event['arg4'], 1, $event['arg5'] );

        step_up( $event['id'] );
      }

      break;

    case 1: // mission accomplished
      $isend = db_fetch_val( "SELECT count(*) cnt FROM fleets f WHERE f.id IN ( {$event['arg4']}, {$event['arg5']} )", 'cnt' );

      if( $isend < 2 ) {
        send_msg( 1, $event['user_id'], t( "Вы оказали неоценимую поддержку в этой битве и по праву получаете заработанные деньги." ), 7 );
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg0']} WHERE u.id = {$event['user_id']}" );

        db_query( "DELETE FROM ships WHERE fleet_id IN ( {$event['arg4']}, {$event['arg5']} )" );
        db_query( "DELETE FROM fleets WHERE id IN ( {$event['arg4']}, {$event['arg5']} )" );
        db_query( "DELETE FROM users_quests WHERE type = 14 AND user_id IS NULL AND arg6 = ".$event['id'] );
        db_query( "UPDATE users_quests SET status = 1 WHERE type = 14 AND arg6 = ".$event['id'] );

        step_up( $event['id'] );
      }
      break;
  }
}

function quest_battle2_event( $event ) {

  // args: 0 - premium, 1 - type, 2,3 - coords, 4 - confederate fleet, 5 - pirate fleet, 6 - primary quest ID
  switch( $event['status'] ) {

    case 3: // Generate clone quest.
      db_query( "INSERT INTO users_quests ( status, type,             arg0,             arg2,             arg3,             arg4,             arg5,             arg6 )
                                   VALUES (      3,   14, {$event['arg0']}, {$event['arg2']}, {$event['arg3']}, {$event['arg4']}, {$event['arg5']}, {$event['arg6']} )" );

      step_up( $event['id'] );
      break;

    case 2: // Start war!
      $isend = db_fetch_val( "SELECT count(*) cnt FROM fleets f WHERE f.id IN ( {$event['arg4']}, {$event['arg5']} )", 'cnt' );
      if( $isend < 2 ) {
        step_up( $event['id'] );
      }

    case 1:
      $isend = db_fetch_val( "SELECT count(*) cnt FROM fleets f WHERE f.id IN ( {$event['arg4']}, {$event['arg5']} )", 'cnt' );

      if( $isend < 2 ) {
        send_msg( 1, $event['user_id'], t( "Вы оказали неоценимую поддержку в этой битве и по праву получаете заработанные деньги." ), 7 );
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg0']} WHERE u.id = {$event['user_id']}" );

        db_query( "DELETE FROM ships WHERE fleet_id IN ( {$event['arg4']}, {$event['arg5']} )" );
        db_query( "DELETE FROM fleets WHERE id IN ( {$event['arg4']}, {$event['arg5']} )" );
        db_query( "DELETE FROM users_quests WHERE type = 14 AND user_id IS NULL AND arg6 = ".$event['arg6'] );

        step_up( $event['id'] );
      }
      break;
  }
}

function quest_lost_ship( $event ) {
  // args: 0 - premium, 1 - type, 2,3 - coords, 4 - control object, 5 - control type(0=ship, 1=fleet)
  switch( $event['status'] ) {

    case 2: // generate objects
      $xr = $event['arg2'];
      $yr = $event['arg3'];
      send_msg( 1, $event['user_id'], t( "Отправьте ваш флот на исследование точки пространства %d:%d.", array( $xr, $yr ) ), 7 );
      step_up( $event['id'] );
      break;

    case 1: // mission accomplished
      $control = db_fetch_val( "SELECT s.id FROM ships s WHERE s.place_type = 8 AND s.arg1 = {$event['arg2']} AND s.arg2 = {$event['arg3']} AND s.id = ".$event['arg1'], 'id' );

      if( $control === null ) {
        send_msg( 1, $event['user_id'], t( "Конфедерация гордится вами! Все, что вы обнаружили в этой точке по праву принадлежит вам." ), 7 );
        db_query( "UPDATE users u SET u.money = u.money + {$event['arg0']} WHERE u.id = {$event['user_id']}" );

        step_up( $event['id'] );
      }
      break;
  }
}

function quest_planet_exchange( $event ) {
  $quest = db_fetch_row( "SELECT event_id, user_id, to_user, type, summ, currency, visibility, UNIX_TIMESTAMP( DATE_ADD( date_start, INTERVAL time_long HOUR ) ) - UNIX_TIMESTAMP( NOW() ) timer,
                                 arg0, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8, arg9
                            FROM u2u_quests
                           WHERE event_id = {$event['id']}" );

  if( $quest['timer'] < 0 ) {
    send_msg( 1, $quest['user_id'], t( "Ваше задание просрочено, задание снято с исполнителя." ), 7 );
    send_msg( 1, $event['user_id'], t( "Вы просрочили выполнение задания. Все произведенные вами действия не будут оплачены, поскольку срок и условия были обговорены заранее." ), 7 );

    db_query( "UPDATE users SET decline_time = NOW() WHERE id = ".$event['user_id'] );
    db_query( "UPDATE users_quests SET user_id = null, status = 4 WHERE id = {$event['id']}" );

    return;
  }

  switch( $event['status'] ) {

    case 4:
      $control = db_fetch_val( "SELECT count(*) cnt FROM ships s WHERE s.user_id = {$event['user_id']} AND s.object_id = 9321", 'cnt' );
      if( $control < 2 ) {
        send_msg( 1, $event['user_id'], t( "Вам необходимо 2 корабля Гипер врата, без наличия этих кораблей вы не сможете переместить планеты." ), 7 );
      }
      step_up( $event['id'] );
      break;

    case 3:
      $control = db_fetch_val( "SELECT count(*) cnt FROM ships s WHERE s.user_id = {$event['user_id']} AND s.object_id = 9321", 'cnt' );
      if( $control >= 2 ) {
        send_msg( 1, $event['user_id'], t( "Отправьте два ваших корабля Гипер врата к планетам %s в системе %s и %s в системе %s. Будьте бдительны, ваши корабли могут быть атакованы!", array( $event['arg0'], $event['arg1'], $event['arg2'], $event['arg3'] ) ), 7 );

        step_up( $event['id'] );
      }
      break;

    case 2:
      $control = db_fetch_val( "SELECT COUNT( DISTINCT s.place_id ) cnt FROM ships s WHERE s.user_id = {$event['user_id']} AND s.object_id = 9321 AND s.place_type = 0 AND s.place_id IN ( {$quest['arg0']}, {$quest['arg2']} )", 'cnt' );
      if( $control >= 2 ) {
        send_msg( 1, $event['user_id'], t( "Хорошая работа! Вам осталось открыть врата и дождаться когда планеты поменяются местами. Охраняйте ваши корабли до завершения обмена планет, вам могут помешать." ), 7 );

        step_up( $event['id'] );
      }
      break;

    case 1: // check new place of planets
      $control = db_fetch_val( "SELECT count(*) cnt FROM planets p WHERE ( p.star_id = {$quest['arg3']} AND p.id = {$quest['arg0']} AND p.planet_pos = {$quest['arg5']} ) OR ( p.star_id = {$quest['arg1']} AND p.id = {$quest['arg2']} AND p.planet_pos = {$quest['arg4']} )", 'cnt' );
      if( $control == 2 ) {
        send_msg( 1, $quest['user_id'], t( "Ваше задание выполнено. Планеты %s в системе %s и %s в системе %s перемещены.", array( $event['arg0'], $event['arg1'], $event['arg2'], $event['arg3'] ) ), 7 );
        send_msg( 1, $event['user_id'], t( "Благодарим вас за оказанную услугу, в будующем мы к вам еще обратимся." ), 7 );
        if( $quest['currency'] == 1 ) {
          db_query( "UPDATE users u SET u.donate = u.donate + {$quest['summ']}, u.credits = u.credits + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        } else {
          db_query( "UPDATE users u SET u.money = u.money + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        }

        step_up( $event['id'] );
      }
      break;
  }
}

function quest_destroy_mission( $event ) {
  $quest = db_fetch_row( "SELECT event_id, user_id, to_user, type, summ, currency, visibility, UNIX_TIMESTAMP( DATE_ADD( date_start, INTERVAL time_long HOUR ) ) - UNIX_TIMESTAMP( NOW() ) timer,
                                 arg0, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8, arg9
                            FROM u2u_quests
                           WHERE event_id = {$event['id']}" );

  if( $quest['timer'] < 0 ) {
    send_msg( 1, $quest['user_id'], t( "Ваше задание просрочено, задание снято с исполнителя." ), 7 );
    send_msg( 1, $event['user_id'], t( "Вы просрочили выполнение задания. Все произведенные вами действия не будут оплачены, поскольку срок и условия были обговорены заранее." ), 7 );

    db_query( "UPDATE users SET decline_time = NOW() WHERE id = ".$event['user_id'] );
    db_query( "UPDATE users_quests SET user_id = null, status = 2 WHERE id = {$event['id']}" );

    return;
  }

  switch( $event['status'] ) {
    case 2: // ready and go
      if( $event['type'] == 17 ) {
        send_msg( 1, $event['user_id'], t( "Соберите военный флот и отправьте его на уничтожение орбитальной обороны планеты {$event['arg1']} в системе {$event['arg2']}. Проведите разведку, что бы выйграть сражение с наименьшими потерями.", array( $event['arg1'], $event['arg2'] ) ), 7 );
      } else {
        send_msg( 1, $event['user_id'], t( "Соберите военный флот и отправьте его на уничтожение планетарной обороны планеты {$event['arg1']} в системе {$event['arg2']}. Проведите разведку, что бы выйграть сражение с наименьшими потерями.", array( $event['arg1'], $event['arg2'] ) ), 7 );
      }

      step_up( $event['id'] );
      break;

    case 1: // defence destroyed
      if( $event['type'] == 17 ) {
        $control = db_fetch_val( "SELECT count(*) cnt FROM orbits_buildings WHERE object_id IN( 3007, 3008, 3009 ) AND planet_id = {$quest['arg0']}", 'cnt' );
      } else {
        $control = db_fetch_val( "SELECT count(*) cnt FROM planets_buildings WHERE object_id IN( 27, 28, 29, 30, 31 ) AND planet_id = {$quest['arg0']}", 'cnt' );
      }

      if( $control == 0 ) {
        if( $event['type'] == 17 ) {
          send_msg( 1, $quest['user_id'], t( "Ваше задание выполнено. Орбитальная оборона планеты {$event['arg1']} в системе {$event['arg2']} уничтожена.", array( $event['arg1'], $event['arg2'] ) ), 7 );
        } else {
          send_msg( 1, $quest['user_id'], t( "Ваше задание выполнено. Планетарная оборона планеты {$event['arg1']} в системе {$event['arg2']} уничтожена.", array( $event['arg1'], $event['arg2'] ) ), 7 );
        }

        send_msg( 1, $event['user_id'], t( "Благодарим вас за оказанную услугу, вы проявили себя настоящим воином." ), 7 );
        if( $quest['currency'] == 1 ) {
          db_query( "UPDATE users u SET u.donate = u.donate + {$quest['summ']}, u.credits = u.credits + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        } else {
          db_query( "UPDATE users u SET u.money = u.money + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        }

        step_up( $event['id'] );
      }
      break;
  }
}

function quest_build_mission( $event ) {
  $quest = db_fetch_row( "SELECT event_id, user_id, to_user, type, summ, currency, visibility, UNIX_TIMESTAMP( DATE_ADD( date_start, INTERVAL time_long HOUR ) ) - UNIX_TIMESTAMP( NOW() ) timer,
                                 arg0, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8, arg9
                            FROM u2u_quests
                           WHERE event_id = {$event['id']}" );

  if( $quest['timer'] < 0 ) {
    $control = db_fetch_val( "SELECT count(*) cnt FROM planets_buildings WHERE planet_id = {$quest['arg0']} AND object_id = {$event['arg3']}", 'cnt' );
    $ready = $control - $quest['arg4'];

    send_msg( 1, $quest['user_id'], t( "Ваше задание просрочено, построенно %d %s данная работа не будет оплачена.", array( $ready, $event['arg4'] ) ), 7 );
    send_msg( 1, $event['user_id'], t( "Вы просрочили задания, построенно %d %s данная работа не будет оплачена.", array( $ready, $event['arg4'] ) ), 7 );

    $res = db_fetch_array( "SELECT w.object_id, w.object_cnt
                              FROM warequest w
                             WHERE w.quest_id = ".$event['id'] );

    foreach( $res as $item ) {
      sub_warehouse_item( 1, $quest['arg0'], $item['object_id'], $item['object_cnt'], false, $event['id'] );
      add_warehouse_item( 1, $quest['arg0'], $item['object_id'], $item['object_cnt'] );
    }

    if( $quest['arg1'] ) {
      db_query( "UPDATE users u SET decline_time = NOW(), place_type = 3, place_id = {$quest['arg1']} WHERE u.id = ".$event['user_id'] );
    }
    db_query( "UPDATE users_quests SET status = 0 WHERE id = ".$event['id'] );

    if( $quest['currency'] == 1 ) {
      db_query( "UPDATE users u SET u.credits = u.credits + {$quest['summ']} WHERE u.id = {$quest['user_id']}" );
    } else {
      db_query( "UPDATE users u SET u.money = u.money + {$quest['summ']} WHERE u.id = {$quest['user_id']}" );
    }

    return;
  }

  switch( $event['status'] ) {

    case 3:
      $control = db_fetch_row( "SELECT place_id, place_type FROM users WHERE id = ".$event['user_id'] );
      if( $control['place_type'] != 3 ) {
        send_msg( 1, $event['user_id'], t( "Вам необходимо прибыть на любую торговую станцию и покинуть корабль. Вас переместят на планету заказчика." ), 7 );
      }
      step_up( $event['id'] );
      break;

    case 2: // Test on station and teleport to planet
      $control = db_fetch_row( "SELECT place_id, place_type FROM users WHERE id = ".$event['user_id'] );
      if( $control['place_type'] == 3 ) {
        send_msg( 1, $event['user_id'], t( "Вас переместили на планету, ваша задача построить %s %s после чего вас переместят обратно на ту же торговую станцию и выплатят вознаграждение.", array( $event['arg0'], $event['arg4'] ) ), 7 );

        $cnt = db_fetch_val( "SELECT count(*) cnt FROM planets_buildings WHERE planet_id = {$quest['arg0']} AND object_id = {$event['arg3']}", 'cnt' );
        db_query( "UPDATE u2u_quests SET arg1 = {$control['place_id']}, arg4 = $cnt WHERE event_id = {$event['id']}" );
        db_query( "UPDATE users SET place_type = 1, place_id = {$quest['arg0']} WHERE id = ".$event['user_id'] );
        step_up( $event['id'] );
      }
      break;

    case 1: // Test build count and return back
      $control = db_fetch_val( "SELECT count(*) cnt FROM planets_buildings WHERE planet_id = {$quest['arg0']} AND object_id = {$event['arg3']}", 'cnt' );

      if( $control >= $event['arg0'] + $quest['arg4'] ) {
        send_msg( 1, $quest['user_id'], t( "Ваше задание выполнено. На планете %s в системе %s построено %d %s.", array( $event['arg5'], $event['arg6'], $event['arg0'], $event['arg4'] ) ), 7 );
        send_msg( 1, $event['user_id'], t( "Благодарим вас за оказанную услугу, вы очень помогли развитию колонии. Сейчас вас переместят обратно на торговую станцию." ), 7 );

        if( $quest['currency'] == 1 ) {
          db_query( "UPDATE users u SET place_type = 3, place_id = {$quest['arg1']}, u.donate = u.donate + {$quest['summ']}, u.credits = u.credits + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        } else {
          db_query( "UPDATE users u SET place_type = 3, place_id = {$quest['arg1']}, u.money = u.money + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        }

        step_up( $event['id'] );
      }

      $control = db_fetch_val( "SELECT sum( w.object_cnt ) cnt FROM warequest w WHERE w.quest_id = {$event['id']}", 'cnt' );
      if( $control == 0 ) {
        send_msg( 1, $quest['user_id'], t( "Ресурсы закончились, ваше задание считается выполненым. На планете %s в системе %s построено %d %s.", array( $event['arg5'], $event['arg6'], $event['arg0'], $event['arg4'] ) ), 7 );
        send_msg( 1, $event['user_id'], t( "Благодарим вас за оказанную услугу, вы очень помогли развитию колонии. Сейчас вас переместят обратно на торговую станцию." ), 7 );

        if( $quest['currency'] == 1 ) {
          db_query( "UPDATE users u SET place_type = 3, place_id = {$quest['arg1']}, u.donate = u.donate + {$quest['summ']}, u.credits = u.credits + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        } else {
          db_query( "UPDATE users u SET place_type = 3, place_id = {$quest['arg1']}, u.money = u.money + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        }

        step_up( $event['id'] );
      }

      break;
  }
}

function quest_upgrade_mission( $event ) {

  $quest = db_fetch_row( "SELECT event_id, user_id, to_user, type, summ, currency, visibility, UNIX_TIMESTAMP( DATE_ADD( date_start, INTERVAL time_long HOUR ) ) - UNIX_TIMESTAMP( NOW() ) timer,
                                 arg0, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8, arg9
                            FROM u2u_quests
                           WHERE event_id = {$event['id']}" );

  if( $quest['timer'] < 0 ) {
    if( $event['status'] == 2 ) {
      send_msg( 1, $quest['user_id'], t( "Ваше задание просрочено, квест возвращен на задания." ), 7 );
      send_msg( 1, $event['user_id'], t( "Вы просрочили задания. Данная работа не будет оплачена." ), 7 );

      db_query( "UPDATE users_quests SET user_id = null, status = 3 WHERE id = {$event['id']}" );
    } else {
      if( $event['type'] == 28 ) {
        $umap = explode( "\n", $quest['arg9'] );
        $levels = db_fetch_array( "SELECT pb.x, pb.y, pb.level
                                     FROM planets_buildings pb
                                    WHERE planet_id = {$quest['arg0']}" );
        $control = 0;
        foreach( $levels as $lev ) {
          if( $lev['level'] <= $umap[ $lev['y'] ]{ $lev['x'] } ) {
            $control++;
            break;
          }
        }
      } else {
        $control = db_fetch_val( "SELECT COUNT(*) cnt FROM planets_buildings pb WHERE planet_id = {$quest['arg0']} AND pb.level < 10", 'cnt' );
      }

      send_msg( 1, $quest['user_id'], t( "Ваше задание просрочено, на планете %s в системе %s не улучшено %d строений. Данная работа не будет оплачена.", array( $event['arg5'], $event['arg6'], $control ) ), 7 );
      send_msg( 1, $event['user_id'], t( "Вы просрочили задания, не улучшено %d строений. Данная работа не будет оплачена.", array( $control ) ), 7 );

      $res = db_fetch_array( "SELECT w.object_id, w.object_cnt
                                FROM warequest w
                               WHERE w.quest_id = ".$event['id'] );

      foreach( $res as $item ) {
        sub_warehouse_item( 1, $quest['arg0'], $item['object_id'], $item['object_cnt'], false, $event['id'] );
        add_warehouse_item( 1, $quest['arg0'], $item['object_id'], $item['object_cnt'] );
      }

      if( $quest['arg1'] ) {
        db_query( "UPDATE users u SET decline_time = NOW(), place_type = 3, place_id = {$quest['arg1']} WHERE u.id = ".$event['user_id'] );
      }

      db_query( "UPDATE users_quests SET status = 0 WHERE id = {$event['id']}" );

      if( $quest['currency'] == 1 ) {
        db_query( "UPDATE users u SET u.credits = u.credits + {$quest['summ']} WHERE u.id = {$quest['user_id']}" );
      } else {
        db_query( "UPDATE users u SET u.money = u.money + {$quest['summ']} WHERE u.id = {$quest['user_id']}" );
      }

      return;
    }
  }

  switch( $event['status'] ) {

    case 3:
      $control = db_fetch_row( "SELECT place_id, place_type FROM users WHERE id = ".$event['user_id'] );
      if( $control['place_type'] != 3 ) {
        send_msg( 1, $event['user_id'], t( "Вам необходимо прибыть на любую торговую станцию и покинуть корабль. Вас переместят на планету заказчика." ), 7 );
      }
      step_up( $event['id'] );
      break;

    case 2: // Test on station and teleport to planet
      $control = db_fetch_row( "SELECT place_id, place_type FROM users WHERE id = ".$event['user_id'] );
      if( $control['place_type'] == 3 ) {

        if( $event['type'] == 28 ) {
          send_msg( 1, $event['user_id'], t( "Вас переместили на планету, ваша задача улучшить все постройки на 1 уровень, после чего вас переместят обратно на ту же торговую станцию и выплатят вознаграждение." ), 7 );
        } else {
          send_msg( 1, $event['user_id'], t( "Вас переместили на планету, ваша задача улучшить все постройки до 10 уровня, после чего вас переместят обратно на ту же торговую станцию и выплатят вознаграждение." ), 7 );
        }

        $content = array_map( 'trim', explode( "\n", trim( db_fetch_val( "SELECT bld FROM planets_maps WHERE id = {$quest['arg0']}", 'bld' ) ) ) );

        $map = db_fetch_array( "SELECT pb.x, pb.y, pb.level
                                  FROM planets_buildings pb
                                 WHERE pb.level < 10 AND pb.planet_id = {$quest['arg0']}
                              ORDER BY y, x" );
        $dst_map = $out = '';
        $icnt = count( $content );

        for( $i=0; $i < $icnt; $i++ ) {
          $tcnt = strlen( trim( $content[ $i ] ) );
          for( $t=0; $t < $tcnt; $t++ ) {
            $bld = current( $map );
            if( $bld['x'] == $t && $bld['y'] == $i ) {
              next( $map );
              $dst_map .= $bld['level'];
            } else {
              $dst_map .= '0';
            }
          }
          $dst_map .= "\n";
        }

        db_query( "UPDATE robots r, planets_buildings pb
                      SET r.status = 0
                    WHERE r.build_id = pb.id AND pb.level < 10 AND pb.object_id IN ( 23, 36, 37 ) AND pb.planet_id = ".$quest['arg0'] );

        db_query( "DELETE pm.*, pe.*
                     FROM planets_mines pm, planet_events pe, planets_buildings pb
                    WHERE pm.event_id = pe.id AND pb.level < 10 AND pe.event_type = 2 AND pe.planet_id = ".$quest['arg0'] );

        db_query( "UPDATE u2u_quests SET arg1 = {$control['place_id']}, arg9 = '$dst_map' WHERE event_id = {$event['id']}" );

        db_query( "UPDATE users SET place_type = 1, place_id = {$quest['arg0']} WHERE id = ".$event['user_id'] );
        step_up( $event['id'] );
      }
      break;

    case 1: // Test build count and return back

      $control = 0;

      if( $event['type'] == 28 ) {
        $umap = explode( "\n", $quest['arg9'] );
        $levels = db_fetch_array( "SELECT pb.x, pb.y, pb.level
                                     FROM planets_buildings pb
                                    WHERE planet_id = {$quest['arg0']}" );

        foreach( $levels as $lev ) {
          if( $lev['level'] <= $umap[ $lev['y'] ]{ $lev['x'] } ) {
            $control++;
            break;
          }
        }
      } else {
        $control = db_fetch_val( "SELECT COUNT(*) cnt FROM planets_buildings pb WHERE planet_id = {$quest['arg0']} AND pb.level < 10", 'cnt' );
      }

      if( $control > 0 ) {
        $control = db_fetch_val( "SELECT SUM( object_cnt ) cnt FROM warequest WHERE quest_id = ".$event['id'], 'cnt' );
      }

      if( $control == 0 ) {
        send_msg( 1, $quest['user_id'], t( "Ваше задание выполнено. На планете {$event['arg5']} в системе {$event['arg6']} улучшены все постройки.", array( $event['arg5'], $event['arg6'] ) ), 7 );
        send_msg( 1, $event['user_id'], t( "Благодарим вас за оказанную услугу, вы очень помогли развитию колонии. Сейчас вас переместят обратно на торговую станцию." ), 7 );

        if( $quest['currency'] == 1 ) {
          db_query( "UPDATE users u SET place_type = 3, place_id = {$quest['arg1']}, u.donate = u.donate + {$quest['summ']}, u.credits = u.credits + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        } else {
          db_query( "UPDATE users u SET place_type = 3, place_id = {$quest['arg1']}, u.money = u.money + {$quest['summ']} WHERE u.id = {$event['user_id']}" );
        }

        step_up( $event['id'] );
      }
      break;
  }
}

function quest_ring_event( $event ) {
  switch( $event['status'] ) {
    case 7:
      send_msg( 1, $event['user_id'], t( "Вам необходимо собрать экспедицию в систему {$event['arg2']} на планету {$event['arg4']}. Мы не знаем, в каких отношениях вы состоите с властями данной системы, однако во время нашего визита она была не обитаема.", array( $event['arg2'], $event['arg4'] ) ), 7 );
      step_up( $event['id'] );
      break;

    case 6:
      $test = db_fetch_val( "SELECT count(*) cnt
                               FROM ships s
                              WHERE s.place_type = 7 AND s.place_id = {$event['arg1']} AND s.user_id = ".$event['user_id'], 'cnt' );
      if( $test > 0 ) {
        db_query( "INSERT INTO ships ( object_id,         place_id, place_type, user_id,     name, arg1, arg2, fleet_id, shield, inwar, guard, abordage ) VALUES
                                     (      9148, {$event['arg3']},          0,       4, 'Пираты', null, null,     null,     10,     0,     1,        0 )" );

        send_msg( 1, $event['user_id'], t( "Вам необходимо приземлиться на планету {$event['arg4']} и найти кольцо.", array( $event['arg4'] ) ), 7 );
        step_up( $event['id'] );
      }
      break;

    case 5:
      $test = db_fetch_val( "SELECT count(*) cnt
                               FROM ships s
                              WHERE s.place_type = 1 AND s.place_id = {$event['arg3']} AND s.user_id = ".$event['user_id'], 'cnt' );

      if( $test > 0 ) {
        if( mt_rand( 1, 10 ) < 5 ) {
          $names = db_fetch_row( "SELECT p.name pname, s.name sname
                                    FROM planets p
                              INNER JOIN stars s ON s.id = p.star_id
                                   WHERE p.id = {$event['arg8']}" );
          add_warehouse_item( 1, $event['arg3'], 9460, 1 );

          send_msg( 1, $event['user_id'], t( "Вам повезло! Вы нашли кольцо - погрузите его в корабль и отправляйтесь в систему {$names['sname']} к планете {$names['pname']} на торговой станции вас встретят представители короля и вручат вознаграждение.", array( $names['sname'], $names['pname'] ) ), 7 );
          step_up( $event['id'] );
        } else {
          $new_coord = db_fetch_row( "SELECT s.id sid, s.name sname, p.id pid, p.name pname FROM planets p LEFT JOIN planets_buildings pb ON pb.planet_id = p.id INNER JOIN stars s ON s.type != 4 AND p.star_id = s.id WHERE p.type IN( 3, 4 ) AND pb.id IS NULL ORDER BY rand() LIMIT 0,1" );

          db_query( "UPDATE users_quests SET arg1 = {$new_coord['sid']}, arg2 = '{$new_coord['sname']}', arg3 = {$new_coord['pid']}, arg4 = '{$new_coord['pname']}' WHERE id = ".$event['id'] );

          send_msg( 1, $event['user_id'], t( "Ваши поисковые боты доложили, что кольцо не обнаружено. Возможно, оно утеряно на другой планете. Отправьте вашу экспедицию в систему {$new_coord['sname']} к планете {$new_coord['pname']}.", array( $new_coord['sname'], $new_coord['pname'] ) ), 7 );
          step_up( $event['id'], 1 );
        }
      }
      break;

    case 4:
      $orbit = db_fetch_val( "SELECT count(*) cnt
                                FROM ships s
                               WHERE s.place_type = 0 AND s.place_id = {$event['arg3']} AND s.user_id = ".$event['user_id'], 'cnt' );

      $planet = db_fetch_val( "SELECT count(*) cnt
                                 FROM ships s
                                WHERE s.place_type = 1 AND s.place_id = {$event['arg3']} AND s.user_id = ".$event['user_id'], 'cnt' );

      if( $orbit > 0 && $planet == 0 ) {
        $ring = db_fetch_val( "SELECT count(*) cnt FROM warehouse w WHERE w.object_id = 9460 AND w.place_type = 1 AND w.place_id = {$event['arg3']}", 'cnt' );
        if( $ring ) {
          send_msg( 1, $event['user_id'], t( "Вернитесь на планету %s и загрузите кольцо! Вы забыли его там.", array( $event['arg4'] ) ), 7 );
        } else {
          $names = db_fetch_row( "SELECT p.name pname, s.name sname
                                    FROM planets p
                              INNER JOIN stars s ON s.id = p.star_id
                                   WHERE p.id = {$event['arg6']}" );

          send_msg( 4, $event['user_id'], t( "Вы сбили наш корабль, однако мы не в обиде, все, что от вас требуется, это продать нам кольцо. Заметьте, мы предлагаем вам %d кредитов, а это в четыре раза больше обещанного. Если вы согласны, вам необходимо прибыть в систему %s на астероид %s.", array( $event['arg0'] * 4, $names['sname'], $names['pname'] ) ), 7 );
          step_up( $event['id'] );
        }
      }
      break;

    case 3:
      $test = db_fetch_val( "SELECT s.place_id place
                               FROM ships s
                              WHERE s.place_type = 0 AND s.place_id IN( {$event['arg6']}, {$event['arg8']} ) AND s.user_id = ".$event['user_id'], 'place' );

      if( $test == $event['arg6'] ) {
        send_msg( 4, $event['user_id'], t( "Мы видим, что вы оказались разумным человеком, что бы не привлекать внимания приземлитесь на астероид, там вас встретит доверенный человек, выгрузите кольцо на поверхность и получите ваши деньги." ), 7 );
        step_up( $event['id'] );
      }

      if( $test == $event['arg8'] ) {
        send_msg( 1, $event['user_id'], t( "Отлично! Вы вернули кольцо королю, пристыкуйтесь к торговой станции, и я отдам вам ваше вознаграждение." ), 7 );
        step_up( $event['id'] );
      }
      break;

    case 2:
      $stantion = db_fetch_val( "SELECT s.id
                                   FROM ships s
                             INNER JOIN orbits_buildings ob
                             INNER JOIN warehouse w ON w.place_type = 2 AND w.place_id = s.id
                                  WHERE w.object_id = 9460 AND s.place_type = 3 AND s.place_id = ob.id AND
                                        ob.object_id = 3001 AND ob.planet_id = {$event['arg8']} AND s.user_id = ".$event['user_id'], 'id' );
      if( $stantion ) {
        send_msg( 4, $event['user_id'], t( "Мы вам предлагали сделать как лучше, но вы решили поступить по своему, мы будем мстить!" ), 7 );
        send_msg( 1, $event['user_id'], t( "Спасибо за поиски кольца, вы оказали неоценимую услугу нашему королю, прошу не афишируйте факт потери кольца, это плохо скажется на репутации." ), 7 );
        sub_warehouse_item( 2, $stantion, 9460, 1 );

        db_query( "UPDATE users u SET u.pirate_status = u.pirate_status + 1, u.money = u.money + {$event['arg0']} WHERE u.id = {$event['user_id']}" );
        step_up( $event['id'], -2 );
      }

      $land = db_fetch_val( "SELECT s.id
                               FROM ships s
                         INNER JOIN warehouse w ON w.place_type = 2 AND w.place_id = s.id
                              WHERE s.place_type = 1 AND s.place_id = {$event['arg6']} AND s.user_id = ".$event['user_id'], 'id' );
      if( $land ) {
        $power = db_fetch_val( "SELECT COUNT( s.id ) cnt
                                  FROM ships s
                            INNER JOIN ship_types st ON st.object_id = s.object_id
                                 WHERE s.place_type IN ( 0, 1 ) AND s.place_id = {$event['arg6']} AND s.user_id = {$event['user_id']}", 'cnt' );
 
       if( $power < mt_rand( 10, 100 ) ) {
          send_msg( 4, $event['user_id'], t( "Мы тут подумали и решили, что не будем платить вам денег, просто выгрузите кольцо и улетайте, если вы попытаетесь взлететь с кольцом, то флот на орбите откроет огонь." ), 7 );
          step_up( $event['id'] );

          db_query( "INSERT INTO fleets ( user_id, place_type,         place_id, arg1, arg2, guard, abordage )
                                 VALUES (       4,          0, {$event['arg6']}, null, null,     0,        0 )" );
          $fleet_id = mysql_insert_id();
          db_query( "UPDATE users_quests SET arg9 = $fleet_id WHERE id=".$event['id'] );

          $pirates = array( 9072, 9128, 9053, 9136, 9042, 9021, 9167, 9127, 9080, 9280, 9260, 9264, 9284, 9295, 9281 );
          $shield  = array( 2000, 250,  2000, 6000, 500,  100,  200,  100,  500, 10100,10100,10100,   -1,   -1,   -1 );
          $missile = array( 9215,    0, 9215, 9215, 9212, 9210, 9211, 9210, 9209,    0,    0,    0,    0,    0,    0 );

          for( $i=0; $i < $power * 2; $i++ ) {
            $rnd = mt_rand( 0, count( $pirates ) - 1 );

            db_query( "INSERT INTO ships (        object_id,        place_id, place_type, user_id,              name, arg1, arg2, fleet_id,           shield, inwar, guard, abordage ) VALUES
                                         ( {$pirates[$rnd]},{$event['arg6']},          0,       4, '".t('Пираты')."', null, null, $fleet_id, {$shield[$rnd]},     0,     0,        0 )" );
            $ship_id = mysql_insert_id();
            if( $missile[$rnd] > 0 ) {
              add_warehouse_item( 2, $ship_id, $missile[$rnd], 4 );
            }
          }

          update_fleet( $fleet_id );
        } else {
          send_msg( 4, $event['user_id'], t( "Забирайте ваши деньги и проваливайте, пока мы не передумали и не разнесли вас на атомы. Надеюсь у вас хватит ума не рассказывать куда вы дели кольцо." ), 7 );

          $ring = db_fetch_val( "SELECT s.id
                                   FROM ships s
                             INNER JOIN warehouse w ON w.place_type = 2 AND w.place_id = s.id
                                  WHERE w.object_id = 9460 AND s.place_type = 1 AND s.place_id = {$event['arg6']} AND s.user_id = ".$event['user_id'], 'id' );
          sub_warehouse_item( 2, $ring, 9460, 1 );

          db_query( "UPDATE users u SET u.money = u.money + ".( $event['arg0'] * 4 )." WHERE u.id = {$event['user_id']}" );
          step_up( $event['id'], -2 );
        }
      }
      break;

    case 1:
      $land = db_fetch_val( "SELECT COUNT( s.id ) cnt
                               FROM ships s
                              WHERE s.place_type = 1 AND s.place_id = {$event['arg6']} AND s.user_id = ".$event['user_id'], 'cnt' );

      $ring = db_fetch_val( "SELECT count(*) cnt FROM warehouse w WHERE w.object_id = 9460 AND w.place_type = 1 AND w.place_id = {$event['arg6']}", 'cnt' );

      if( $land == 0 && $ring == 0 ) {
        $pacific = db_fetch_val( "SELECT count(*) cnt FROM fleets WHERE guard = 0 AND id = {$event['arg9']}", 'cnt' );
        if( $pacific ) {
          send_msg( 4, $event['user_id'], t( "А вы оказались очень смелым, но глупым. Прощайте, не могу сказать, что был рад знакомству." ), 7 );

          db_query( "UPDATE fleets SET guard = 1 WHERE id = {$event['arg9']}" );
          db_query( "UPDATE ships SET guard = 1 WHERE fleet_id = {$event['arg9']}" );
        }

        $fleet = db_fetch_val( "SELECT count(*) cnt FROM ships WHERE fleet_id = {$event['arg9']}", 'cnt' );
        if( !$fleet ) {
          $names = db_fetch_row( "SELECT p.name pname, s.name sname
                                    FROM planets p
                              INNER JOIN stars s ON s.id = p.star_id
                                   WHERE p.id = {$event['arg8']}" );

          db_query( "UPDATE users u SET u.pirate_status = u.pirate_status + 1 WHERE u.id = {$event['user_id']}" );

          send_msg( 4, $event['user_id'], t( "Как вы посмели уничтожить наш флот! Вы же понимаете, что просто так это вам с рук не сойдет, мы будем мстить!" ), 7 );
          send_msg( 1, $event['user_id'], t( "Вы немного задерживаетесь, с кольцом все в порядке? Отправляйтесь в систему %s к планете %s на торговой станции вас встретят представители короля и вручат вознаграждение.", array( $names['sname'], $names['pname'] ) ), 7 );

          db_query( "UPDATE users_quests SET arg6 = 0 WHERE id=".$event['id'] );
  
          step_up( $event['id'], 2 );
        }
      } elseif( $land == 0 && $ring != 0 ) {
        sub_warehouse_item( 1, $event['arg6'], 9460, 1 );

        if( $event['arg9'] ) {
          db_query( "DELETE FROM fleets WHERE id = {$event['arg9']}" );
          db_query( "DELETE FROM ships WHERE fleet_id = {$event['arg9']}" );
        }

        send_msg( 4, $event['user_id'], t( "Ну вот и правильно, к чему этот излишний героизм. Позор лучший способ скрыть темные делишки, вы же никому не расскажете, что сбежали испугавшись пиратов." ), 7 );
        step_up( $event['id'] );
      }

      break;
  }
}

function quest_find_event( $event ) {
  switch( $event['status'] ) {

    case 2:
      send_msg( 1, $event['user_id'], t( "Вам необходимо обнаружить планету принадлежащую '%s' Достаточно, что бы орбитальная или планетарная оборона имела принадлежность к пилоту '%s'.", array( $event['arg0'], $event['arg0'] ) ), 7 );
      step_up( $event['id'] );
      break;
  }
}

function quest_duel_event( $event ) {
  if( $event['type'] == 33 ) {
    $quest = db_fetch_row( "SELECT event_id, user_id, to_user, type, summ, currency, visibility, UNIX_TIMESTAMP( DATE_ADD( date_start, INTERVAL time_long HOUR ) ) - UNIX_TIMESTAMP( NOW() ) timer,
                                   arg0, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8, arg9
                              FROM u2u_quests
                             WHERE event_id = {$event['id']}" );
  } elseif( $event['type'] == 34 ) {
    $quest = db_fetch_row( "SELECT event_id, user_id, to_user, type, summ, currency, visibility, UNIX_TIMESTAMP( DATE_ADD( date_start, INTERVAL time_long HOUR ) ) - UNIX_TIMESTAMP( NOW() ) timer,
                                   arg0, arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8, arg9
                              FROM u2u_quests
                             WHERE event_id = {$event['arg4']}" );
  }

  if( $quest['timer'] < 0 ) {
    $price = floor( $quest['summ'] / 2 );

    $status = db_fetch_val( "SELECT status FROM users_quests WHERE type = 34 AND arg4 = {$quest['event_id']}", 'status' );

    if( $status == 3 ) {
      send_msg( 1, $quest['user_id'], t( "Вы предложили дуэль и не явились на нее. В знак призрения коммандиры ваших кораблей подали в отставку в полном составе. В течении 6-х часов вы не сможете отдать приказ своим кораблям." ), 7 );
      send_msg( 1, $quest['to_user'], t( "Ваш соперник по дуэли не явился, вы можете забрать свой флот, вы считаетесь победителем и получаете вознаграждение %d конфедерат.", array( $price ) ), 7 );

      db_query( "UPDATE users u SET u.donate = u.donate + $price, u.credits = u.credits + $price WHERE u.id = {$quest['to_user']}" );
      db_query( "UPDATE users u SET u.block = 1 WHERE u.id = {$quest['user_id']}" );

      return;
    }

    $status = db_fetch_val( "SELECT status FROM users_quests WHERE id = {$quest['event_id']}", 'status' );

    if( $status == 3 ) {
      send_msg( 1, $quest['user_id'], t( "Ваш соперник по дуэли не явился, вы можете забрать свой флот, вы считаетесь победителем и получаете вознаграждение %d конфедерат.", array( $price ) ), 7 );
      send_msg( 1, $quest['to_user'], t( "Вы не явились на дуэль. В знак призрения коммандиры ваших кораблей подали в отставку в полном составе. В течении 6-х часов вы не сможете отдать приказ своим кораблям." ), 7 );

      db_query( "UPDATE users u SET u.donate = u.donate + $price, u.credits = u.credits + $price WHERE u.id = {$quest['user_id']}" );
      db_query( "UPDATE users u SET u.block = 1 WHERE u.id = {$quest['to_user']}" );

      return;
    }

debug_it( 'Crazy duel' );
debug_it( $event );
debug_it( $quest );

  }

  switch( $event['status'] ) {

    case 4:
      send_msg( 1, $event['user_id'], t( "Соберите флот, и отправляйтесь на нем в точку гиперпространства %d:%d там ваш флот проверят на допуск и переместят в точку дуэли. На это у вас есть %d часов. В случае отказа от дуэли командиры ваших кораблей обещали подать в отставку, вы не сможете управлять кораблями в течении 6-ти часов.", array( $event['arg5'], $event['arg6'], $quest['timer'] ) ), 7 );
      step_up( $event['id'] );
      break;

    case 3:
      $user_place = db_fetch_row( "SELECT place_id, place_type FROM users WHERE id = ".$event['user_id'] );

      switch( $user_place['place_type'] ) {
        case 2:
          $ship = db_fetch_row( "SELECT s.place_type, s.arg1, s.arg2, IF( st.w_count = 0, 1, st.w_count ) * st.w_power power, s.shield
                                   FROM ships s
                             INNER JOIN ship_types st ON st.object_id = s.object_id
                                  WHERE s.id = ".$user_place['place_id'] );

          $extra = db_fetch_row( "SELECT SUM( IF( st.w_count = 0, 1, st.w_count ) * st.w_power ) power, SUM( s.shield ) shield
                                    FROM ships s
                              INNER JOIN ship_types st ON st.object_id = s.object_id
                                   WHERE s.place_type = 2 AND s.place_id = ".$user_place['place_id'] );

          $power = $ship['power'] + $extra['power'];
          $shield = $ship['shield'] + $extra['shield'];
          break;

        case 6:
          $ship = db_fetch_row( "SELECT MIN( s.place_type ) place_type, MIN( s.arg1 ) arg1, MIN( s.arg2 ) arg2, SUM( IF( st.w_count = 0, 1, st.w_count ) * st.w_power ) power, SUM( s.shield ) shield
                                   FROM ships s
                             INNER JOIN ship_types st ON st.object_id = s.object_id
                                  WHERE s.fleet_id = ".$user_place['place_id'] );

          $extra = db_fetch_row( "SELECT SUM( IF( st.w_count = 0, 1, st.w_count ) * st.w_power ) power, SUM( s2.shield ) shield
                                    FROM ships s1
                              INNER JOIN ships s2 ON s2.place_type = 2 AND s2.place_id = s1.id
                              INNER JOIN ship_types st ON st.object_id = s2.object_id
                                   WHERE s1.fleet_id = ".$user_place['place_id'] );

          $power = $ship['power'] + $extra['power'];
          $shield = $ship['shield'] + $extra['shield'];
          break;

        default:
          $ship = array();
          break;
      }

      if( isset( $ship['place_type'] ) && $ship['place_type'] == 8 && $ship['arg1'] == $event['arg5'] && $ship['arg2'] == $event['arg6'] ) {

        if( $power > $event['arg2'] ) {
          send_msg( 1, $event['user_id'], t( "Ваш флот сформирован неправильно. Сила флота %s больше оговоренной %s.", array( $power, $event['arg2'] ) ), 7 );
          $back = true;
        } elseif( $shield > $event['arg3'] ) {
          send_msg( 1, $event['user_id'], t( "Ваш флот сформирован неправильно. Защита флота %s больше оговоренной. %s", array( $shield, $event['arg3'] ) ), 7 );
          $back = true;
        } else {
          send_msg( 1, $event['user_id'], t( "Ваш флот прошел проверку и допущен к дуэли, дождитесь вашего оппонента." ), 7 );
          $back = false;
        }

        if( $back ) {
          switch( $user_place['place_type'] ) {
            case 2:
              db_query( "UPDATE ships SET arg1 = arg1 - 1 WHERE id = ".$user_place['place_id'] );
              break;

            case 6:
              db_query( "UPDATE ships SET arg1 = arg1 - 1 WHERE fleet_id = ".$user_place['place_id'] );
              db_query( "UPDATE fleets SET arg1 = arg1 - 1 WHERE id = ".$user_place['place_id'] );
              break;
          }
        } else {
          switch( $user_place['place_type'] ) {
            case 2:
              db_query( "UPDATE ships SET abordage = 0, guard = 0, arg1 = {$event['arg7']}, arg2 = {$event['arg8']} WHERE id = ".$user_place['place_id'] );
              break;

            case 6:
              db_query( "UPDATE ships SET abordage = 0, guard = 0, arg1 = {$event['arg7']}, arg2 = {$event['arg8']} WHERE fleet_id = ".$user_place['place_id'] );
              db_query( "UPDATE fleets SET abordage = 0, guard = 0, arg1 = {$event['arg7']}, arg2 = {$event['arg8']} WHERE id = ".$user_place['place_id'] );
              break;
          }

          step_up( $event['id'] );
        }
      }
      break;

    case 2:
      $test = db_fetch_val( "SELECT COUNT( DISTINCT user_id ) cnt FROM ships WHERE place_type = 8 AND arg1 = {$event['arg7']} AND arg2 = {$event['arg8']}", 'cnt' );

      if( $test >= 2 ) {
        $users = db_fetch_array( "SELECT id, place_type, place_id FROM users WHERE id IN ( {$quest['user_id']}, {$quest['to_user']} )" );
        $ships[$users[0]['id']] = array( 'place_type' => $users[0]['place_type'], 'place_id' => $users[0]['place_id'] );
        $ships[$users[1]['id']] = array( 'place_type' => $users[1]['place_type'], 'place_id' => $users[1]['place_id'] );

        if( mt_rand( 1, 100 ) > 50 ) {
          send_msg( 1, $quest['user_id'], t( "Согласно жребию вы начинаете бой." ), 7 );
          send_msg( 1, $quest['to_user'], t( "Согласно жребию вы принимаете бой." ), 7 );

          StartWar( ( $ships[$quest['user_id']]['place_type'] == 2 ? 0 : 1 ), $ships[$quest['user_id']]['place_id'],
                    ( $ships[$quest['to_user']]['place_type'] == 2 ? 0 : 1 ), $ships[$quest['to_user']]['place_id'] );
        } else {
          send_msg( 1, $quest['to_user'], t( "Согласно жребию вы начинаете бой." ), 7 );
          send_msg( 1, $quest['user_id'], t( "Согласно жребию вы принимаете бой." ), 7 );

          StartWar( ( $ships[$quest['to_user']]['place_type'] == 2 ? 0 : 1 ), $ships[$quest['to_user']]['place_id'],
                    ( $ships[$quest['user_id']]['place_type'] == 2 ? 0 : 1 ), $ships[$quest['user_id']]['place_id'] );
        }

        if( $event['type'] == 33 ) {
          db_query( "UPDATE users_quests SET status = status - 1 WHERE type = 34 AND arg4 = {$event['id']}" );
        } elseif( $event['type'] == 34 ) {
          db_query( "UPDATE users_quests SET status = status - 1 WHERE type = 33 AND id = {$event['arg4']}" );
        }

        step_up( $event['id'] );
      }
      break;

    case 1:
      $test = db_fetch_val( "SELECT COUNT( DISTINCT user_id ) cnt FROM ships WHERE place_type = 8 AND arg1 = {$event['arg7']} AND arg2 = {$event['arg8']}", 'cnt' );

      $double = db_fetch_val( "SELECT status FROM users_quests WHERE id = {$event['id']}", 'status' );

      if( $double == 1 && $test == 1 ) {
        $winner = db_fetch_val( "SELECT DISTINCT user_id FROM ships WHERE place_type = 8 AND arg1 = {$event['arg7']} AND arg2 = {$event['arg8']}", 'user_id' );
        $price = floor( $quest['summ'] / 2 );

        if( $winner == $quest['user_id'] ) {
          send_msg( 1, $quest['user_id'], t( "Вы выйграли дуэль и по праву получаете %d конфедерат.", array( $price ) ), 7 );
          send_msg( 1, $quest['to_user'], t( "Вы проиграли дуэль." ), 7 );

          db_query( "UPDATE users u SET u.donate = u.donate + $price, u.credits = u.credits + $price WHERE u.id = {$event['user_id']}" );
        } else {
          send_msg( 1, $quest['to_user'], t( "Вы выйграли дуэль и по праву получаете %d конфедерат.", array( $price ) ), 7 );
          send_msg( 1, $quest['user_id'], t( "Вы проиграли дуэль." ), 7 );

          db_query( "UPDATE users u SET u.donate = u.donate + $price, u.credits = u.credits + $price WHERE u.id = {$quest['to_user']}" );
        }

        if( $event['type'] == 33 ) {
          db_query( "UPDATE users_quests SET status = status - 1 WHERE type = 34 AND arg4 = {$event['id']}" );
        } elseif( $event['type'] == 34 ) {
          db_query( "UPDATE users_quests SET status = status - 1 WHERE type = 33 AND id = {$event['arg4']}" );
        }

        step_up( $event['id'] );
      } elseif( $double == 1 && $test == 0 ) {
        send_msg( 1, $quest['user_id'], t( "Дуэль закончилась взаимным уничтожением, победитель не определен." ), 7 );
        send_msg( 1, $quest['to_user'], t( "Дуэль закончилась взаимным уничтожением, победитель не определен." ), 7 );

        if( $event['type'] == 33 ) {
          db_query( "UPDATE users_quests SET status = status - 1 WHERE type = 34 AND arg4 = {$event['id']}" );
        } elseif( $event['type'] == 34 ) {
          db_query( "UPDATE users_quests SET status = status - 1 WHERE type = 33 AND id = {$event['arg4']}" );
        }

        step_up( $event['id'] );
      }
      break;
  }
}
