<?php

  global $user;

  $guard_txt = array( 1 => 'Атаковать всех', 2 => 'Атаковать врагов', 3 => 'Атаковать не друзей', 4=> 'Атаковать не альянс' );
  $interupt_txt = array( 2=> 'Перехватывать всех', 3 => 'Перехватывать врагов', 4 => 'Перехватывать друзей', 5 => 'Перехватывать не врагов', 6 => 'Перехватывать не друзей', 7 => 'Перехватывать альянс', 8 => 'Перехватывать не альянс' );

  if( isset( $_GET['shid'] ) ) {
    $shid = $_GET['shid'];
    db_safe( $shid );

    $type = substr( $shid, 0, 1 );
    $shid = substr( $shid, 1 );
    $out = "shid=$shid";
    $cnt = 0;

    $limit = get_ship_limit( $user->uid );
//$limit = 10;

    if( $limit < 0 ) {
      if( $user->real_type == 2 && $user->real_id == $shid ) {
        $limit = 1;
      }

      if( $user->real_type == 6 && $user->real_id == $shid ) {
        $over = db_fetch_val( "SELECT count(*) cnt FROM ships WHERE fleet_id = $shid", 'cnt' );
        if( $over <= 20 ) {
          $limit = 1;
        }
      }
    }

    switch( $type ) {

      case 'A' :
        if( $limit < 0 ) {
          $out .= "&id$cnt=15&name$cnt=".t( 'Превышен лимит управления' );
          $cnt++;
        }

        $place = db_fetch_row( "SELECT st.titul, s.place_type, s.fleet_id
                                  FROM ships s
                            INNER JOIN ship_types st ON st.object_id = s.object_id
                                 WHERE s.id = $shid AND ( s.user_id IS NULL OR s.user_id = ".$user->uid.')' );

        if( $place['titul'] > $user->titul % 11 ) {
          $need = db_fetch_row( "SELECT t1.name name1, t2.name name2
                                   FROM tituls t1
                             INNER JOIN tituls t2 ON t2.id = ( t1.id + 11 )
                                  WHERE t1.id = ".$place['titul'] );

          $out .= "&id0=999&name0=Необходим титул {$need['name1']} или {$need['name2']}";
          $cnt++;
        } else {
          db_query( 'UPDATE users SET fid = \'0\' WHERE id = '.$user->uid );

          $out .= "&id$cnt=25&name$cnt=Присвоить корабль";
          $cnt++;
        }

        $out .= "&id$cnt=46&name$cnt=Отправить координаты в эфир";
        $cnt++;

        switch( $place['place_type'] ) {
          case 7:
          case 8:
          case 9:
            if( $limit >= 0 ) {
              if( isset( $home['user_id'] ) ) {
                $out .= "&id$cnt=15&name$cnt=Нет возможности атаковать";
                $cnt++;
              } else {
                if( $user->block == 0 ) {
                  if( $place['fleet_id'] ) {
                    $out .= "&id$cnt=17&name$cnt=Атаковать флот всеми кораблями";
                    $cnt++;
                    $out .= "&id$cnt=49&name$cnt=Атаковать все корабли этого игрока";
                    $cnt++;
                  } else {
                    $out .= "&id$cnt=16&name$cnt=Атаковать корабль всеми кораблями";
                    $cnt++;
                    $out .= "&id$cnt=49&name$cnt=Атаковать все корабли этого игрока";
                    $cnt++;
                  }
                } else {
                  $out .= "&id$cnt=15&name$cnt=Коммандиры кораблей в отставке";
                  $cnt++;
                }
              }
            }
            break;
        }
        break;

      case 'Z' :
        if( $limit < 0 ) {
          $out .= "&id$cnt=15&name$cnt=".t( 'Превышен лимит управления' );
          $cnt++;
        }

        db_query( 'UPDATE users SET fid = \'0\' WHERE id = '.$user->uid );

        $test = db_fetch_row( "SELECT fleet_id, place_id, place_type
                                 FROM ships WHERE id = $shid AND user_id != ".$user->uid );
        if( !isset( $test['place_id'] ) ) {
            printOut( "err=1" );
            return;
        }

        switch( $test['place_type'] ) {
          case 0:
          case 1:
            $home = db_fetch_row( "SELECT user_id FROM planets WHERE id = ".$test['place_id'] );
            if( $limit >= 0 ) {
              if( isset( $home['user_id'] ) ) {
                $out .= "&id$cnt=15&name$cnt=Нет возможности атаковать";
                $cnt++;
              } else {
                if( $user->block == 0 ) {
                  if( $test['fleet_id'] ) {
                    $out .= "&id$cnt=17&name$cnt=Атаковать флот всеми кораблями";
                    $cnt++;
                    $out .= "&id$cnt=49&name$cnt=Атаковать все корабли этого игрока";
                    $cnt++;
                  } else {
                    $out .= "&id$cnt=16&name$cnt=Атаковать корабль всеми кораблями";
                    $cnt++;
                    $out .= "&id$cnt=49&name$cnt=Атаковать все корабли этого игрока";
                    $cnt++;
                  }
                } else {
                  $out .= "&id$cnt=15&name$cnt=Коммандиры кораблей в отставке";
                  $cnt++;
                }
              }
            }
            break;

          case 2:
            $home['user_id'] = true;
            if( $user->qt != 33 && $user->qt != 34 ) {
              $out .= "&id$cnt=3&name$cnt=Отстыковать корабль";
              $cnt++;
            }
            break;

          case 5:
          case 7:
          case 8:
          case 9:
            if( $limit >= 0 ) {
              if( isset( $home['user_id'] ) ) {
                $out .= "&id$cnt=15&name$cnt=Нет возможности атаковать";
                $cnt++;
              } else {
                if( $user->block == 0 ) {
                  if( $test['fleet_id'] ) {
                    $out .= "&id$cnt=17&name$cnt=Атаковать флот всеми кораблями";
                    $cnt++;
                    $out .= "&id$cnt=49&name$cnt=Атаковать все корабли этого игрока";
                    $cnt++;
                  } else {
                    $out .= "&id$cnt=16&name$cnt=Атаковать корабль всеми кораблями";
                    $cnt++;
                    $out .= "&id$cnt=49&name$cnt=Атаковать все корабли этого игрока";
                    $cnt++;
                  }
                } else {
                  $out .= "&id$cnt=15&name$cnt=Коммандиры кораблей в отставке";
                  $cnt++;
                }
              }
            }
            break;

          default:
            if( $limit >= 0 ) {
              $out .= "&id$cnt=15&name$cnt=Нет возможности атаковать";
              $cnt++;
            }
            break;
        }
        break;

      case 'F' :
      case 'S' :
        if( $limit < 0 ) {
          $out .= "&id$cnt=15&name$cnt=".t( 'Превышен лимит управления' );
          $cnt++;
        }

        db_query( 'UPDATE users SET fid = \''.$type.$shid.'\' WHERE id = '.$user->uid );

        if( $type == 'F' ) {
          $place = db_fetch_row( "SELECT f.place_id, f.place_type, f.agrav, f.planet, f.hyper, f.w_power, f.guard, f.titul, f.harvest, f.hot,
                                         f.remote, f.interupt, f.arg1, f.arg2, f.inwar, f.radar, f.abordage, se.event_type
                                    FROM fleets f
                               LEFT JOIN space_events se ON se.ship_id = f.id AND se.event_type > 100
                                   WHERE f.id = $shid AND (f.user_id IS NULL OR f.user_id = ".$user->uid.')' );

          $unpack = db_fetch_val( "SELECT COUNT(*) cnt FROM warehouse w
                               INNER JOIN objects o ON o.id = w.object_id AND o.class = 9
                               INNER JOIN ships s ON s.id = w.place_id AND s.user_id = {$user->uid}
                                    WHERE s.fleet_id = $shid AND w.place_type = 2", 'cnt' );
        } else {
          $place = db_fetch_row( "SELECT s.place_id, s.place_type, st.agrav, st.planet, st.hyper, st.w_power, s.guard, st.titul, st.harvest, st.hot,
                                         st.remote, s.interupt, s.arg1, s.arg2, s.inwar, st.radar, s.abordage, s.object_id, se.event_type
                                    FROM ships s
                              INNER JOIN ship_types st ON st.object_id = s.object_id
                               LEFT JOIN space_events se ON se.ship_id = s.id AND se.event_type < 100
                                   WHERE s.id = $shid AND ( s.user_id IS NULL OR s.user_id = ".$user->uid.')' );

          $unpack = db_fetch_val( "SELECT COUNT(*) cnt FROM warehouse w
                               INNER JOIN objects o ON o.id = w.object_id AND o.class = 9
                               INNER JOIN ships s ON s.id = w.place_id AND s.user_id = {$user->uid}
                                    WHERE w.place_id = $shid AND w.place_type = 2", 'cnt' );
        }

        if( !isset( $place ) || count( $place ) == 0 || !isset( $place['place_id'] ) ) {
          $out = "err=2";
          break;
        }

        if( $place['titul'] > $user->titul % 11 ) {
          $need = db_fetch_row( "SELECT t1.name name1, t2.name name2
                                   FROM tituls t1
                             INNER JOIN tituls t2 ON t2.id = ( t1.id + 11 )
                                  WHERE t1.id = ".$place['titul'] );

          $out .= "&id0=999&name0=Необходим титул {$need['name1']} или {$need['name2']}";
          $cnt++;

          if( $type == 'F' ) {
            if( $place['place_type'] != 5 && $place['inwar'] == 0 && $place['event_type'] == 0 ) {
              $out .= "&id$cnt=7&name$cnt=Расформировать флот";
              $cnt++;
            }
            $out .= "&id$cnt=10&name$cnt=Содержимое грузовых отсеков";
            $cnt++;
          } else {
            $out .= "&id$cnt=10&name$cnt=Содержимое грузового отсека";
            $cnt++;
          }

          break;
        }

        if( $place['inwar'] == 0 && $user->block == 0 ) {
          switch( $place['place_type'] ) {
  
            case 0: // orbit
              $test = db_fetch_row( "SELECT p.type, p.user_id, p.name, s.name sname, p.star_id
                                       FROM planets p
                                 INNER JOIN stars s ON s.id = p.star_id
                                      WHERE p.id = ".$place['place_id'] );

              $defence = db_fetch_row( "SELECT IFNULL( d.status, 0 ) status, u.id user_id, u.login
                                          FROM defence d
                                    INNER JOIN users u ON u.id = d.user_id
                                    INNER JOIN planets_buildings pb ON pb.object_id IN (27, 28, 29, 30, 31) AND pb.planet_id = d.place_id
                                     LEFT JOIN foe fe ON fe.user_id = d.user_id AND fe.foe_id = {$user->uid}
                                     LEFT JOIN friend fr ON fr.user_id = d.user_id AND fr.friend_id = {$user->uid}
                                         WHERE d.place_id = ".$place['place_id']." AND d.place_type = 1 AND (
                                               ( d.status = 1 ) OR
                                               ( d.status = 2 AND fe.user_id is not null ) OR
                                               ( d.status = 3 AND fr.user_id is null ) OR
                                               ( d.status = 4 AND u.aliance != {$user->aliance} ) ) AND d.user_id != ".$user->uid );

              $show_order = db_fetch_row( "SELECT IFNULL( d.status, 0 ) status, user_id
                                             FROM defence d
                                       INNER JOIN planets_buildings pb ON pb.object_id IN (27, 28, 29, 30, 31) AND pb.planet_id = d.place_id
                                            WHERE d.place_id = ".$place['place_id']." AND d.place_type = 1 AND d.user_id != ".$user->uid );

              $test_ships = db_fetch_row( "SELECT COUNT(*) id, GROUP_CONCAT( DISTINCT IF( st.corsar = 0, s.user_id, 'corsar' ) SEPARATOR ',' ) users
                                             FROM ships s
                                       INNER JOIN users u ON u.id = s.user_id
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                        LEFT JOIN foe fe ON fe.user_id = s.user_id AND fe.foe_id = {$user->uid}
                                        LEFT JOIN friend fr ON fr.user_id = s.user_id AND fr.friend_id = {$user->uid}
                                            WHERE ( ( s.guard = 1 ) OR
                                                    ( s.guard = 2 AND fe.user_id is not null ) OR
                                                    ( s.guard = 3 AND fr.user_id is null ) OR
                                                    ( s.guard = 4 AND u.aliance != {$user->aliance} )
                                                  ) AND s.fleet_id IS null AND s.user_id != ".$user->uid." AND s.place_type = 1 AND s.place_id = ".$place['place_id'] );

              $test_fleets = db_fetch_row( "SELECT COUNT(*) id, GROUP_CONCAT( DISTINCT IF( ( SELECT MIN( st.corsar )
                                                             FROM ships s
                                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                                            WHERE s.fleet_id = f.id ) = 0, f.user_id, 'corsar' ) SEPARATOR ',' ) users
                                              FROM fleets f
                                        INNER JOIN users u ON u.id = f.user_id
                                         LEFT JOIN foe fe ON fe.user_id = f.user_id AND fe.foe_id = {$user->uid}
                                         LEFT JOIN friend fr ON fr.user_id = f.user_id AND fr.friend_id = {$user->uid}
                                             WHERE ( ( f.guard = 1 ) OR
                                                     ( f.guard = 2 AND fe.user_id is not null ) OR
                                                     ( f.guard = 3 AND fr.user_id is null ) OR
                                                     ( f.guard = 4 AND u.aliance != {$user->aliance} )
                                                    ) AND f.user_id != ".$user->uid." AND f.place_type = 1 AND f.place_id = ".$place['place_id'] );

              if( ( ( $test['type'] == 3 || $test['type'] == 4 || $test['type'] == 5 ) && ( $defence['status'] > 0 ||
                      $test_ships['id'] > 0 || $test_fleets['id'] > 0 || $show_order['status'] > 0 ) ) && $place['event_type'] == 0 ) {

                $s_ships = explode( ',', $test_ships['users'] );
                $s_fleets = explode( ',', $test_fleets['users'] );
                $sec = '';
                $security = array();

                if( $show_order['user_id'] ) {
                  $security[ $show_order['user_id'] ] = 1;
                }

                if( $defence['user_id'] ) {
                  $security[ $defence['user_id'] ] = 1;
                }

                if( is_array( $s_ships ) ) {
                  foreach( $s_ships as $u ) {
                    if( is_numeric( $u ) ) {
                      $security[ $u ] = 1;
                    } else {
                      $sec = 'Corsar';
                    }
                  }
                }

                if( is_array( $s_fleets ) ) {
                  foreach( $s_fleets as $u ) {
                    if( is_numeric( $u ) ) {
                      $security[ $u ] = 1;
                    } else {
                      $sec = 'Corsar';
                    }
                  }
                }

                unset( $security[null] );
                if( count( $security ) ) {

                  if( $user->qt == 31 ) {
                    $quest = db_fetch_row( "SELECT u2.user_id, u2.arg0 uid, uq.arg0 uname, uq.arg1, uq.arg2, u2.currency, u2.summ
                                              FROM u2u_quests u2
                                        INNER JOIN users_quests uq ON uq.id = u2.event_id
                                             WHERE u2.event_id = {$user->iq}" );

                    if( isset( $security[$quest['uid']] ) ) {
                      send_msg( 1, $user->uid, "Задание выполненно, вы получаете вознаграждение в {$quest['arg1']} {$quest['arg2']}", 20 );
                      send_msg( 1, $quest['user_id'], "Ваше задание по поиску колоний пилота \"{$quest['uname']}\" выполнено! Колония {$test['name']} находится в системе {$test['sname']}.", 20 );

                      if( $quest['currency'] == 1 ) {
                        db_query( "UPDATE users u SET u.donate = u.donate + {$quest['summ']}, u.credits = u.credits + {$quest['summ']} WHERE u.id = {$user->uid}" );
                      } else {
                        db_query( "UPDATE users u SET u.money = u.money + {$quest['summ']} WHERE u.id = {$user->uid}" );
                      }

                      db_query( "UPDATE users_quests SET status = status - 1 WHERE id = ".$user->iq );
                    }
                  }

                  $users = implode( ',', array_keys( $security ) );
                  $sec = db_fetch_val( "SELECT GROUP_CONCAT( DISTINCT login SEPARATOR ',' ) logins FROM users WHERE id IN( $users )", 'logins' );
                } else {
                  $sec = 'нет данных';
                }

                if( $limit >= 0 ) {
                  if( $place['w_power'] > 0 ) {
                    $out .= "&id$cnt=14&name$cnt=Атаковать планету (".$sec.')';
                    $cnt++;
                  } else {
                    $out .= "&id$cnt=15&name$cnt=Нет оружия атаковать планету (".$sec.')';
                    $cnt++;
                  }
                }
              }
  
              if( $place['harvest'] > 0 ) {
                if( $limit >= 0 ) {
                  if( $place['event_type'] == 0 ) {
                    $trash = db_fetch_val( "SELECT SUM( object_cnt ) cnt
                                              FROM trash
                                             WHERE place_type = {$place['place_type']} AND place_id = {$place['place_id']}", 'cnt' );
                    if( $trash > 0 ) {
                      $out .= "&id$cnt=44&name$cnt=Собрать $trash обломков";
                      $cnt++;
                    }
                  } else {
                    $out .= "&id$cnt=44&name$cnt=Отменить сбор обломков";
                    $cnt++;
                  }
                }
              }

              if( $place['hot'] > 0 ) {
                if( $limit >= 0 ) {
                  if( $place['event_type'] == 0 ) {
                    $hot = 1 + get_book_level( 37, $user->uid );

                    $list = db_fetch_array( "SELECT id, len, round( ( UNIX_TIMESTAMP( NOW() ) - UNIX_TIMESTAMP( event_time ) ) ) timer
                                               FROM hot_way
                                              WHERE event_time > DATE_SUB( now() , INTERVAL $hot * 3 HOUR ) AND
                                                    id_from = {$test['star_id']}
                                           ORDER BY event_time DESC
                                              LIMIT 0, $hot" );

                    if( count( $list ) > 0 ) {
                      $l = 1;
                      foreach( $list as $id ) {
                        $out .= "&id$cnt=47:{$id['id']}&name$cnt=След $l дальность {$id['len']} давность ".time_to_str( $id['timer'] );

                        $l++;
                        $cnt++;
                      }
                    } else {
                      $out .= "&id$cnt=15&name$cnt=Следов не обнаружено";
                      $cnt++;
                    }
                  }
                }
              }

              if( $limit >= 0 ) {
                if( $place['remote'] > 0 ) {
                  $mtest = db_fetch_row( "SELECT type FROM planets WHERE id = ".$place['place_id'] );
                  if( $mtest['type'] != 1 ) {
                    $out .= "&id$cnt=22&name$cnt=Запустить добычу";
                    $cnt++;
                    $out .= "&id$cnt=35&name$cnt=Запустить преобразователи";
                    $cnt++;
                    $out .= "&id$cnt=36&name$cnt=Запустить все сборочные цеха";
                    $cnt++;
                    $out .= "&id$cnt=43&name$cnt=Остановить добычу";
                    $cnt++;
                    $out .= "&id$cnt=48&name$cnt=Остановить преобразователи";
                    $cnt++;
                  }
                }
              }
  
              if( $place['agrav'] > 0 && $place['event_type'] == 0 ) {
                if( $limit >= 0 ) {
                  if( $test['type'] == 1 && $user->uid == $test['user_id'] ) {
                    $out .= "&id$cnt=1&name$cnt=Приземлиться на планету";
                    $cnt++;
                  } else {
                    if( ( $test['type'] == 3 || $test['type'] == 4 || $test['type'] == 5 ) &&
                          $defence['status'] == 0 && $test_ships['id'] == 0 && $test_fleets['id'] == 0 && $place['event_type'] == 0 ) {
                      $out .= "&id$cnt=1&name$cnt=Приземлиться на планету";
                      $cnt++;
                    }
                  }
                }
              }
        
              if( $limit >= 0 ) {
                if( ( $test['type'] == 1 || $test['type'] == 3 || $test['type'] == 4 || $test['type'] == 5 ) &&
                    isset( $place['object_id'] ) && $place['object_id'] == 9310 && $place['event_type'] == 0 ) {
                  $out .= "&id$cnt=37&name$cnt=Исследовать планету";
                  $cnt++;
                }

                if( ( $test['type'] == 1 || $test['type'] == 3 || $test['type'] == 4 || $test['type'] == 5 ) &&
                    isset( $place['object_id'] ) && $place['object_id'] == 9355 && $place['event_type'] == 0 ) {
                  $out .= "&id$cnt=40&name$cnt=Саботировать мятеж";
                  $cnt++;
                }
              }

              if( $limit >= 0 ) {
                if( ( ( $test['type'] == 1 && $user->uid == $test['user_id'] ) || $test['type'] == 2 || $test['type'] == 3 || $test['type'] == 4 || $test['type'] == 5 ) &&
                    isset( $place['object_id'] ) && $place['object_id'] == 9321 ) {
                  if( $place['event_type'] == 0 ) {
                    $gates = db_fetch_array( "SELECT se.id, se.arg1
                                                 FROM space_events se
                                           INNER JOIN ships s ON s.id = se.ship_id
                                                WHERE se.event_type = 7 AND se.arg2 IS NULL AND s.user_id = ".$user->uid );

                    if( count( $gates ) == 0 ) {
                      $out .= "&id$cnt=38&name$cnt=Открыть вход врат";
                      $cnt++;
                    }

                    if( count( $gates ) == 1 ) {
                      $pair = array_shift( $gates );
                      $planets = db_fetch_array( "SELECT p.type, p.star_id FROM planets p WHERE p.id IN ( {$place['place_id']}, {$pair['arg1']} )" );

                      if( count( $planets ) == 2 && $planets[0]['type'] != 1 && $planets[1]['type'] != 1 ) {
                        $out .= "&id$cnt=38&name$cnt=Открыть выход врат";
                        $cnt++;
                      }

                      if( isset( $planets[1] ) && ( $planets[0]['type'] == 1 xor $planets[1]['type'] == 1 ) ) {
                        $apposite = $planets[0]['type'] == 1 ? $planets[1]['star_id'] : $planets[0]['star_id'];
                        if( $apposite ) {
                          $allow = db_fetch_val( "SELECT count(*) cnt FROM planets p WHERE type = 1 AND star_id = $apposite", 'cnt' );
                        } else {
                          $allow = 0;
                          $apposite = 0;
                        }

                        if( $allow == 0 ) {
                          $check = db_fetch_val( "SELECT count(*) cnt
                                                    FROM space_events se
                                                   WHERE ( se.user_id != {$user->uid} OR se.arg2 IS NOT NULL ) AND se.arg1 IN (SELECT id FROM planets WHERE star_id = $apposite)", 'cnt' );
                          if( $check == 0 ) {
                            $out .= "&id$cnt=38&name$cnt=Открыть выход врат";
                            $cnt++;
                          }
                        }
                      }
                    }
                  }
  
                  if( $place['event_type'] == 7 ) {
                    $out .= "&id$cnt=38&name$cnt=Отменить открытие врат";
                    $cnt++;
                  }
                }
              }

              if( $limit >= 0 ) {
                if( $place['planet'] > 0 && $place['event_type'] == 0 ) {
                  $out .= "&id$cnt=8&name$cnt=Переместиться в системе";
                  $cnt++;
                }

                if( $place['hyper'] > 0 && $place['event_type'] == 0 ) {
                  $out .= "&id$cnt=9&name$cnt=Переместиться в галактике";
                  $cnt++;
                  $out .= "&id$cnt=41&name$cnt=Отправить к родной звезде";
                  $cnt++;
                }
              }
        
              $test = db_fetch_array( "SELECT id, object_id, x
                                         FROM orbits_buildings
                                        WHERE planet_id = ".$place['place_id']." AND object_id = 3001 ORDER BY object_id" );

              $no_dock = db_fetch_val( "SELECT f.foe_id
                                          FROM foe f
                                    INNER JOIN planets p ON p.user_id = f.user_id
                                         WHERE f.foe_id = {$user->uid} AND p.id = ".$place['place_id'], 'foe_id' );

              if( !$no_dock ) {
                if( $place['event_type'] == 0 ) {
                  if( is_array( $test ) && count( $test ) > 0 ) {
                    foreach( $test as $station ) {
                      $out .= "&id$cnt=4:{$station['x']}&name$cnt=Пристыковать к торговой станции";
                      $cnt++;
                    }
                  } else {
                    $test = db_fetch_array( "SELECT id, object_id, x
                                               FROM orbits_buildings
                                              WHERE planet_id = ".$place['place_id']." AND object_id = 3004 ORDER BY object_id LIMIT 0,1" );

                    foreach( $test as $station ) {
                      $out .= "&id$cnt=4:{$station['x']}&name$cnt=Пристыковать к складу ".$station['x'];
                      $cnt++;
                    }
                  }
                }
              } else {
                $out .= "&id$cnt=15&name$cnt=В стыковке врагам отказано";
                $cnt++;
              }

              if( $place['w_power'] > 0 && $place['event_type'] == 0 ) {
                $test = db_fetch_row( "SELECT type FROM planets WHERE id = ".$place['place_id'] );
                if( $test['type'] != 1 ) {
                  if( $place['guard'] == 0 ) {
                    $out .= "&id$cnt=20:1&name$cnt=Атаковать всех";
                    $cnt++;
                    $out .= "&id$cnt=20:2&name$cnt=Атаковать врагов";
                    $cnt++;
                    $out .= "&id$cnt=20:3&name$cnt=Атаковать не друзей";
                    $cnt++;
                    if( $user->aliance ) {
                      $out .= "&id$cnt=20:4&name$cnt=Атаковать не альянс";
                      $cnt++;
                    }
                  } else {
                    $out .= "&id$cnt=21&name$cnt=Отменить охрану ({$guard_txt[$place['guard']]})";
                    $cnt++;
                  }
                }
              }

              if( $type == 'F' ) {
                $can_dock = db_fetch_row( "SELECT MAX( st.dock ) dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.fleet_id = $shid" );
              } else {
                $can_dock = db_fetch_row( "SELECT st.dock dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.id = $shid" );
              }

              if( $limit >= 0 ) {
                if( $can_dock['dock'] > 0 ) {
                  $out .= "&id$cnt=39&name$cnt=Отстыковать все";
                  $cnt++;
                }
              }

              if( $limit >= 0 ) {
                if( $unpack > 0 ) {
                  $out .= "&id$cnt=30&name$cnt=Расконсервировать все";
                  $cnt++;
                }
              }

              if( $place['event_type'] == 0 ) {
                if( $type == 'F' ) {
                  $need_free = db_fetch_row( "SELECT SUM( o.mass ) cmass, SUM( o2.mass ) omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.fleet_id = $shid" );
                } else {
                  $need_free = db_fetch_row( "SELECT o.mass cmass, o2.mass omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.id = $shid" );
                }

                if( isset( $need_free['cmass'] ) && $need_free['cmass'] ) {
                  $ships = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                              FROM ships s
                                        INNER JOIN ship_types st ON st.object_id = s.object_id
                                             WHERE st.cargo > {$need_free['cmass']} AND s.object_id IN (9161, 9180, 9399) AND s.user_id = {$user->uid} AND s.place_type=0 AND s.place_id={$place['place_id']}
                                          ORDER BY s.name" );

                  $fleets = array();
                  foreach( $ships as $ship ) {
                    if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                      if( get_cargo( $ship['id'], true ) >= $need_free['cmass'] && $ship['id'] != $shid ) {
                        $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );

                        $out .= "&id$cnt=28:{$ship['id']}&name$cnt=Законсервировать в ".$ship['name'];
                        $cnt++;
                      }
                    }
                  }

                  $mks = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                            FROM ships s
                                      INNER JOIN ship_types st ON st.object_id = s.object_id
                                           WHERE st.cargo > {$need_free['omass']} AND st.dock = 1 AND s.user_id = {$user->uid} AND s.place_type = 0 AND s.place_id={$place['place_id']}
                                        ORDER BY s.name" );

                  $fleets = array();
                  foreach( $mks as $ship ) {
                    if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                      if( get_cargo( $ship['id'], true ) >= $need_free['omass'] && $ship['id'] != $shid ) {
                        $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );

                        $out .= "&id$cnt=31:{$ship['id']}&name$cnt=Пристыковаться к ".$ship['name'];
                        $cnt++;
                      }
                    }
                  }
                }
              }
              break;
  
            case 1: // planet
  
              if( $limit >= 0 ) {
                if( $place['agrav'] > 0  && $place['event_type'] == 0 ) {
  
                  $test = db_fetch_row( "SELECT type, user_id FROM planets WHERE id = ".$place['place_id'] );

                  $defence = db_fetch_row( "SELECT IFNULL( d.status, 0 ) status, u.id user_id, u.login
                                              FROM defence d
                                        INNER JOIN users u ON u.id = d.user_id
                                        INNER JOIN orbits_buildings ob ON ob.object_id IN (3007, 3008, 3009) AND ob.planet_id = d.place_id
                                         LEFT JOIN foe fe ON fe.user_id = d.user_id AND fe.foe_id = {$user->uid}
                                         LEFT JOIN friend fr ON fr.user_id = d.user_id AND fr.friend_id = {$user->uid}
                                             WHERE d.place_id = ".$place['place_id']." AND d.place_type = 0 AND (
                                                   ( d.status = 1 ) OR
                                                   ( d.status = 2 AND fe.user_id is not null ) OR
                                                   ( d.status = 3 AND fr.user_id is null ) OR
                                                   ( d.status = 4 AND u.aliance != {$user->aliance} ) ) AND d.user_id != ".$user->uid );

                  $test_ships = db_fetch_row( "SELECT COUNT(*) id, GROUP_CONCAT( DISTINCT IF( st.corsar = 0, s.user_id, 'corsar' ) SEPARATOR ',' ) users
                                                 FROM ships s
                                           INNER JOIN users u ON u.id = s.user_id
                                           INNER JOIN ship_types st ON st.object_id = s.object_id
                                            LEFT JOIN foe fe ON fe.user_id = s.user_id AND fe.foe_id = {$user->uid}
                                            LEFT JOIN friend fr ON fr.user_id = s.user_id AND fr.friend_id = {$user->uid}
                                                WHERE ( ( s.guard = 1 ) OR
                                                        ( s.guard = 2 AND fe.user_id is not null ) OR
                                                        ( s.guard = 3 AND fr.user_id is null ) OR
                                                        ( s.guard = 4 AND u.aliance != {$user->aliance} )
                                                      ) AND s.fleet_id IS null AND s.user_id != ".$user->uid." AND s.place_type = 0 AND s.place_id = ".$place['place_id'] );

                   $test_fleets = db_fetch_row( "SELECT COUNT(*) id, GROUP_CONCAT( DISTINCT IF( ( SELECT MIN( st.corsar )
                                                                FROM ships s
                                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                                               WHERE s.fleet_id = f.id ) = 0, f.user_id, 'corsar' ) SEPARATOR ',' ) users
                                                   FROM fleets f
                                             INNER JOIN users u ON u.id = f.user_id
                                              LEFT JOIN foe fe ON fe.user_id = f.user_id AND fe.foe_id = {$user->uid}
                                              LEFT JOIN friend fr ON fr.user_id = f.user_id AND fr.friend_id = {$user->uid}
                                                  WHERE ( ( f.guard = 1 ) OR
                                                          ( f.guard = 2 AND fe.user_id is not null ) OR
                                                          ( f.guard = 3 AND fr.user_id is null ) OR
                                                          ( f.guard = 4 AND u.aliance != {$user->aliance} )
                                                        ) AND f.user_id != ".$user->uid." AND f.place_type = 0 AND f.place_id = ".$place['place_id'] );

                  if( ( $test['type'] == 3 || $test['type'] == 4 || $test['type'] == 5 ) && $defence['status'] > 0 ||
                        $test_ships['id'] > 0 || $test_fleets['id'] > 0 ) {

                    $s_ships = explode( ',', $test_ships['users'] );
                    $s_fleets = explode( ',', $test_fleets['users'] );
                    $sec = '';
                    $security = array();

                    if( $defence['user_id'] ) {
                      $security[ $defence['user_id'] ] = 1;
                    }

                    if( is_array( $s_ships ) ) {
                      foreach( $s_ships as $u ) {
                        if( is_numeric( $u ) ) {
                          $security[ $u ] = 1;
                        } else {
                          $sec = 'Corsar';
                        }
                      }
                    }

                    if( is_array( $s_fleets ) ) {
                      foreach( $s_fleets as $u ) {
                        if( is_numeric( $u ) ) {
                          $security[ $u ] = 1;
                        } else {
                          $sec = 'Corsar';
                        }
                      }
                    }

                    unset( $security[null] );
                    if( count( $security ) ) {
                      $users = implode( ',', array_keys( $security ) );
                      $sec = db_fetch_val( "SELECT GROUP_CONCAT( DISTINCT login SEPARATOR ',' ) logins FROM users WHERE id IN( $users )", 'logins' );
                    } else {
                      $sec = 'нет данных';
                    }

                    if( $place['w_power'] > 0 ) {
                      $out .= "&id$cnt=18&name$cnt=Атаковать орбиту (".$sec.')';
                      $cnt++;
                    } else {
                      if( isset( $place['object_id'] ) && ( $place['object_id'] == 9310 || $place['object_id'] == 9355 ) ) {
                        $out .= "&id$cnt=2&name$cnt=Выйти на орбиту (".$sec.')';
                        $cnt++;
                      } else {
                        $out .= "&id$cnt=19&name$cnt=Нет оружия атаковать орбиту (".$sec.')';
                        $cnt++;
                      }
                    }
                  } else {
                    $out .= "&id$cnt=2&name$cnt=Выйти на орбиту";
                    $cnt++;
                  }
                }
              }

              if( ( $user->real_type == 2 && $type == 'S' ) && $user->real_id == $shid ) {
                $out .= "&id$cnt=5&name$cnt=Покинуть корабль";
                $cnt++;
              }
  
              if( ( $user->real_type == 6 && $type == 'F' ) && $user->real_id == $shid ) {
                $out .= "&id$cnt=5&name$cnt=Покинуть флот";
                $cnt++;
              }
  
              if( $user->real_type == 1 ) {
                if( $type == 'F' ) {
                  $ship = get_place_info( $shid, 6 );
                } else {
                  $ship = get_place_info( $shid, 2 );
                }
                if( $ship->place_id == $user->real_id && $ship->place_type == $user->real_type ) {
                  $out .= "&id$cnt=6&name$cnt=Переместиться в корабль";
                  $cnt++;
                }
              }
  
              if( $limit >= 0 ) {
                if( $place['w_power'] > 0 && $place['event_type'] == 0 ) {
                  $test = db_fetch_row( "SELECT type FROM planets WHERE id = ".$place['place_id'] );
                  if( $test['type'] != 1 ) {
                    if( $place['guard'] == 0 ) {
                      $out .= "&id$cnt=20:1&name$cnt=Атаковать всех";
                      $cnt++;
                      $out .= "&id$cnt=20:2&name$cnt=Атаковать врагов";
                      $cnt++;
                      $out .= "&id$cnt=20:3&name$cnt=Атаковать не друзей";
                      $cnt++;
                      if( $user->aliance ) {
                        $out .= "&id$cnt=20:4&name$cnt=Атаковать не альянс";
                        $cnt++;
                      }
                    } else {
                      $out .= "&id$cnt=21&name$cnt=Отменить охрану ({$guard_txt[$place['guard']]})";
                      $cnt++;
                    }
                  }
                }
              }
  
              if( $limit >= 0 ) {
                if( $place['harvest'] > 0 ) {
                  if( $place['event_type'] == 0 ) {
                    $trash = db_fetch_val( "SELECT SUM( object_cnt ) cnt
                                              FROM trash
                                             WHERE place_type = {$place['place_type']} AND place_id = {$place['place_id']}", 'cnt' );

                    if( $trash > 0 ) {
                      $out .= "&id$cnt=44&name$cnt=Собрать $trash обломков";
                      $cnt++;
                    }
                  } else {
                    $out .= "&id$cnt=44&name$cnt=Отменить сбор обломков";
                    $cnt++;
                  }
                }
              }

              if( $limit >= 0 ) {
                if( $place['remote'] > 0 ) {
                  $test = db_fetch_row( "SELECT type FROM planets WHERE id = ".$place['place_id'] );
                  if( $test['type'] != 1 ) {
                    $out .= "&id$cnt=22&name$cnt=Запустить добычу";
                    $cnt++;
                    $out .= "&id$cnt=23&name$cnt=Запустить переработку";
                    $cnt++;
                    $out .= "&id$cnt=24&name$cnt=Запустить переработку ископаемых";
                    $cnt++;
                    $out .= "&id$cnt=34&name$cnt=Запустить все заводы";
                    $cnt++;
                    $out .= "&id$cnt=36&name$cnt=Запустить все сборочные цеха";
                    $cnt++;
                    $out .= "&id$cnt=43&name$cnt=Остановить добычу";
                    $cnt++;
                  }
                }
              }

              if( $type == 'F' ) {
                $can_dock = db_fetch_row( "SELECT MAX( st.dock ) dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.fleet_id = $shid" );
              } else {
                $can_dock = db_fetch_row( "SELECT st.dock dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.id = $shid" );
              }

              if( $limit >= 0 ) {
                if( $can_dock['dock'] > 0 ) {
                  $out .= "&id$cnt=39&name$cnt=Отстыковать все";
                  $cnt++;
                }

                if( $unpack > 0 ) {
                  $out .= "&id$cnt=30&name$cnt=Расконсервировать все";
                  $cnt++;
                }
              }

              $free = get_warehouse( $place['place_id'], 1 );

              if( !( $type == 'S' && ( $user->real_type == 2 && $user->real_id == $shid ) ) &&
                  !( $type == 'F' && ( $user->real_type == 6 && $user->real_id == $shid ) ) &&
                  $place['event_type'] == 0 && $free > 0 ) {
                $out .= "&id$cnt=12&name$cnt=Законсервировать";
                $cnt++;
              } elseif( $free <= 0 ) {
                $out .= "&id$cnt=15&name$cnt=Нет места для консервации";
                $cnt++;
              }
  
              if( $place['event_type'] == 0 ) {
                if( $type == 'F' ) {
                  $need_free = db_fetch_row( "SELECT SUM( o.mass ) cmass, SUM( o2.mass ) omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.fleet_id = $shid" );
                } else {
                  $need_free = db_fetch_row( "SELECT o.mass cmass, o2.mass omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.id = $shid" );
                }
    
                $ships = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                            FROM ships s
                                      INNER JOIN ship_types st ON st.object_id = s.object_id
                                           WHERE st.cargo > {$need_free['cmass']} AND s.object_id IN (9161, 9180, 9399) AND s.user_id = {$user->uid} AND s.place_type=1 AND s.place_id={$place['place_id']}
                                        ORDER BY s.name" );

                $fleets = array();
                foreach( $ships as $ship ) {
                  if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                    if( get_cargo( $ship['id'], true ) >= $need_free['cmass'] && $ship['id'] != $shid ) {
                      $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );
  
                      $out .= "&id$cnt=28:{$ship['id']}&name$cnt=Законсервировать в ".$ship['name'];
                      $cnt++;
                    }
                  }
                }

                $mks = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                          FROM ships s
                                    INNER JOIN ship_types st ON st.object_id = s.object_id
                                         WHERE st.cargo > {$need_free['omass']} AND st.dock = 1 AND s.user_id = {$user->uid} AND s.place_type=1 AND s.place_id={$place['place_id']}
                                      ORDER BY s.name" );

                $fleets = array();
                foreach( $mks as $ship ) {
                  if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                    if( get_cargo( $ship['id'], true ) >= $need_free['omass'] && $ship['id'] != $shid ) {
                      $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );
  
                      $out .= "&id$cnt=31:{$ship['id']}&name$cnt=Пристыковаться к ".$ship['name'];
                      $cnt++;
                    }
                  }
                }
              }
              break;
  
            case 2: // in the ship

              if( ( $user->real_type == 2 && $type == 'S' ) && $user->real_id == $shid ) {
                $out .= "&id$cnt=5&name$cnt=Покинуть корабль";
                $cnt++;
              }
  
              if( ( $user->real_type == 6 && $type == 'F' ) && $user->real_id == $shid ) {
                $out .= "&id$cnt=5&name$cnt=Покинуть флот";
                $cnt++;
              }

              if( $user->real_type == 2 ) {
                if( $type == 'F' ) {
                  $ship = get_place_info( $shid, 6 );
                } else {
                  $ship = get_place_info( $shid, 2 );
                }
                if( $ship->place_id == $user->real_id && $ship->place_type == $user->real_type ) {
                  $out .= "&id$cnt=6&name$cnt=Переместиться в корабль";
                  $cnt++;
                }
              }

              if( $user->real_type == 6 ) {
                if( $type == 'F' ) {
                  $ship = get_place_info( $shid, 6 );
                } else {
                  $ship = get_place_info( $shid, 2 );
                }
                $fleet = db_fetch_row( "SELECT s.fleet_id FROM ships s WHERE s.id = ".$ship->place_id );

                if( $fleet['fleet_id'] && $user->real_id == $fleet['fleet_id'] && $ship->place_type == 2 
                    && ( !isset( $place['object_id'] ) || $place['object_id'] != 9310 || $place['object_id'] != 9355 ) ) {
                  $out .= "&id$cnt=6&name$cnt=Переместиться в корабль";
                  $cnt++;
                }
              }

              if( $type == 'F' ) {
                $need_free = db_fetch_row( "SELECT SUM( o.mass ) cmass, SUM( o2.mass ) omass
                                              FROM ships s
                                        INNER JOIN ship_types st ON st.object_id = s.object_id
                                        INNER JOIN objects o ON o.id = st.conserv_id
                                        INNER JOIN objects o2 ON o2.id = s.object_id
                                             WHERE s.fleet_id = $shid" );
              } else {
                $need_free = db_fetch_row( "SELECT o.mass cmass, o2.mass omass
                                              FROM ships s
                                        INNER JOIN ship_types st ON st.object_id = s.object_id
                                        INNER JOIN objects o ON o.id = st.conserv_id
                                        INNER JOIN objects o2 ON o2.id = s.object_id
                                             WHERE s.id = $shid" );
              }
  
              $ships = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                          FROM ships s
                                    INNER JOIN ship_types st ON st.object_id = s.object_id
                                         WHERE ( st.cargo > {$need_free['cmass']} AND s.object_id IN (9161, 9180, 9399) AND s.user_id = {$user->uid} AND
                                               s.place_type=2 AND s.place_id={$place['place_id']} ) OR ( id = {$place['place_id']} )
                                      ORDER BY s.name" );

              $fleets = array();
              foreach( $ships as $ship ) {
                if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                  if( get_cargo( $ship['id'], true ) >= $need_free['cmass'] && $ship['id'] != $shid ) {
                    $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );

                    $out .= "&id$cnt=28:{$ship['id']}&name$cnt=Законсервировать в ".$ship['name'];
                    $cnt++;
                  }
                }
              }

              if( $limit >= 0 ) {
                $parent = db_fetch_row( "SELECT s.id, s.inwar, s.place_type FROM ships s WHERE s.place_type IN ( 0, 1, 3, 7, 8 ) AND s.id = ".$place['place_id'] );
                if( $parent['inwar'] == 0 || $parent['inwar'] != 8 || ( $user->qt != 33 && $user->qt != 34 ) ) {
                  if( $parent['id'] ) {
                    $out .= "&id$cnt=3&name$cnt=Отстыковаться";
                    $cnt++;
                  }
                }
              }
              break;
  
            case 3: // in the station
              if( ( $user->real_type == 2 && $type == 'S' ) && $user->real_id == $shid ) {
                $out .= "&id$cnt=5&name$cnt=Покинуть корабль";
                $cnt++;
              }
              if( ( $user->real_type == 6 && $type == 'F' ) && $user->real_id == $shid ) {
                $out .= "&id$cnt=5&name$cnt=Покинуть флот";
                $cnt++;
              }
              if( $limit >= 0 ) {
                $out .= "&id$cnt=3&name$cnt=Отстыковаться";
                $cnt++;
              }

              $myplanet = db_fetch_row( "SELECT p.id, p.user_id
                                           FROM planets p
                                     INNER JOIN orbits_buildings o ON o.planet_id = p.id
                                          WHERE o.id = ".$place['place_id'] );

              $free = get_warehouse( $myplanet['id'], 0 );

              if( $myplanet['user_id'] == $user->uid || $myplanet['user_id'] == '' ) {
                if( $free > 0 &&
                    !( $type == 'S' && ( $user->real_type == 2 && $user->real_id == $shid ) ) &&
                    !( $type == 'F' && ( $user->real_type == 6 && $user->real_id == $shid ) ) ) {
                  $out .= "&id$cnt=12&name$cnt=Законсервировать";
                  $cnt++;
                } elseif( $free <= 0 ) {
                  $out .= "&id$cnt=15&name$cnt=Нет места для консервации";
                  $cnt++;
                }
              }

              if( $user->real_type == 3 ) {
                if( $type == 'F' ) {
                  $ship = get_place_info( $shid, 6 );
                } else {
                  $ship = get_place_info( $shid, 2 );
                }
                if( $ship->place_id == $user->real_id &&
                    $ship->place_type == $user->real_type && ( !isset( $place['object_id'] ) || $place['object_id'] != 9310 || $place['object_id'] != 9355 ) ) {
                  $out .= "&id$cnt=6&name$cnt=Переместиться в корабль";
                  $cnt++;
                }
              }
              break;
  
            case 5:
              $test = db_fetch_row( "SELECT se.id, se.event_type, se.from_type FROM space_events se WHERE se.ship_id = $shid" );
              switch( $test['event_type'] ) {
                case 2:
                case 3:
                case 102:
                case 103:
                  $out .= "&id$cnt=29&name$cnt=Отменить перелет";
                  $cnt++;
                  break;
                case 4:
                case 5:
                case 104:
                case 105:
                  $out .= "&id$cnt=29&name$cnt=Отменить гиперпереход";
                  $cnt++;
                  break;
              }
              break;
  
            case 7: // in space point
              if( $limit >= 0 ) {
                if( $place['planet'] > 0 || $place['radar'] > 0 ) {
                  $out .= "&id$cnt=8&name$cnt=Переместиться в системе";
                  $cnt++;
                }

                if( $place['hyper'] > 0 ) {
                  $out .= "&id$cnt=9&name$cnt=Переместиться в галактике";
                  $cnt++;
                  $out .= "&id$cnt=41&name$cnt=Отправить к родной звезде";
                  $cnt++;
                }

                if( $place['w_power'] > 0 ) {
                  if( $place['guard'] == 0 ) {
                    $out .= "&id$cnt=20:1&name$cnt=Атаковать всех";
                    $cnt++;
                    $out .= "&id$cnt=20:2&name$cnt=Атаковать врагов";
                    $cnt++;
                    $out .= "&id$cnt=20:3&name$cnt=Атаковать не друзей";
                    $cnt++;
                    if( $user->aliance ) {
                      $out .= "&id$cnt=20:4&name$cnt=Атаковать не альянс";
                      $cnt++;
                    }
                  } else {
                    $out .= "&id$cnt=21&name$cnt=Отменить охрану ({$guard_txt[$place['guard']]})";
                    $cnt++;
                  }
                }
  
                if( $place['harvest'] > 0 ) {
                  if( $place['event_type'] == 0 ) {
                    $trash = db_fetch_val( "SELECT SUM( object_cnt ) cnt
                                              FROM trash
                                             WHERE place_type = {$place['place_type']} AND place_id = {$place['place_id']} AND
                                                   arg1 = {$place['arg1']} AND arg2 = {$place['arg2']}", 'cnt' );
  
                    if( $trash > 0 ) {
                      $out .= "&id$cnt=44&name$cnt=Собрать $trash обломков";
                      $cnt++;
                    }
                  } else {
                    $out .= "&id$cnt=44&name$cnt=Отменить сбор обломков";
                    $cnt++;
                  }
                }

                if( $place['hot'] > 0 ) {
                  if( $limit >= 0 ) {
                    if( $place['event_type'] == 0 ) {
                      $hot = 1 + get_book_level( 37, $user->uid );
  
                      $list = db_fetch_array( "SELECT id, len, round( ( UNIX_TIMESTAMP( NOW() ) - UNIX_TIMESTAMP( event_time ) ) ) timer
                                                 FROM hot_way
                                                WHERE event_time > DATE_SUB( now() , INTERVAL $hot * 3 HOUR ) AND
                                                      id_from = {$place['place_id']}
                                             ORDER BY event_time DESC
                                                LIMIT 0, $hot" );

                      if( count( $list ) > 0 ) {
                        $l = 1;
                        foreach( $list as $id ) {
                          $out .= "&id$cnt=47:{$id['id']}&name$cnt=След $l дальность {$id['len']} давность ".time_to_str( $id['timer'] );

                          $l++;
                          $cnt++;
                        }
                      } else {
                        $out .= "&id$cnt=15&name$cnt=Следов не обнаружено";
                        $cnt++;
                      }
                    }
                  }
                }
              }

              if( $place['interupt'] > 0 ) {
                $out .= "&id$cnt=45&name$cnt=Указать сообщение";
                $cnt++;

                if( $place['interupt'] == 1 ) {
                  $out .= "&id$cnt=26:2&name$cnt=Перехватывать всех";
                  $cnt++;
                  $out .= "&id$cnt=26:3&name$cnt=Перехватывать врагов";
                  $cnt++;
                  $out .= "&id$cnt=26:4&name$cnt=Перехватывать друзей";
                  $cnt++;
                  $out .= "&id$cnt=26:5&name$cnt=Перехватывать не врагов";
                  $cnt++;
                  $out .= "&id$cnt=26:6&name$cnt=Перехватывать не друзей";
                  $cnt++;
                  if( $user->aliance ) {
                    $out .= "&id$cnt=26:7&name$cnt=Перехватывать альянс";
                    $cnt++;
                    $out .= "&id$cnt=26:8&name$cnt=Перехватывать не альянс";
                    $cnt++;
                  }
                } else {
                  $out .= "&id$cnt=27&name$cnt=Отменить перехват ({$interupt_txt[$place['interupt']]})";
                  $cnt++;
                }
              }

              if( $type == 'F' ) {
                $can_dock = db_fetch_row( "SELECT MAX( st.dock ) dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.fleet_id = $shid" );
              } else {
                $can_dock = db_fetch_row( "SELECT st.dock dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.id = $shid" );
              }

              if( $limit >= 0 ) {
                if( $can_dock['dock'] > 0 ) {
                  $out .= "&id$cnt=39&name$cnt=Отстыковать все";
                  $cnt++;
                }

                if( $unpack > 0 ) {
                  $out .= "&id$cnt=30&name$cnt=Расконсервировать все";
                  $cnt++;
                }
              }

              if( $place['event_type'] == 0 ) {
                if( $type == 'F' ) {
                  $need_free = db_fetch_row( "SELECT SUM( o.mass ) cmass, SUM( o2.mass ) omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.fleet_id = $shid" );
                } else {
                  $need_free = db_fetch_row( "SELECT o.mass cmass, o2.mass omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.id = $shid" );
                }
    
                if( isset( $need_free['cmass'] ) && $need_free['cmass'] > 0 ) {
                  $ships = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                              FROM ships s
                                        INNER JOIN ship_types st ON st.object_id = s.object_id
                                             WHERE st.cargo > {$need_free['cmass']} AND s.object_id IN (9161, 9180, 9399) AND s.user_id = {$user->uid} AND
                                                   s.place_type=7 AND s.place_id={$place['place_id']} AND arg1={$place['arg1']} AND arg2={$place['arg2']} 
                                          ORDER BY s.name" );

                  $fleets = array();
                  foreach( $ships as $ship ) {
                    if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                      if( get_cargo( $ship['id'], true ) >= $need_free['cmass'] && $ship['id'] != $shid ) {
                        $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );
    
                        $out .= "&id$cnt=28:{$ship['id']}&name$cnt=Законсервировать в ".$ship['name'];
                        $cnt++;
                      }
                    }
                  }

                  $mks = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                            FROM ships s
                                      INNER JOIN ship_types st ON st.object_id = s.object_id
                                           WHERE st.cargo > {$need_free['omass']} AND st.dock = 1 AND s.user_id = {$user->uid} AND s.place_type=7 AND s.place_id={$place['place_id']} AND
                                                 s.arg1={$place['arg1']} AND s.arg2={$place['arg2']}
                                        ORDER BY s.name" );

                  $fleets = array();
                  foreach( $mks as $ship ) {
                    if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                      if( get_cargo( $ship['id'], true ) >= $need_free['omass'] && $ship['id'] != $shid ) {
                        $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );
    
                        $out .= "&id$cnt=31:{$ship['id']}&name$cnt=Пристыковаться к ".$ship['name'];
                        $cnt++;
                      }
                    }
                  }
                }
              }
              break;
  
            case 8: // in galaxy point
              if( $limit >= 0 ) {
                if( $place['hyper'] > 0 && $place['event_type'] == 0 ) {
                  $out .= "&id$cnt=9&name$cnt=Переместиться в галактике";
                  $cnt++;
                  $out .= "&id$cnt=41&name$cnt=Отправить к родной звезде";
                  $cnt++;
                }
              }

              if( $type == 'F' ) {
                $can_dock = db_fetch_row( "SELECT MAX( st.dock ) dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.fleet_id = $shid" );
              } else {
                $can_dock = db_fetch_row( "SELECT st.dock dock
                                             FROM ships s
                                       INNER JOIN ship_types st ON st.object_id = s.object_id
                                            WHERE s.id = $shid" );
              }

              if( $limit >= 0 ) {
                if( $user->qt != 33 && $user->qt != 34 ) {
                  if( $can_dock['dock'] > 0 ) {
                    $out .= "&id$cnt=39&name$cnt=Отстыковать все";
                    $cnt++;
                  }

                  if( $unpack > 0 ) {
                    $out .= "&id$cnt=30&name$cnt=Расконсервировать все";
                    $cnt++;
                  }
                }

                if( $place['w_power'] > 0 ) {
                  if( $place['guard'] == 0 ) {
                    $out .= "&id$cnt=20:1&name$cnt=Атаковать всех";
                    $cnt++;
                    $out .= "&id$cnt=20:2&name$cnt=Атаковать врагов";
                    $cnt++;
                    $out .= "&id$cnt=20:3&name$cnt=Атаковать не друзей";
                    $cnt++;
                    if( $user->aliance ) {
                      $out .= "&id$cnt=20:4&name$cnt=Атаковать не альянс";
                      $cnt++;
                    }
                  } else {
                    $out .= "&id$cnt=21&name$cnt=Отменить охрану ({$guard_txt[$place['guard']]})";
                    $cnt++;
                  }
                }

                if( $place['harvest'] > 0 ) {
                  if( $place['event_type'] == 0 ) {
                    $trash = db_fetch_val( "SELECT SUM( object_cnt ) cnt
                                              FROM trash
                                             WHERE place_type = {$place['place_type']} AND place_id = {$place['place_id']} AND
                                                   arg1 = {$place['arg1']} AND arg2 = {$place['arg2']}", 'cnt' );

                    if( $trash > 0 ) {
                      $out .= "&id$cnt=44&name$cnt=Собрать $trash обломков";
                      $cnt++;
                    }
                  } else {
                    $out .= "&id$cnt=44&name$cnt=Отменить сбор обломков";
                    $cnt++;
                  }
                }

                if( $place['hot'] > 0 ) {
                  if( $limit >= 0 ) {
                    if( $place['event_type'] == 0 ) {
                      $hot = 1 + get_book_level( 37, $user->uid );
  
                      $list = db_fetch_array( "SELECT id, len, round( ( UNIX_TIMESTAMP( NOW() ) - UNIX_TIMESTAMP( event_time ) ) ) timer
                                                 FROM hot_way
                                                WHERE event_time > DATE_SUB( now() , INTERVAL $hot * 3 HOUR ) AND
                                                      id_from = 8 AND from_arg1 = {$place['arg1']} AND from_arg2 = {$place['arg2']}
                                             ORDER BY event_time DESC
                                                LIMIT 0, $hot" );

                      if( count( $list ) > 0 ) {
                        $l = 1;
                        foreach( $list as $id ) {
                          $out .= "&id$cnt=47:{$id['id']}&name$cnt=След $l дальность {$id['len']} давность ".time_to_str( $id['timer'] );

                          $l++;
                          $cnt++;
                        }
                      } else {
                        $out .= "&id$cnt=15&name$cnt=Следов не обнаружено";
                        $cnt++;
                      }
                    }
                  }
                }
              }

              if( $place['event_type'] == 0 ) {
                if( $type == 'F' ) {
                  $need_free = db_fetch_row( "SELECT SUM( o.mass ) cmass, SUM( o2.mass ) omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.fleet_id = $shid" );
                } else {
                  $need_free = db_fetch_row( "SELECT o.mass cmass, o2.mass omass
                                                FROM ships s
                                          INNER JOIN ship_types st ON st.object_id = s.object_id
                                          INNER JOIN objects o ON o.id = st.conserv_id
                                          INNER JOIN objects o2 ON o2.id = s.object_id
                                               WHERE s.id = $shid" );
                }

                if( isset( $need_free['cmass'] ) && $need_free['cmass'] ) {
                  $ships = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                              FROM ships s
                                        INNER JOIN ship_types st ON st.object_id = s.object_id
                                             WHERE st.cargo > {$need_free['cmass']} AND s.object_id IN (9161, 9180, 9399) AND s.user_id = {$user->uid} AND
                                                   s.place_type=8 AND s.place_id={$place['place_id']} AND arg1={$place['arg1']} AND arg2={$place['arg2']} 
                                          ORDER BY s.name" );
                } else {
                  $ships = array();
                }

                $fleets = array();
                foreach( $ships as $ship ) {
                  if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                    if( get_cargo( $ship['id'], true ) >= $need_free['cmass'] && $ship['id'] != $shid ) {
                      $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );
  
                      $out .= "&id$cnt=28:{$ship['id']}&name$cnt=Законсервировать в ".$ship['name'];
                      $cnt++;
                    }
                  }
                }

                if( isset( $need_free['omass'] ) && $need_free['omass'] ) {
                  $mks = db_fetch_array( "SELECT s.id, s.name, s.fleet_id
                                            FROM ships s
                                      INNER JOIN ship_types st ON st.object_id = s.object_id
                                           WHERE st.cargo > {$need_free['omass']} AND st.dock = 1 AND s.user_id = {$user->uid} AND s.place_type = 8 AND s.place_id={$place['place_id']} AND
                                                 s.arg1={$place['arg1']} AND s.arg2={$place['arg2']}
                                        ORDER BY s.name" );
                } else {
                  $mks = array();
                }

                $fleets = array();
                foreach( $mks as $ship ) {
                  if( !isset( $fleets[$ship['fleet_id']] ) || $fleets[$ship['fleet_id']] < 5 ) {
                    if( get_cargo( $ship['id'], true ) >= $need_free['omass'] && $ship['id'] != $shid ) {
                      $fleets[$ship['fleet_id']] = ( isset( $fleets[$ship['fleet_id']] ) ? $fleets[$ship['fleet_id']] + 1 : $fleets[$ship['fleet_id']] = 0 );
  
                      $out .= "&id$cnt=31:{$ship['id']}&name$cnt=Пристыковаться к ".$ship['name'];
                      $cnt++;
                    }
                  }
                }
              }
              break;
          }
        } else {
          if( $limit >= 0 ) {
            if( $user->block == 0 ) {
              if( $type == 'S' ) {
                $hash = db_fetch_val( "SELECT we.place_hash FROM war_events we WHERE ( a_type = 0 AND a_object_id = $shid ) OR ( d_type = 0 AND d_object_id = $shid ) LIMIT 0,1", 'place_hash' );
              } else {
                $hash = db_fetch_val( "SELECT we.place_hash FROM war_events we WHERE ( a_type = 1 AND a_object_id = $shid ) OR ( d_type = 1 AND d_object_id = $shid ) LIMIT 0,1", 'place_hash' );
              }
  
              $out .= "&id$cnt=50:$hash&name$cnt=Посмотреть бой";
              $cnt++;
            } else {
              $out .= "&id$cnt=15&name$cnt=Коммандиры кораблей в отставке";
              $cnt++;
            }
          }
        }

        if( $type == 'F' ) {
          if( $place['place_type'] != 5 && $place['inwar'] == 0 && $place['event_type'] == 0 ) {
            $out .= "&id$cnt=7&name$cnt=Расформировать флот";
            $cnt++;
          }
          $out .= "&id$cnt=10&name$cnt=Содержимое грузовых отсеков";
          $cnt++;
        } else {
          $out .= "&id$cnt=10&name$cnt=Содержимое грузового отсека";
          $cnt++;
        }

        if( get_book_level( 28, $user->uid ) > 0 && $user->block == 0 ) {
          $out .= "&id$cnt=42&name$cnt=Главнокомандующий";
          $cnt++;
        }

        $out .= "&id$cnt=11&name$cnt=Переименовать";
        $cnt++;

        if( $place['abordage'] == 0 ) {
          $out .= "&id$cnt=32&name$cnt=Включить абордаж";
        } else {
          $out .= "&id$cnt=33&name$cnt=Отключить абордаж";
        }
        $cnt++;
        break;
    }

    $out .= "&cnt=$cnt";
    printOut( $out );
  } else {
    printOut( "err=1" );
  }
